<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Finance</title>

  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/sidebar.css" />
  <link rel="stylesheet" href="../css/accounts.css" />

  <style>
    .finance-container { width: 100%; }

    /* GLOBAL FILTERS BAR */
    .global-filters{
      background:#fff;
      padding: 1rem 1.25rem;
      border-radius: 8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-bottom: 1rem;
    }
    .global-filters__row{
      display:flex;
      gap: .9rem;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
    }
    .global-filters__left{
      display:flex;
      gap: .9rem;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group{ min-width: 240px; }
    .filter-group.small{ min-width: 180px; }

    .statistics{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1rem;
      margin-bottom: 1.25rem;
    }

    .wallet-section{
      background:#fff;
      padding: 1.25rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .transfer-btn{
      padding: .75rem 1.1rem;
      border:none;
      border-radius:6px;
      cursor:pointer;
      background:#3498db;
      color:#fff;
      font-size:.9rem;
      font-weight: 600;
    }
    .transfer-btn:hover{ background:#2980b9; }
    .transfer-btn.secondary{ background:#2ecc71; }
    .transfer-btn.secondary:hover{ background:#27ae60; }
    .transfer-btn.gray{ background:#95a5a6; }
    .transfer-btn.gray:hover{ background:#7f8c8d; }

    .fee-notice{
      background:#fff3cd;
      border:1px solid #ffc107;
      padding:.9rem 1rem;
      border-radius:6px;
      margin-top:.9rem;
      font-size:.9rem;
    }

    .topups-section{
      background:#fff;
      padding: 1.25rem;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-top: 1rem;
    }

    .topups-table-wrap{
  border:1px solid #eee;
  border-radius: 10px;
  overflow:hidden;
  background:#fff;
}

.topups-table{
  width:100%;
  border-collapse:collapse;
  font-size:.92rem;
}

.topups-table thead th{
  background:#fafafa;
  color:#6c7a89;
  font-size:.78rem;
  letter-spacing:.06em;
  text-transform:uppercase;
  padding:.85rem .9rem;
  text-align:left;
  border-bottom:1px solid #eee;
}

.topups-table td{
  padding: 1rem .9rem;
  border-bottom:1px solid #f0f0f0;
  vertical-align: middle;
}

.topups-table tr.row-clickable{
  cursor:pointer;
}
.topups-table tr.row-clickable:hover{
  background: rgba(52,152,219,.06);
}

.topups-proof{
  color:#6c7a89;
  font-weight: 700;
}


    .topups-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .75rem;
    }
    .topups-header h2{
      margin:0;
      font-size: 1.35rem;
    }

    .topup-item{
      padding: .9rem 0;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      gap: 1rem;
    }

    .modal-simple{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      padding: 16px;
    }
    .modal-simple.active{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .modal-simple-content{
      background:#fff;
      padding:1.25rem;
      border-radius:10px;
      max-width:860px;
      width:100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    .form-group{ margin-bottom:.9rem; }
    .form-group label{
      display:block;
      margin-bottom:.45rem;
      font-weight:800;
      color:#2c3e50;
      font-size:.9rem;
    }
    .form-group input, .form-group select, .form-group textarea{
      width:100%;
      padding:.6rem .7rem;
      border:1px solid #ddd;
      border-radius:6px;
      font-size: .95rem;
      outline: none;
      background:#fff;
    }
    .form-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: .9rem;
    }
    @media (max-width: 780px){
      .form-row{ grid-template-columns: 1fr; }
    }

    .widgets-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 1100px){
      .widgets-grid{ grid-template-columns: 1fr; }
    }

    .widget-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 0 0 .8rem 0;
    }
    .widget-title h2{ margin:0; font-size: 1.2rem; }

    /* pill tabs */
    .pillbar{ display:flex; gap:.5rem; flex-wrap: wrap; }
    .pill{
      border:1px solid #e6e6e6;
      background:#fafafa;
      padding:.45rem .7rem;
      border-radius: 999px;
      font-size: .85rem;
      cursor:pointer;
      user-select:none;
      font-weight: 700;
      color:#2c3e50;
    }
    .pill.active{
      border-color:#3498db;
      background: rgba(52,152,219,.10);
      color:#1f6fa8;
    }

    .mini-hint{
      font-size:.88rem;
      color:#6c7a89;
      margin-top: .15rem;
      line-height: 1.35;
    }

    .ledger-table{
      width:100%;
      border-collapse:collapse;
      margin-top: .5rem;
      font-size:.92rem;
    }
    .ledger-table th, .ledger-table td{
      padding:.75rem .6rem;
      border-bottom:1px solid #eee;
      text-align:left;
      vertical-align: top;
    }
    .ledger-table th{
      font-size:.8rem;
      letter-spacing:.02em;
      text-transform: uppercase;
      color:#6c7a89;
      background:#fafafa;
    }

    .amount-pos{ font-weight: 900; color:#1f8a4c; }
    .amount-neg{ font-weight: 900; color:#c0392b; }

    .tag{
      display:inline-block;
      padding:.18rem .5rem;
      border-radius: 999px;
      font-size:.78rem;
      border:1px solid #e6e6e6;
      background:#fafafa;
      font-weight: 800;
      color:#2c3e50;
      margin-right: .35rem;
    }
    .tag.pending{
      background: rgba(255,193,7,.18);
      border-color: rgba(255,193,7,.45);
      color:#8a6d00;
    }
    .tag.approved{
      background: rgba(46,204,113,.12);
      border-color: rgba(46,204,113,.35);
      color:#1f8a4c;
    }
    .tag.rejected{
      background: rgba(231,76,60,.10);
      border-color: rgba(231,76,60,.30);
      color:#c0392b;
    }

    .split{
      display:flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: .75rem;
    }

    .quick-actions{ display:flex; gap: .6rem; flex-wrap: wrap; }
    .muted{ color:#6c7a89; font-size: .9rem; }

    .stat-box select.kpi-select{
      width: 100%;
      padding: 0.35rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      background: #fff;
    }

    /* RIGHT DRAWER */
    .drawer{ position: fixed; inset: 0; z-index: 2000; display: none; }
    .drawer.active{ display:block; }
    .drawer__overlay{ position:absolute; inset:0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    .drawer__panel{
      position:absolute; top:0; right:0;
      height: 100%;
      width: min(420px, 92vw);
      background:#fff;
      box-shadow: -10px 0 30px rgba(0,0,0,.15);
      display:flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform .22s ease;
    }
    .drawer.active .drawer__panel{ transform: translateX(0); }
    .drawer__header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 1rem 1rem .75rem 1rem;
      border-bottom:1px solid #eee;
    }
    .drawer__title{ font-size: 1.35rem; font-weight: 900; margin: 0; color:#2c3e50; }
    .drawer__close{
      width: 34px; height: 34px;
      border:none; background:#f2f2f2;
      border-radius: 10px; cursor:pointer;
      font-size: 18px; line-height: 34px;
    }
    .drawer__body{ padding: 1rem; overflow:auto; }
    .segmented{ display:flex; gap:.5rem; flex-wrap: wrap; margin: .75rem 0 1rem 0; }
    .seg-btn{
      border:1px solid #ddd; background:#f8f8f8;
      padding:.55rem .85rem; border-radius: 8px;
      cursor:pointer; font-weight: 800; font-size: .9rem; color:#2c3e50;
    }
    .seg-btn.active{ background:#3b5bdb; border-color:#2f4fcb; color:#fff; }
    .notice-box{
      margin-top: .75rem;
      background:#ffe3e3;
      border:1px solid #ffa8a8;
      color:#7b1e1e;
      padding:.75rem;
      border-radius: 10px;
      font-size: .85rem;
      line-height: 1.35;
    }
    .drawer__footer{
      padding: 1rem; border-top:1px solid #eee;
      display:flex; gap:.75rem; justify-content:flex-start; background:#fff;
    }
    .btn-disabled{ opacity: .55; pointer-events: none; }

    /* workspace section divider */
    .hr { border:none; border-top:1px solid #eee; margin: 1rem 0; }

    /* small card inside workspace tabs */
    .subtab-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }

    /* ===== Topup Details (CLIENT) - RIGHT DRAWER (read-only) ===== */
    .tx-modal{
      position:fixed;
      inset:0;
      z-index:3000;
      display:none;
    }
    .tx-modal.active{ display:block; }

    .tx-modal__overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(2px);
      opacity:0;
      transition: opacity .25s ease;
    }
    .tx-modal.active .tx-modal__overlay{ opacity:1; }

    .tx-modal__panel{
      position:absolute;
      top:0; right:0;
      height:100%;
      width:min(480px, 95vw);
      background:#fff;
      box-shadow:-10px 0 30px rgba(0,0,0,.18);
      transform:translateX(100%);
      transition: transform .25s ease;
      display:flex;
      flex-direction:column;
    }
    .tx-modal.active .tx-modal__panel{ transform:translateX(0); }

    .tx-modal__header{
      padding:1rem;
      border-bottom:1px solid #eee;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .tx-modal__title{
      margin:0;
      font-size:1.2rem;
      font-weight:900;
      color:#2c3e50;
    }
    .tx-modal__close{
      width:34px; height:34px;
      border:none; background:#f2f2f2;
      border-radius:10px; cursor:pointer;
      font-size:18px; line-height:34px;
    }

    .tx-modal__body{
      padding:1rem;
      overflow:auto;
      flex:1;
    }

    .details-card{
      border:1px solid #eee;
      border-radius:12px;
      padding:.75rem;
      background:#fafafa;
    }
    .details-row{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      padding:.55rem .35rem;
      border-bottom:1px solid #eaeaea;
    }
    .details-row:last-child{ border-bottom:none; }
    .details-row strong{ color:#2c3e50; }
    .details-row span{ color:#6c7a89; text-align:right; }

    .readonly-box{
      margin-top:.75rem;
      background:#fff;
      border:1px solid #eee;
      border-radius:10px;
      padding:.75rem;
    }

    .readonly-field{
      margin-top:.65rem;
    }
    .readonly-field label{
      display:block;
      margin-bottom:.35rem;
      font-weight:800;
      color:#2c3e50;
      font-size:.9rem;
    }
    .readonly-value{
      width:100%;
      padding:.6rem .7rem;
      border:1px solid #e6e6e6;
      border-radius:8px;
      background:#f8f9fa;
      color:#2c3e50;
      font-size:.95rem;
      word-break: break-word;
    }

    /* nice hover for clickable topups */
    .topup-item[role="button"]:hover{
      background: rgba(52,152,219,.06);
    }
  </style>
</head>

<body>
  <div class="layout">
    <header class="header">
      <h1>Finance</h1>
      <div class="header-right">
        <div class="theme-toggle">
          <button class="theme-btn active">Light</button>
          <button class="theme-btn">Dark</button>
        </div>
        <div class="user-info">
          <span id="clientHeaderName">Client</span>
          <div class="user-avatar" id="clientAvatar">CL</div>
        </div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="finance-container">

        <!-- GLOBAL FILTERS (CLIENT VIEW: only date range) -->
        <div class="global-filters">
          <div class="global-filters__row">
            <div class="global-filters__left">
              <div class="form-group filter-group small">
                <label>Date from</label>
                <input type="date" id="global_from" onchange="onGlobalFiltersChanged()">
              </div>

              <div class="form-group filter-group small">
                <label>Date to</label>
                <input type="date" id="global_to" onchange="onGlobalFiltersChanged()">
              </div>
            </div>

            <div class="quick-actions">
              <button class="transfer-btn gray" onclick="clearGlobalFilters()">Clear</button>
            </div>
          </div>

          <div class="mini-hint" id="global_hint"></div>
        </div>

        <!-- KPI Statistics -->
        <div class="statistics">
          <div class="stat-box">
            <h4>TOTAL TOPUPS</h4>
            <div class="stat-value" id="kpi_totalTopups">$0.00</div>
            <div class="stat-description" id="kpi_totalTopups_desc">Approved topups</div>
          </div>

          <div class="stat-box">
            <h4>MAIN WALLET</h4>
            <div class="stat-value" id="kpi_mainWallet">$0.00</div>
            <div class="stat-description">Available balance</div>
          </div>

          <div class="stat-box">
            <h4>PLATFORMS VAULT</h4>
            <div class="stat-value" id="kpi_platformVault">$0.00</div>
            <div class="stat-description">
              <select id="kpi_platformFilter" class="kpi-select">
                <option value="__all__">Total (All Platforms)</option>
                <option value="facebook">Facebook</option>
                <option value="google">Google</option>
                <option value="tiktok">TikTok</option>
              </select>
              <div class="mini-hint">Filtered by date range</div>
            </div>
          </div>

          <div class="stat-box">
            <h4>GENERAL BALANCE</h4>
            <div class="stat-value" id="kpi_generalBalance">$0.00</div>
            <div class="stat-description">Shared accounts</div>
          </div>

          <div class="stat-box">
            <h4>INDIVIDUAL BALANCE</h4>
            <div class="stat-value" id="kpi_individualBalance">$0.00</div>
            <div class="stat-description">Your individual budget</div>
          </div>

          <div class="stat-box">
            <h4>SPEND</h4>
            <div class="stat-value" id="kpi_spend">$0.00</div>
            <div class="stat-description">Total spend</div>
          </div>

          <div class="stat-box">
            <h4>TOTAL FEES</h4>
            <div class="stat-value" id="kpi_totalFees">$0.00</div>
            <div class="stat-description">Fees collected</div>
          </div>

          <div class="stat-box">
            <h4>SETUP ACCOUNT + SERVICES</h4>
            <div class="stat-value" id="kpi_setupServices">$0.00</div>
            <div class="stat-description">Setup costs</div>
          </div>
        </div>

        <!-- Workspace + Ledger -->
        <div class="widgets-grid">
          <!-- FINANCE WORKSPACE -->
          <div class="wallet-section">
            <div class="widget-title">
              <div>
                <h2>Finance Workspace</h2>
                <div class="mini-hint">
                  Vizualizezi doar datele tale. Topup-urile adăugate sunt <strong>request</strong> și apar după aprobarea adminului.
                </div>
              </div>

              <!-- MAIN WORKSPACE TABS (client: hidden in demo; keep structure) -->
              <div class="pillbar" id="workspaceTabs">
                <div class="pill active" data-tab="funding" style="display:none;">Funding</div>
                <div class="pill" data-tab="setup" style="display:none;">Setup & Services</div>
              </div>
            </div>

            <!-- TAB: Funding -->
            <div id="tab_funding">
              <!-- SUBTABS IN FUNDING -->
              <div class="subtab-header">
                <div class="mini-hint">Fluxuri interne (demo): Main → Vault, Vault → General/Individual, Individual → Account.</div>
                <div class="pillbar" id="fundingSubTabs">
                  <div class="pill active" data-subtab="main_to_vault">Main → Vault</div>
                  <div class="pill" data-subtab="vault_allocate">Vault → (General/Individual)</div>
                  <div class="pill" data-subtab="individual_to_account">Individual → Account</div>
                </div>
              </div>

              <!-- SUBTAB: Main -> Vault -->
              <div id="subtab_main_to_vault">
                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Main Wallet</option>
                    </select>
                    <div class="mini-hint" id="tx_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To</label>
                    <select disabled>
                      <option>Platform Vault</option>
                    </select>
                    <div class="mini-hint">Din Main Wallet poți trimite doar către Platform Vault.</div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform</label>
                    <select id="tx_platform" onchange="updateFundingPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="tx_amount" min="0" step="0.01" placeholder="e.g. 250" oninput="updateFundingPreview()">
                  </div>
                </div>

                <div class="form-group">
                  <label>Note (optional)</label>
                  <input type="text" id="tx_note" placeholder="e.g. Funding for campaigns Feb" oninput="updateFundingPreview()">
                </div>

                <div class="fee-notice">
                  <strong>Spend logic:</strong> Orice transfer Main → Platform Vault crește automat <strong>Spend</strong>.
                </div>

                <div class="split">
                  <div class="muted" id="tx_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitMainToVault()">Confirm Transfer</button>
                    <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Vault -> Allocate -->
              <div id="subtab_vault_allocate" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Allocate from Platform Vault</strong> către General / Individual:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform Vault</label>
                    <select id="alloc_platform" onchange="updateAllocationPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                    <div class="mini-hint" id="alloc_platformHint"></div>
                  </div>

                  <div class="form-group">
                    <label>Allocate To</label>
                    <select id="alloc_to" onchange="updateAllocationPreview();">
                      <option value="generalBalance">General Balance</option>
                      <option value="individualBalance">Individual Balance</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="alloc_amount" min="0" step="0.01" placeholder="e.g. 120" oninput="updateAllocationPreview()">
                  </div>

                  <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="alloc_note" placeholder="e.g. allocate to Individual" oninput="updateAllocationPreview()">
                  </div>
                </div>

                <div class="split">
                  <div class="muted" id="alloc_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitAllocation()">Confirm Allocation</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Individual -> Account -->
              <div id="subtab_individual_to_account" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Send from Individual Balance</strong> către un cont anume:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Individual Balance</option>
                    </select>
                    <div class="mini-hint" id="ind_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To (Account)</label>
                    <select id="ind_toAccount" onchange="updateIndToAccountPreview()">
                      <option value="acc_1">acc_1</option>
                      <option value="acc_2">acc_2</option>
                      <option value="acc_3">acc_3</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="ind_amount" min="0" step="0.01" placeholder="e.g. 100" oninput="updateIndToAccountPreview()">
                  </div>

                  <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="ind_note" placeholder="e.g. assign to acc_2 budget" oninput="updateIndToAccountPreview()">
                  </div>
                </div>

                <div class="split">
                  <div class="muted" id="ind_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitIndividualToAccount()">Confirm Send</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- TAB: Setup (hidden in client demo) -->
            <div id="tab_setup" style="display:none;"></div>
          </div>

          <!-- LEDGER -->
          <div class="wallet-section">
            <div class="widget-title">
              <div>
                <h2>Ledger</h2>
                <div class="mini-hint">Preview filtrat de date + tab selection.</div>
              </div>

              <div class="pillbar" id="ledgerTabs">
                <div class="pill active" data-ledger="all">All</div>
                <div class="pill" data-ledger="topups">Topups</div>
                <div class="pill" data-ledger="fees">Fees</div>
                <div class="pill" data-ledger="internal">Internal</div>
              </div>
            </div>

            <table class="ledger-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Details</th>
                  <th style="text-align:right;">Amount</th>
                </tr>
              </thead>
              <tbody id="ledgerPreviewBody"></tbody>
            </table>

            <div class="split">
              <div class="muted" id="ledgerHint"></div>
              <div class="quick-actions">
                <button class="transfer-btn" onclick="openLedgerModal()">View All</button>
                <button class="transfer-btn gray" onclick="exportLedgerJson()">Export JSON</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Topups (client only) -->
        <div class="topups-section">
          <div class="topups-header">
            <div>
              <h2>Total Topups</h2>
              <div class="mini-hint">Afișează doar topup-urile tale (approved/pending) în funcție de date.</div>
            </div>
            <div class="quick-actions">
              <button class="transfer-btn secondary" onclick="openTopupDrawer()">+ Add Topup</button>
            </div>
          </div>

          <div class="topups-table-wrap">
  <table class="topups-table">
    <thead>
      <tr>
        <th>DATE</th>
        <th>CLIENT</th>
        <th>ACCOUNT</th>
        <th>PROOF</th>
        <th style="text-align:right;">AMOUNT</th>
        <th>STATUS</th>
        <th>DESCRIPTION</th>
      </tr>
    </thead>
    <tbody id="topupsList"></tbody>
  </table>

  <div class="mini-hint" id="topupsFooterHint" style="margin-top:.75rem;"></div>
</div>

        </div>

      </div>
    </main>
  </div>

  <!-- RIGHT DRAWER: Topup Details (CLIENT - read-only) -->
  <div class="tx-modal" id="topupDetailsModal" aria-hidden="true">
    <div class="tx-modal__overlay" onclick="closeTopupDetails()"></div>

    <div class="tx-modal__panel" role="dialog" aria-modal="true" aria-label="Top-Up Details">
      <div class="tx-modal__header">
        <h3 class="tx-modal__title">Top-Up Details</h3>
        <button class="tx-modal__close" onclick="closeTopupDetails()" aria-label="Close">×</button>
      </div>

      <div class="tx-modal__body">
        <div class="details-card" id="td_card">
          <div class="details-row"><strong>Client ID:</strong> <span id="td_clientId">—</span></div>
          <div class="details-row"><strong>Top-Up ID:</strong> <span id="td_topupId">—</span></div>
          <div class="details-row"><strong>Type:</strong> <span id="td_type">—</span></div>
          <div class="details-row"><strong>Account:</strong> <span id="td_account">—</span></div>
          <div class="details-row"><strong>Gross Amount:</strong> <span id="td_gross">—</span></div>
          <div class="details-row"><strong>Fee Amount:</strong> <span id="td_fee">—</span></div>
          <div class="details-row"><strong>Net Amount:</strong> <span id="td_net">—</span></div>
          <div class="details-row"><strong>Status:</strong> <span id="td_status">—</span></div>
        </div>

        <div class="readonly-box">
          <div class="readonly-field">
            <label>Description</label>
            <div class="readonly-value" id="td_desc">—</div>
          </div>

          <div class="readonly-field">
            <label>Date</label>
            <div class="readonly-value" id="td_date">—</div>
          </div>

          <div class="mini-hint" style="margin-top:.75rem;">
            Read-only view. Pentru modificări/confirmări, admin-ul gestionează statusul.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ledger Modal -->
  <div class="modal-simple" id="ledgerModal">
    <div class="modal-simple-content">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
          <h2 style="margin:0;">Ledger (Filtered)</h2>
          <div class="mini-hint">Filtru: date range + tab selection (All/Topups/Fees/Internal).</div>
        </div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="closeLedgerModal()">Close</button>
        </div>
      </div>

      <div style="max-height: 62vh; overflow:auto; border:1px solid #eee; border-radius: 10px; padding: .25rem .25rem 0 .25rem; margin-top:.75rem;">
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>From → To</th>
              <th>Status</th>
              <th>Platform</th>
              <th>Category</th>
              <th>Note</th>
              <th style="text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="ledgerAllBody"></tbody>
        </table>
      </div>

      <div class="split">
        <div class="muted" id="ledgerTotalsHint"></div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT DRAWER: Add Topup (CLIENT VIEW: no Client dropdown; submit = REQUEST) -->
  <div class="drawer" id="topupDrawer" aria-hidden="true">
    <div class="drawer__overlay" onclick="closeTopupDrawer()"></div>

    <div class="drawer__panel" role="dialog" aria-modal="true" aria-label="Add Top-Up">
      <div class="drawer__header">
        <h3 class="drawer__title">Add Top-Up Request</h3>
        <button class="drawer__close" onclick="closeTopupDrawer()" aria-label="Close">×</button>
      </div>

      <div class="drawer__body">
        <div class="mini-hint">
          This will create a <strong>request</strong>. Admin must approve it before funds appear in Main Wallet.
        </div>

        <div class="segmented" id="topupTabs">
          <button class="seg-btn active" data-tab="wire" onclick="switchTopupTab('wire')">Wire</button>
          <button class="seg-btn" data-tab="crypto" onclick="switchTopupTab('crypto')">Crypto</button>
          <button class="seg-btn" data-tab="refund" onclick="switchTopupTab('refund')">Refund</button>
        </div>

        <!-- WIRE -->
        <div id="tab_wire">
          <div class="form-group">
            <label>Company</label>
            <input id="wire_company" type="text" placeholder="e.g. Wise / Revolut / Bank" />
          </div>

          <div class="form-group">
            <label>Account</label>
            <select id="wire_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="wire_gross" type="number" min="0" step="0.01" placeholder="e.g. 1000" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Fee</label>
            <input id="wire_fee" type="number" min="0" step="0.01" placeholder="e.g. 10" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="wire_net" type="number" min="0" step="0.01" placeholder="auto" readonly />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="wire_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="wire_invoice" type="file" accept="application/pdf" />
          </div>

          <div class="notice-box">
            Minimum deposit: $500<br />
            Make sure the full amount arrives without fee deductions.
          </div>
        </div>

        <!-- CRYPTO -->
        <div id="tab_crypto" style="display:none;">
          <div class="form-group">
            <label>Method</label>
            <select id="crypto_method">
              <option value="">Select</option>
              <option value="USDT">USDT</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="crypto_net" type="number" min="0" step="0.01" placeholder="e.g. 500" />
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="crypto_gross" type="number" min="0" step="0.01" placeholder="optional" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="crypto_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="mini-hint" id="crypto_fee_hint">Fee: 0.00</div>

          <div class="form-group">
            <label>Wallet</label>
            <select id="crypto_network">
              <option value="">select network</option>
              <option value="ERC20">ERC20</option>
              <option value="TRC20">TRC20</option>
              <option value="BEP20">BEP20</option>
            </select>
          </div>

          <div class="form-group">
            <label>Hash</label>
            <input id="crypto_hash" type="text" placeholder="Transaction hash" />
          </div>
        </div>

        <!-- SPECIAL (kept but not exposed in tabs) -->
        <div id="tab_special" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="special_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="special_net" type="number" min="0" step="0.01" placeholder="e.g. 750" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="special_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="special_invoice" type="file" accept="application/pdf" />
          </div>
        </div>

        <!-- REFUND -->
        <div id="tab_refund" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="refund_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount (refund)</label>
            <input id="refund_net" type="number" min="0" step="0.01" placeholder="e.g. 120" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="refund_desc" type="text" placeholder="Refund reason / note" />
          </div>

          <div class="notice-box" style="background:#e7f5ff;border-color:#74c0fc;color:#0b4a6f;">
            Refund scade din Main Wallet (date range filter).
          </div>
        </div>
      </div>

      <div class="drawer__footer">
        <button class="transfer-btn secondary" id="topupSubmitBtn" onclick="submitTopupRequest()">Request</button>
        <button class="transfer-btn gray" onclick="closeTopupDrawer()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="../js/sidebar.js"></script>
  <script>
    /***********************
     * CLIENT CONFIG
     ***********************/
    const CURRENT_CLIENT_ID = localStorage.getItem("currentClientId") || "100"; // demo
    const LS_KEY = "client_finance_demo_v1_" + CURRENT_CLIENT_ID;

    const state = {
      ledger: [],
      platformFilter: "__all__",
      globalFrom: "",
      globalTo: "",
      ledgerTab: "all" // all | topups | fees | internal
    };

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }
    function nowISO(){ return new Date().toLocaleString(); }
    function uid(){ return Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getClientLabelById(id){
      const map = { "100":"100 - Alex", "101":"101 - Maria", "102":"102 - John" };
      return map[String(id)] || String(id);
    }

    function setClientHeader(){
      const label = getClientLabelById(CURRENT_CLIENT_ID);
      document.getElementById("clientHeaderName").textContent = label;
      const initials = label.split("-")[1]?.trim()?.split(" ").map(x=>x[0]).slice(0,2).join("").toUpperCase() || "CL";
      document.getElementById("clientAvatar").textContent = initials;
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ seedDemo(); return; }
      try{
        const parsed = JSON.parse(raw);
        state.ledger = Array.isArray(parsed.ledger) ? parsed.ledger : [];
        state.platformFilter = parsed.platformFilter || "__all__";
        state.globalFrom = parsed.globalFrom || "";
        state.globalTo = parsed.globalTo || "";
        state.ledgerTab = parsed.ledgerTab || "all";
      }catch(e){ seedDemo(); }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        ledger: state.ledger,
        platformFilter: state.platformFilter,
        globalFrom: state.globalFrom,
        globalTo: state.globalTo,
        ledgerTab: state.ledgerTab
      }));
    }

    function seedDemo(){
      // demo includes ONLY this client's data (client view)
      state.ledger = [
        // Approved topups (informative)
        { id: uid(), date: "1/15/2024, 10:00:00 AM", type:"topup", status:"approved", clientId: CURRENT_CLIENT_ID, from:"external", to:"topups", platform:"", category:"wire", note:"Topup #1 (Wire)", amount: 1000 },
        { id: uid(), date: "1/20/2024, 10:00:00 AM", type:"topup", status:"approved", clientId: CURRENT_CLIENT_ID, from:"external", to:"topups", platform:"", category:"wire", note:"Topup #2 (Wire)", amount: 2000 },

        // Deposit into Main Wallet after approval
        { id: uid(), date: "1/26/2024, 09:00:00 AM", type:"deposit", status:"approved", clientId: CURRENT_CLIENT_ID, from:"external", to:"mainWallet", platform:"", category:"deposit", note:"Initial funding into Main Wallet", amount: 5000 },
        { id: uid(), date: "1/26/2024, 09:01:00 AM", type:"fee", status:"approved", clientId: CURRENT_CLIENT_ID, from:"", to:"feesCollected", platform:"", category:"wire_fee", note:"Wire processing fee", amount: 200 },

        // Spend main -> vault
        { id: uid(), date: "2/01/2024, 09:16:05 AM", type:"transfer", status:"approved", clientId: CURRENT_CLIENT_ID, from:"mainWallet", to:"platformVault", platform:"facebook", category:"spend", note:"Funding Facebook vault", amount: 700 },
        { id: uid(), date: "2/02/2024, 10:10:00 AM", type:"transfer", status:"approved", clientId: CURRENT_CLIENT_ID, from:"mainWallet", to:"platformVault", platform:"google", category:"spend", note:"Funding Google vault", amount: 300 },

        // Allocate vault -> balances
        { id: uid(), date: "2/03/2024, 11:00:00 AM", type:"allocation", status:"approved", clientId: CURRENT_CLIENT_ID, from:"platformVault", to:"generalBalance", platform:"facebook", category:"budget_general", note:"Allocate to General", amount: 200 },
        { id: uid(), date: "2/03/2024, 11:05:00 AM", type:"allocation", status:"approved", clientId: CURRENT_CLIENT_ID, from:"platformVault", to:"individualBalance", platform:"google", category:"budget_individual", note:"Allocate to Individual", amount: 150 },

        // Individual -> account
        { id: uid(), date: "2/04/2024, 12:00:00 PM", type:"ind_to_account", status:"approved", clientId: CURRENT_CLIENT_ID, from:"individualBalance", to:"account:acc_2", platform:"", category:"ind_to_account", note:"Assign to acc_2", amount: 50 },

        // Setup/services (read-only in client UI but shown in KPIs / ledger)
        { id: uid(), date: "2/16/2026, 10:12:55 AM", type:"setup_service", status:"approved", clientId: CURRENT_CLIENT_ID, from:"mainWallet", to:"setupServices", platform:"", category:"service", note:"Account: acc_1 | Service | BOV {...}", amount: 50 },
        { id: uid(), date: "2/16/2026, 10:12:55 AM", type:"setup_service", status:"approved", clientId: CURRENT_CLIENT_ID, from:"mainWallet", to:"setupServices", platform:"", category:"setup", note:"Account: acc_1 | one-time - Setup account #1", amount: 80 },

        // Example pending request (client created)
        { id: uid(), date: "2/10/2026, 09:20:00 AM", type:"topup_request", status:"pending", clientId: CURRENT_CLIENT_ID, from:"external", to:"topups", platform:"", category:"crypto", note:"Request: Crypto USDT TRC20 | Hash: 0xabc...", amount: 600 }
      ];
      state.platformFilter = "__all__";
      state.globalFrom = "";
      state.globalTo = "";
      state.ledgerTab = "all";
      save();
      refreshAll();
    }

    function addLedger(entry){
      state.ledger.unshift(entry);
      save();
      refreshAll();
    }

    /* DATE filter helper */
    function txDateToISO(txDateString){
      const d = new Date(txDateString);
      if(isNaN(d.getTime())) return null;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function passesDateRange(tx){
      // Always restrict to this client
      if(String(tx.clientId || "") !== String(CURRENT_CLIENT_ID)) return false;

      const iso = txDateToISO(tx.date);
      if(iso){
        if(state.globalFrom && iso < state.globalFrom) return false;
        if(state.globalTo && iso > state.globalTo) return false;
      }
      return true;
    }

    function matchesLedgerTab(tx){
      const t = state.ledgerTab;
      if(t === "all") return true;

      if(t === "topups"){
        // includes requests too
        return tx.type === "topup" || tx.type === "deposit" || tx.type === "topup_request";
      }

      if(t === "fees"){
        return tx.type === "fee" || tx.to === "feesCollected";
      }

      // internal
      return ["transfer","allocation","ind_to_account","setup_service","refund"].includes(tx.type);
    }

    function getFilteredLedger(){
      return state.ledger.filter(tx => passesDateRange(tx) && matchesLedgerTab(tx));
    }

    function onGlobalFiltersChanged(){
      state.globalFrom = document.getElementById("global_from").value;
      state.globalTo = document.getElementById("global_to").value;
      save();
      refreshAll();
    }

    function clearGlobalFilters(){
      state.globalFrom = "";
      state.globalTo = "";
      document.getElementById("global_from").value = "";
      document.getElementById("global_to").value = "";
      save();
      refreshAll();
    }

    function updateGlobalHint(){
      const rangeText = (state.globalFrom || state.globalTo)
        ? `${state.globalFrom || "…"} → ${state.globalTo || "…"}`
        : "All dates";
      document.getElementById("global_hint").textContent =
        `Client: ${getClientLabelById(CURRENT_CLIENT_ID)} • ${rangeText} • Ledger Tab: ${state.ledgerTab.toUpperCase()}`;
      document.getElementById("global_from").value = state.globalFrom || "";
      document.getElementById("global_to").value = state.globalTo || "";
    }

    /* KPIs - based on date range only; requests DO NOT affect balances */
    function getLedgerForKPIs(){
      return state.ledger.filter(passesDateRange);
    }

    function calcKpis(){
      const ledger = getLedgerForKPIs();
      const out = {
        totalTopupsApproved: 0,
        topupsPendingCount: 0,
        topupsPendingSum: 0,

        mainWallet: 0,
        platformVault: { facebook:0, google:0, tiktok:0 },
        generalBalance: 0,
        individualBalance: 0,
        spend: 0,
        setupServices: 0,
        totalFees: 0
      };

      for(const tx of ledger){
        const amt = Number(tx.amount || 0);
        const status = (tx.status || "approved");

        // total topups: only approved
        if(tx.type === "topup"){
          if(status === "approved") out.totalTopupsApproved += amt;
        }

        // requests: track but don't add to balances
        if(tx.type === "topup_request"){
          if(status === "pending"){
            out.topupsPendingCount += 1;
            out.topupsPendingSum += amt;
          }
        }

        // balances: only approved items affect money movement
        if(status !== "approved") continue;

        if(tx.to === "mainWallet") out.mainWallet += amt;
        if(tx.from === "mainWallet") out.mainWallet -= amt;

        if(tx.type === "transfer" && tx.from === "mainWallet" && tx.to === "platformVault"){
          out.spend += amt;
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] += amt;
        }

        if(tx.type === "allocation" && tx.from === "platformVault"){
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] -= amt;
          if(tx.to === "generalBalance") out.generalBalance += amt;
          if(tx.to === "individualBalance") out.individualBalance += amt;
        }

        if(tx.type === "ind_to_account" && tx.from === "individualBalance"){
          out.individualBalance -= amt;
        }

        if(tx.type === "setup_service" && tx.to === "setupServices"){
          out.setupServices += amt;
        }

        if(tx.to === "feesCollected"){
          out.totalFees += amt;
        }
      }

      return out;
    }

    function refreshKPIs(){
      const k = calcKpis();

      document.getElementById("kpi_totalTopups").textContent = money(k.totalTopupsApproved);
      document.getElementById("kpi_totalTopups_desc").textContent =
        k.topupsPendingCount
          ? `Approved topups • Pending: ${k.topupsPendingCount} (${money(k.topupsPendingSum)})`
          : "Approved topups";

      document.getElementById("kpi_mainWallet").textContent = money(k.mainWallet);

      const pf = state.platformFilter;
      const vaultTotal = pf === "__all__"
        ? (k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok)
        : (k.platformVault[pf] || 0);

      document.getElementById("kpi_platformVault").textContent = money(vaultTotal);
      document.getElementById("kpi_generalBalance").textContent = money(k.generalBalance);
      document.getElementById("kpi_individualBalance").textContent = money(k.individualBalance);
      document.getElementById("kpi_spend").textContent = money(k.spend);
      document.getElementById("kpi_totalFees").textContent = money(k.totalFees);
      document.getElementById("kpi_setupServices").textContent = money(k.setupServices);

      document.getElementById("kpi_platformFilter").value = state.platformFilter;
    }

    document.getElementById("kpi_platformFilter").addEventListener("change", (e) => {
      state.platformFilter = e.target.value;
      save();
      refreshKPIs();
    });

    /* TOPUPS LIST (client only) */
    function statusTag(status){
      const s = (status || "approved").toLowerCase();
      if(s === "pending") return `<span class="tag pending">PENDING</span>`;
      if(s === "rejected") return `<span class="tag rejected">REJECTED</span>`;
      return `<span class="tag approved">APPROVED</span>`;
    }

function renderTopupsList(){
  const items = getLedgerForKPIs()
    .filter(tx => tx.type === "topup" || tx.type === "topup_request")
    .slice()
    .reverse();

  const body = document.getElementById("topupsList");
  const footer = document.getElementById("topupsFooterHint");

  if(!items.length){
    body.innerHTML = `
      <tr><td colspan="7" class="muted" style="padding:1rem;">
        No topups found for selected date range.
      </td></tr>`;
    if(footer) footer.textContent = "";
    return;
  }

  // helper: proof + account + description
  function extractProof(tx){
    // hash: "Hash: 0xabc..." OR invoice: "Invoice: INV_00148.pdf"
    const n = String(tx.note || "");
    const mh = n.match(/Hash:\s*([^\s|]+)/i);
    if(mh) return mh[1];
    const mi = n.match(/Invoice:\s*([^\s|]+)/i);
    if(mi) return mi[1];
    return "—";
  }

  function extractAccount(tx){
    // "Account: acc_1" or fallback
    const n = String(tx.note || "");
    const m = n.match(/Account:\s*([a-zA-Z0-9_:-]+)/i);
    return m ? m[1] : "—";
  }

  function extractDesc(tx){
    // show category as clean label (wire/crypto) OR note
    if(tx.type === "topup_request"){
      // example: "Request: Crypto USDT TRC20 | Hash: ..."
      return String(tx.note || "—").replace(/^Request:\s*/i, "");
    }
    return tx.note ? String(tx.note) : "—";
  }

  body.innerHTML = items.map((t) => {
    const proof = extractProof(t);
    const account = extractAccount(t);
    const desc = extractDesc(t);

    return `
      <tr class="row-clickable" role="button" tabindex="0"
          onclick="openTopupDetails('${String(t.id)}')"
          onkeydown="if(event.key==='Enter') openTopupDetails('${String(t.id)}')">
        <td style="white-space:nowrap;">${escapeHtml(t.date || "—")}</td>
        <td>${escapeHtml(String(t.clientId || CURRENT_CLIENT_ID))}</td>
        <td>${escapeHtml(account)}</td>
        <td class="topups-proof">${escapeHtml(proof)}</td>
        <td style="text-align:right; font-weight:900;">${money(t.amount)}</td>
        <td>${statusTag(t.status)}</td>
        <td>${escapeHtml(desc)}</td>
      </tr>
    `;
  }).join("");

  if(footer){
    footer.textContent = `Showing ${items.length} topups • Filtered by date range. Click a row for details.`;
  }
}


    /* LEDGER PREVIEW */
    function buildShortDetails(tx){
      if(tx.type === "topup") return `${escapeHtml(tx.note || "Topup")} <span class="muted">(informative)</span>`;
      if(tx.type === "topup_request") return `${escapeHtml(tx.note || "Topup request")} <span class="muted">(awaiting admin approval)</span>`;
      if(tx.type === "deposit") return `Deposit → <span class="muted">Main Wallet</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "fee") return `Fee → <span class="muted">Total Fees</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "refund") return `Refund → <span class="muted">External</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "transfer") return `Main → Vault(${escapeHtml(tx.platform || "")}) • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "allocation") return `Vault(${escapeHtml(tx.platform || "")}) → ${escapeHtml(tx.to)} • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "ind_to_account") return `Individual → <span class="muted">${escapeHtml(tx.to || "")}</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "setup_service") return `Main → Setup/Services • ${escapeHtml(tx.note || "")}`;
      return `${escapeHtml(tx.type)} • ${escapeHtml(tx.note || "")}`;
    }

    function typeTags(tx){
      const base = `<span class="tag">${escapeHtml(tx.type.toUpperCase())}</span>`;
      const st = tx.status ? statusTag(tx.status) : "";
      const pf = tx.platform ? `<span class="tag">${escapeHtml(tx.platform)}</span>` : "";
      return `${base} ${st} ${pf}`.trim();
    }

    function refreshLedgerPreview(){
      const body = document.getElementById("ledgerPreviewBody");
      const preview = getFilteredLedger().slice(0, 8);

      body.innerHTML = preview.map(tx => {
        const isOut = (tx.status === "approved") && (tx.from === "mainWallet" || tx.from === "individualBalance");
        const amountClass = isOut ? "amount-neg" : "amount-pos";

        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${typeTags(tx)}</td>
            <td>${buildShortDetails(tx)}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("ledgerHint").textContent =
        `Showing latest ${preview.length} entries • Filtered by date range • Tab: ${state.ledgerTab.toUpperCase()}`;
    }

    function refreshLedgerModal(){
      const body = document.getElementById("ledgerAllBody");
      const ledger = getFilteredLedger();
      const k = calcKpis();

      body.innerHTML = ledger.map(tx => {
        const isOut = (tx.status === "approved") && (tx.from === "mainWallet" || tx.from === "individualBalance");
        const amountClass = isOut ? "amount-neg" : "amount-pos";
        const st = (tx.status || "approved").toUpperCase();

        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${escapeHtml(tx.type)}</td>
            <td>${escapeHtml((tx.from||"—") + " → " + (tx.to||"—"))}</td>
            <td>${escapeHtml(st)}</td>
            <td>${escapeHtml(tx.platform || "—")}</td>
            <td>${escapeHtml(tx.category || "—")}</td>
            <td>${escapeHtml(tx.note || "")}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      const vaultTotal = k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok;
      document.getElementById("ledgerTotalsHint").textContent =
        `MainWallet: ${money(k.mainWallet)} • VaultTotal: ${money(vaultTotal)} • General: ${money(k.generalBalance)} • Individual: ${money(k.individualBalance)} • Spend: ${money(k.spend)} • Fees: ${money(k.totalFees)} • Setup/Services: ${money(k.setupServices)} • ApprovedTopups: ${money(k.totalTopupsApproved)}`;
    }

    function openLedgerModal(){ refreshLedgerModal(); document.getElementById("ledgerModal").classList.add("active"); }
    function closeLedgerModal(){ document.getElementById("ledgerModal").classList.remove("active"); }

    /* WORKSPACE tabs */
    document.getElementById("workspaceTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#workspaceTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const tab = pill.getAttribute("data-tab");
      document.getElementById("tab_funding").style.display = tab === "funding" ? "block" : "none";
      document.getElementById("tab_setup").style.display = tab === "setup" ? "block" : "none";
    });

    /* FUNDING SUBTABS */
    document.getElementById("fundingSubTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#fundingSubTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const subtab = pill.getAttribute("data-subtab");
      document.getElementById("subtab_main_to_vault").style.display = subtab === "main_to_vault" ? "block" : "none";
      document.getElementById("subtab_vault_allocate").style.display = subtab === "vault_allocate" ? "block" : "none";
      document.getElementById("subtab_individual_to_account").style.display = subtab === "individual_to_account" ? "block" : "none";
    });

    /* LEDGER TABS */
    function setLedgerTab(tab){
      state.ledgerTab = tab;
      save();
      document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
      document.querySelector(`#ledgerTabs .pill[data-ledger="${tab}"]`)?.classList.add("active");
      refreshAll();
    }
    document.getElementById("ledgerTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;
      setLedgerTab(pill.getAttribute("data-ledger"));
    });

    /* FUNDING / ALLOCATION / INDIVIDUAL SEND */
    function refreshFundingUI(){
      const k = calcKpis();
      document.getElementById("tx_fromHint").textContent =
        `Available in Main Wallet (filtered view): ${money(k.mainWallet)}`;

      updateFundingPreview();
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateFundingPreview(){
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();
      document.getElementById("tx_preview").textContent =
        `Send ${money(amount)} Main → Vault (${platform})${note ? " • " + note : ""}`;
    }

    function submitMainToVault(){
      const k = calcKpis();
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }
      if(amount > k.mainWallet){
        alert(`Not enough funds in Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "transfer",
        status: "approved",
        clientId: String(CURRENT_CLIENT_ID),
        from: "mainWallet",
        to: "platformVault",
        platform,
        category: "spend",
        note: note || `Funding ${platform} vault`,
        amount
      });

      document.getElementById("tx_amount").value = "";
      document.getElementById("tx_note").value = "";
      updateFundingPreview();
    }

    function updateAllocationPreview(){
      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      const available = k.platformVault[platform] || 0;
      document.getElementById("alloc_platformHint").textContent =
        `Available in ${platform} vault (filtered): ${money(available)}`;

      document.getElementById("alloc_preview").textContent =
        `Allocate ${money(amount)} Vault(${platform}) → ${to}${note ? " • " + note : ""}`;
    }

    function submitAllocation(){
      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }

      const available = k.platformVault[platform] || 0;
      if(amount > available){
        alert(`Not enough funds in ${platform} vault (filtered). Available: ${money(available)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "allocation",
        status: "approved",
        clientId: String(CURRENT_CLIENT_ID),
        from: "platformVault",
        to: to,
        platform,
        category: to === "generalBalance" ? "budget_general" : "budget_individual",
        note: note || (to === "generalBalance" ? "Allocate to General" : "Allocate to Individual"),
        amount
      });

      document.getElementById("alloc_amount").value = "";
      document.getElementById("alloc_note").value = "";
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateIndToAccountPreview(){
      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      document.getElementById("ind_fromHint").textContent =
        `Available in Individual Balance (filtered): ${money(k.individualBalance)}`;

      document.getElementById("ind_preview").textContent =
        `Send ${money(amount)} Individual → ${account}${note ? " • " + note : ""}`;
    }

    function submitIndividualToAccount(){
      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      if(!amount || amount <= 0){
        alert("Please enter a valid amount.");
        return;
      }

      if(amount > k.individualBalance){
        alert(`Not enough funds in Individual Balance (filtered). Available: ${money(k.individualBalance)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "ind_to_account",
        status: "approved",
        clientId: String(CURRENT_CLIENT_ID),
        from: "individualBalance",
        to: `account:${account}`,
        platform: "",
        category: "ind_to_account",
        note: note || `Assign to ${account}`,
        amount
      });

      document.getElementById("ind_amount").value = "";
      document.getElementById("ind_note").value = "";
      updateIndToAccountPreview();
    }

    /* Add Topup Drawer logic (CLIENT: REQUEST only) */
    let activeTopupTab = "wire";

    function openTopupDrawer(){
      document.getElementById("topupDrawer").classList.add("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "false");
      recalcWireNet();
      validateTopupForm();
    }
    function closeTopupDrawer(){
      document.getElementById("topupDrawer").classList.remove("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "true");
    }

    function switchTopupTab(tab){
      activeTopupTab = tab;

      document.querySelectorAll("#topupTabs .seg-btn").forEach(b => b.classList.remove("active"));
      document.querySelector(`#topupTabs .seg-btn[data-tab="${tab}"]`)?.classList.add("active");

      document.getElementById("tab_wire").style.display = tab === "wire" ? "block" : "none";
      document.getElementById("tab_crypto").style.display = tab === "crypto" ? "block" : "none";
      document.getElementById("tab_special").style.display = tab === "special" ? "block" : "none";
      document.getElementById("tab_refund").style.display = tab === "refund" ? "block" : "none";

      validateTopupForm();
    }

    function recalcWireNet(){
      const gross = Number(document.getElementById("wire_gross").value || 0);
      const fee = Number(document.getElementById("wire_fee").value || 0);
      const net = Math.max(0, +(gross - fee).toFixed(2));
      document.getElementById("wire_net").value = net ? net : "";
      validateTopupForm();
    }

    function validateTopupForm(){
      const btn = document.getElementById("topupSubmitBtn");
      let ok = true;

      if(activeTopupTab === "wire"){
        const account = document.getElementById("wire_account").value;
        const net = Number(document.getElementById("wire_net").value || 0);
        ok = !!account && net > 0;
      }
      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();
        ok = !!method && net > 0 && !!network && !!hash;
      }
      if(activeTopupTab === "special"){
        const net = Number(document.getElementById("special_net").value || 0);
        ok = net > 0;
      }
      if(activeTopupTab === "refund"){
        const net = Number(document.getElementById("refund_net").value || 0);
        ok = net > 0;
      }

      btn.classList.toggle("btn-disabled", !ok);
    }

    ["crypto_method","crypto_net","crypto_network","crypto_hash","special_net","refund_net","wire_account","wire_gross","wire_fee"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input", validateTopupForm);
        el.addEventListener("change", validateTopupForm);
      }
    });

    function submitTopupRequest(){
      validateTopupForm();
      const btn = document.getElementById("topupSubmitBtn");
      if(btn.classList.contains("btn-disabled")) return;

      // CLIENT REQUEST: create only topup_request (pending).
      // Admin approval (later) would create approved TOPUP + DEPOSIT + FEE.
      let amount = 0;
      let category = activeTopupTab;
      let note = "";

      if(activeTopupTab === "wire"){
        const company = (document.getElementById("wire_company").value || "").trim();
        const account = document.getElementById("wire_account").value;
        const gross = Number(document.getElementById("wire_gross").value || 0);
        const fee = Number(document.getElementById("wire_fee").value || 0);
        const net = Number(document.getElementById("wire_net").value || 0);
        const desc = (document.getElementById("wire_desc").value || "").trim();
        const invoice = document.getElementById("wire_invoice").files?.[0]?.name || "";
        amount = net;
        note = `Request: Wire${company ? " | " + company : ""} | Account: ${account}${desc ? " | " + desc : ""}${invoice ? " | Invoice: " + invoice : ""} | Gross: ${gross} | Fee: ${fee}`;
      }

      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const gross = Number(document.getElementById("crypto_gross").value || 0);
        const desc = (document.getElementById("crypto_desc").value || "").trim();
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();
        amount = net;
        const fee = gross > 0 ? Math.max(0, +(gross - net).toFixed(2)) : 0;
        document.getElementById("crypto_fee_hint").textContent = "Fee: " + fee.toFixed(2);
        note = `Request: Crypto ${method} | ${network} | Hash: ${hash}${desc ? " | " + desc : ""}${gross ? " | Gross: " + gross : ""}`;
      }

      if(activeTopupTab === "special"){
        const account = document.getElementById("special_account").value;
        const net = Number(document.getElementById("special_net").value || 0);
        const desc = (document.getElementById("special_desc").value || "").trim();
        const invoice = document.getElementById("special_invoice").files?.[0]?.name || "";
        amount = net;
        note = `Request: Special${account ? " | Account: " + account : ""}${desc ? " | " + desc : ""}${invoice ? " | Invoice: " + invoice : ""}`;
      }

      if(activeTopupTab === "refund"){
        const k = calcKpis();
        const net = Number(document.getElementById("refund_net").value || 0);
        const account = document.getElementById("refund_account").value;
        const desc = (document.getElementById("refund_desc").value || "").trim();
        if(net > k.mainWallet){
          alert(`Refund amount exceeds Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
          return;
        }
        addLedger({
          id: uid(),
          date: nowISO(),
          type: "refund",
          status: "approved",
          clientId: String(CURRENT_CLIENT_ID),
          from: "mainWallet",
          to: "external",
          platform: "",
          category: "refund",
          note: `Refund${account ? " | Account: " + account : ""}${desc ? " | " + desc : ""}`,
          amount: net
        });
        closeTopupDrawer();
        return;
      }

      if(!amount || amount <= 0){
        alert("Please enter a valid amount.");
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "topup_request",
        status: "pending",
        clientId: String(CURRENT_CLIENT_ID),
        from: "external",
        to: "topups",
        platform: "",
        category,
        note,
        amount
      });

      // reset form fields
      document.getElementById("wire_company").value = "";
      document.getElementById("wire_account").value = "";
      document.getElementById("wire_gross").value = "";
      document.getElementById("wire_fee").value = "";
      document.getElementById("wire_net").value = "";
      document.getElementById("wire_desc").value = "";
      document.getElementById("wire_invoice").value = "";

      document.getElementById("crypto_method").value = "";
      document.getElementById("crypto_net").value = "";
      document.getElementById("crypto_gross").value = "";
      document.getElementById("crypto_desc").value = "";
      document.getElementById("crypto_network").value = "";
      document.getElementById("crypto_hash").value = "";
      document.getElementById("crypto_fee_hint").textContent = "Fee: 0.00";

      document.getElementById("special_account").value = "";
      document.getElementById("special_net").value = "";
      document.getElementById("special_desc").value = "";
      document.getElementById("special_invoice").value = "";

      document.getElementById("refund_account").value = "";
      document.getElementById("refund_net").value = "";
      document.getElementById("refund_desc").value = "";

      closeTopupDrawer();
    }

    function exportLedgerJson(){
      const json = JSON.stringify({ clientId: CURRENT_CLIENT_ID, ledger: state.ledger }, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "client-finance-ledger-demo.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    /***************
     * Topup Details drawer (read-only)
     ***************/
    function moneyPlain(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    function statusText(s){
      const v = String(s || "approved").toLowerCase();
      if(v === "pending") return "Pending";
      if(v === "rejected") return "Rejected";
      if(v === "approved") return "Approved";
      return v;
    }

    function parseFeeFromNote(note){
      const m = String(note || "").match(/Fee:\s*([0-9]+(?:\.[0-9]+)?)/i);
      return m ? Number(m[1]) : 0;
    }
    function parseGrossFromNote(note){
      const m = String(note || "").match(/Gross:\s*([0-9]+(?:\.[0-9]+)?)/i);
      return m ? Number(m[1]) : 0;
    }
    function parseAccountFromNote(note){
      const m = String(note || "").match(/Account:\s*([a-zA-Z0-9_:-]+)/i);
      return m ? m[1] : "—";
    }

    function openTopupDetails(txId){
      const tx = state.ledger.find(x => String(x.id) === String(txId));
      if(!tx) return;

      document.getElementById("td_clientId").textContent = String(tx.clientId || "—");
      document.getElementById("td_topupId").textContent = String(tx.id || "—");

      const isRequest = tx.type === "topup_request";
      const typeLabel = isRequest ? "REQUEST" : ((tx.category ? String(tx.category).toUpperCase() : "TOPUP"));
      document.getElementById("td_type").textContent = typeLabel;

      const gross = parseGrossFromNote(tx.note);
      const fee = parseFeeFromNote(tx.note);
      const net = Number(tx.amount || 0);
      const account = parseAccountFromNote(tx.note);

      document.getElementById("td_account").textContent = account;
      document.getElementById("td_gross").textContent = gross ? `${moneyPlain(gross)} USD` : "—";
      document.getElementById("td_fee").textContent = fee ? `${moneyPlain(fee)} USD` : "—";
      document.getElementById("td_net").textContent = `${moneyPlain(net)} USD`;
      document.getElementById("td_status").textContent = statusText(tx.status);

      document.getElementById("td_desc").textContent = tx.note ? String(tx.note) : "—";
      document.getElementById("td_date").textContent = tx.date ? String(tx.date) : "—";

      const modal = document.getElementById("topupDetailsModal");
      modal.classList.add("active");
      modal.setAttribute("aria-hidden", "false");
    }

    function closeTopupDetails(){
      const modal = document.getElementById("topupDetailsModal");
      modal.classList.remove("active");
      modal.setAttribute("aria-hidden", "true");
    }

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape"){
        closeTopupDetails();
        closeTopupDrawer();
        closeLedgerModal();
      }
    });

    /* Boot */
    function refreshAll(){
      setClientHeader();
      updateGlobalHint();
      refreshKPIs();
      refreshFundingUI();
      renderTopupsList();
      refreshLedgerPreview();

      if(document.getElementById("ledgerModal").classList.contains("active")){
        refreshLedgerModal();
      }
    }

    load();

    document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
    document.querySelector(`#ledgerTabs .pill[data-ledger="${state.ledgerTab}"]`)?.classList.add("active");

    refreshAll();
  </script>
</body>
</html>
