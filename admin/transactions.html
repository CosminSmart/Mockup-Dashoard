<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Platform • Transactions</title>

  <!-- KEEP your globals if you want (safe) -->
  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/sidebar.css">

  <style>
    /* =========================================================
       LIQUID GLASS (WHITE) – MATCH SCREENSHOT
    ========================================================= */
    :root{
      --bg0:#f7f8fb;
      --bg1:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      --line: rgba(15,23,42,.10);
      --line2: rgba(15,23,42,.07);

      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.58);

      --shadow: 0 18px 50px rgba(15,23,42,.12);
      --shadow2: 0 12px 28px rgba(15,23,42,.10);

      --r-xl: 18px;
      --r-lg: 14px;
      --r-md: 12px;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#2563eb;

      --focus: rgba(37,99,235,.22);
    }

    [data-theme="dark"]{
      --bg0:#0b1220;
      --bg1:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;

      --line: rgba(255,255,255,.12);
      --line2: rgba(255,255,255,.08);

      --glass: rgba(17,24,39,.58);
      --glass2: rgba(17,24,39,.45);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);

      --focus: rgba(96,165,250,.25);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(99,102,241,.14), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, color-mix(in srgb, var(--bg0) 55%, var(--bg1)) 100%);
    }

    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.06;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    .muted{ color: var(--muted); }

    input, select{
      width:100%;
      padding:.7rem .8rem;
      border:1px solid var(--line2);
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
      color: var(--text);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
      height:44px;
    }
    input:focus, select:focus{
      border-color: color-mix(in srgb, var(--info) 45%, var(--line2));
      box-shadow: 0 0 0 4px var(--focus);
    }

    /* ===== Layout shell (works with your sidebar.js) ===== */
    .layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      min-height:100vh;
    }
    .sidebar{ grid-row: 1 / span 2; }
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ display:none; }
    }

    /* ===== Header (screenshot-like) ===== */
    .header{
      grid-column: 2 / -1;
      background: rgba(255,255,255,.55);
      border-bottom: 1px solid var(--line2);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 12px 18px;
      position: sticky;
      top:0;
      z-index: 80;
    }
    [data-theme="dark"] .header{ background: rgba(15,23,42,.55); }
    @media (max-width: 980px){
      .header{ grid-column: 1 / -1; }
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 320px;
    }
    .brand-badge{
      width:34px; height:34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(37,99,235,.35), rgba(99,102,241,.25));
      border: 1px solid var(--line2);
    }
    .brand-title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      gap:2px;
    }
    .brand-title b{ font-size: 14px; }
    .brand-title span{ font-size: 12px; color: var(--muted); }

    .topbar{
      display:flex;
      align-items:center;
      gap:14px;
      flex: 1;
    }
    .page-tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      width: fit-content;
    }
    .page-tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: background .12s ease, color .12s ease, border-color .12s ease, transform .12s ease;
      user-select:none;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .page-tab:hover{ transform: translateY(-1px); }
    .page-tab.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }
    .pill{
      font-size: 11px;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 65%, transparent);
      color: var(--muted);
    }

    .header-right{
      display:flex;
      align-items:center;
      gap:14px;
    }
    .wallet{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      line-height:1.1;
      gap:2px;
      min-width: 150px;
    }
    .wallet .label{ font-size: 12px; color: var(--muted); font-weight: 800; }
    .wallet .value{ font-size: 13px; font-weight: 950; }

    .theme-toggle{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(12px);
    }
    .theme-btn{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: background .12s ease, color .12s ease, border-color .12s ease;
    }
    .theme-btn.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }

    /* ===== Main ===== */
    main.main{
      grid-column: 2 / -1;
      padding: 18px;
    }
    @media (max-width: 980px){
      main.main{ grid-column: 1 / -1; }
    }

    .glass-panel{
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r-xl);
      padding: 16px;
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .card-header .title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card-header .title b{ font-size: 20px; }
    .card-header .title span{ font-size: 12px; color: var(--muted); }

    /* ===== Buttons ===== */
    .um-btn{
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 65%, transparent);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      height: 44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .um-btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(15,23,42,.08); }
    .um-btn:active{ transform: translateY(0); }
    .um-btn--ghost{
      background: transparent;
    }
    .um-btn--icon{
      width:44px;
      padding:0;
      border-radius: 12px;
    }

    /* ===== Filters row (screenshot) ===== */
    .filters{
      margin-top: 14px;
      padding: 12px;
      border-radius: var(--r-xl);
      border: 1px solid var(--line2);
      background: var(--glass);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .filters-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      min-width: 280px;
      flex: 1;
    }
    .filters-left .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 220px;
      flex: 1;
    }
    .filters-right{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .filters-right .field{ min-width: 160px; }

    /* ===== Table (screenshot) ===== */
    .table-wrap{
      margin-top: 12px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      border-radius: var(--r-xl);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    thead th{
      text-align:left;
      font-size: 12px;
      color: var(--muted);
      font-weight: 950;
      padding: 14px 14px;
      border-bottom: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody td{
      padding: 14px 14px;
      border-bottom: 1px solid var(--line2);
      font-size: 13px;
      vertical-align: middle;
      background: transparent;
    }
    tbody tr:hover td{
      background: color-mix(in srgb, rgba(37,99,235,.06) 60%, transparent);
    }
    td.right{ text-align:right; }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 11px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 65%, transparent);
      color: var(--muted);
    }
    .badge--green{
      background: color-mix(in srgb, rgba(22,163,74,.14) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(22,163,74,.20) 60%, var(--line2));
      color: var(--good);
    }
    .badge--yellow{
      background: color-mix(in srgb, rgba(245,158,11,.14) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(245,158,11,.20) 60%, var(--line2));
      color: var(--warn);
    }
    .badge--red{
      background: color-mix(in srgb, rgba(239,68,68,.14) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(239,68,68,.20) 60%, var(--line2));
      color: var(--bad);
    }
    .amount{
      font-weight: 950;
      white-space: nowrap;
    }

    /* ===== Drawer (right modal) ===== */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.40);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .16s ease;
      z-index: 120;
    }
    .overlay.is-open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      width: min(760px, 92vw);
      height: 100vh;
      background: rgba(255,255,255,.92);
      border-left: 1px solid var(--line2);
      box-shadow: var(--shadow);
      transform: translateX(102%);
      transition: transform .18s ease;
      z-index: 130;
      display:flex;
      flex-direction:column;
    }
    [data-theme="dark"] .drawer{
      background: rgba(15,23,42,.92);
    }
    .drawer.is-open{
      transform: translateX(0);
    }
    .drawer-head{
      padding: 16px 18px;
      border-bottom: 1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .drawer-head .left{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .drawer-head .left b{
      font-size: 14px;
      font-weight: 950;
    }

    .drawer-body{
      padding: 18px;
      overflow:auto;
    }

    /* screenshot-like “label left / value right” rows */
    .kv{
      display:flex;
      flex-direction:column;
      gap: 14px;
      margin-top: 8px;
    }
    .kv-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--line2);
    }
    .kv-row .k{
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      padding-top: 2px;
    }
    .kv-row .v{
      text-align:right;
      font-size: 13px;
      font-weight: 950;
      max-width: 62%;
      word-break: break-word;
    }

    .dots{
      letter-spacing: 2px;
      font-weight: 900;
      color: var(--muted);
    }

    @media (max-width: 840px){
      .brand{ min-width: 240px; }
      .page-tabs{ width: 100%; justify-content: space-between; }
      .topbar{ flex-direction:column; align-items:stretch; gap:10px; }
    }
  </style>
</head>

<body>
  <div class="layout">
    <!-- Header -->
    <header class="header">

      <div class="topbar">
        <div class="page-tabs" id="pageTabs" role="tablist" aria-label="Finance tabs">
          <button type="button" class="page-tab" data-page="topups" role="tab" aria-selected="false">Topups</button>
          <button type="button" class="page-tab" data-page="income" role="tab" aria-selected="false">Income</button>
          <button type="button" class="page-tab" data-page="internal-transactions" role="tab" aria-selected="false">Internal Transactions</button>
          <button type="button" class="page-tab active" data-page="transactions" role="tab" aria-selected="true">Transactions</button>
        </div>
      </div>

      <div class="header-right">
        <div class="theme-toggle" id="themeToggle">
          <button class="theme-btn active" data-theme="light" type="button">Light</button>
          <button class="theme-btn" data-theme="dark" type="button">Dark</button>
        </div>

        <div class="wallet">
          <div class="label">Main Wallet</div>
          <div class="value" id="mainWallet">USD 580.00</div>
        </div>
      </div>
    </header>

    <!-- Sidebar (optional) -->
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="glass-panel">
        <div class="card-header">
          <div class="title">
            <b>Transactions</b>
            <span>Ad spend / charges • details include masked card digits</span>
          </div>
          <button class="um-btn" id="btnExport" type="button">Export Excel</button>
        </div>

        <!-- Filters row -->
        <div class="filters">
          <div class="filters-left">
            <div class="field" style="min-width:260px;">
              <label>Search (TX / account / ad-account ID / tag)</label>
              <input id="fSearch" type="search" placeholder="Search..." />
            </div>
          </div>

          <div class="filters-right">
            <div class="field">
              <label>Status</label>
              <select id="fStatus">
                <option value="all">All</option>
                <option value="settled">Settled</option>
                <option value="pending">Pending</option>
                <option value="failed">Failed</option>
                <option value="reversed">Reversed</option>
              </select>
            </div>

            <div class="field">
              <label>Platform</label>
              <select id="fPlatform">
                <option value="all">All</option>
              </select>
            </div>

            <button class="um-btn um-btn--ghost" id="btnClear" type="button">Clear</button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrap" style="margin-top:14px;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>ID</th>
                <th>Platform</th>
                <th>Account</th>
                <th>Ad Account ID</th>
                <th>Tag</th>
                <th class="right">Amount</th>
                <th>Status</th>
                <th class="right">Action</th>
              </tr>
            </thead>
            <tbody id="txBody"></tbody>
          </table>
        </div>

      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="left">
        <b id="dTitle">Transaction • TX-0000</b>
      </div>
      <button class="um-btn um-btn--ghost" id="btnClose" type="button">Close</button>
    </div>

    <div class="drawer-body">
      <div class="kv" id="kv"></div>
    </div>
  </aside>

  <script>
    /* ==============================
       SWITCHER (Finance/Transactions/Ledger) – like finance
    ============================== */
    const PAGE_ROUTES = {
      topups: "topups.html",
      finance: "finance.html",
      income: "income.html",
      fees: "fees.html",
      "internal-transactions": "internal-transactions.html",
      transactions: "transactions.html"
    };

    document.getElementById("pageTabs")?.addEventListener("click", (e) => {
      const btn = e.target.closest(".page-tab");
      if(!btn) return;
      const key = btn.dataset.page;
      if(!PAGE_ROUTES[key]) return;
      window.location.href = PAGE_ROUTES[key];
    });

    /* =========================
       THEME
    ========================= */
    (function initTheme(){
      const root = document.documentElement;
      const saved = localStorage.getItem("ui_theme") || "light";
      if(saved === "dark") root.setAttribute("data-theme","dark");

      const buttons = document.querySelectorAll("#themeToggle .theme-btn");
      function setTheme(t){
        if(t === "dark") root.setAttribute("data-theme","dark");
        else root.removeAttribute("data-theme");
        localStorage.setItem("ui_theme", t);
        buttons.forEach(b => b.classList.toggle("active", b.dataset.theme === t));
      }
      buttons.forEach(b => b.addEventListener("click", () => setTheme(b.dataset.theme)));
      setTheme(saved);
    })();

    /* =========================
       DEMO DATA (more rows)
    ========================= */
    const TX = [
      { date:"2026-02-19", id:"TX-9001", platform:"FACEBOOK", account:"Alpha FB 01", adId:"aa_1", tag:"ALPHA-FB", amount:120.55, currency:"USD", status:"settled", profile:"Alpha BM", desc:"Ad spend", last4:"4821" },
      { date:"2026-02-18", id:"TX-9002", platform:"FACEBOOK", account:"Alpha FB 01", adId:"aa_1", tag:"ALPHA-FB", amount:64.12, currency:"USD", status:"settled", profile:"Alpha BM", desc:"Campaign charge", last4:"4821" },
      { date:"2026-02-17", id:"TX-9003", platform:"GOOGLE", account:"Beta GAds 02", adId:"ga_102", tag:"BETA-GA", amount:210.00, currency:"USD", status:"pending", profile:"Beta MCC", desc:"Google Ads spend", last4:"9705" },
      { date:"2026-02-16", id:"TX-9004", platform:"TIKTOK", account:"Gamma TT 01", adId:"tt_88", tag:"GAMMA-TT", amount:45.90, currency:"USD", status:"settled", profile:"Gamma TT BM", desc:"TikTok ads charge", last4:"6291" },
      { date:"2026-02-15", id:"TX-9005", platform:"GOOGLE", account:"Beta GAds 02", adId:"ga_102", tag:"BETA-GA", amount:89.10, currency:"USD", status:"failed", profile:"Beta MCC", desc:"Insufficient funds", last4:"9705" },
      { date:"2026-02-14", id:"TX-9006", platform:"FACEBOOK", account:"Delta FB 03", adId:"aa_77", tag:"DELTA-FB", amount:130.00, currency:"USD", status:"settled", profile:"Delta BM", desc:"Ad spend", last4:"0831" },
      { date:"2026-02-13", id:"TX-9007", platform:"TIKTOK", account:"Gamma TT 01", adId:"tt_88", tag:"GAMMA-TT", amount:12.00, currency:"USD", status:"reversed", profile:"Gamma TT BM", desc:"Reversed charge", last4:"6291" },
      { date:"2026-02-12", id:"TX-9008", platform:"GOOGLE", account:"Epsilon GAds 01", adId:"ga_301", tag:"EPS-GA", amount:330.45, currency:"USD", status:"settled", profile:"Epsilon MCC", desc:"Monthly spend", last4:"1908" },
      { date:"2026-02-11", id:"TX-9009", platform:"FACEBOOK", account:"Alpha FB 01", adId:"aa_1", tag:"ALPHA-FB", amount:18.50, currency:"USD", status:"pending", profile:"Alpha BM", desc:"Authorization hold", last4:"4821" },
      { date:"2026-02-10", id:"TX-9010", platform:"GOOGLE", account:"Beta GAds 02", adId:"ga_102", tag:"BETA-GA", amount:77.77, currency:"USD", status:"settled", profile:"Beta MCC", desc:"Ad spend", last4:"9705" },
      { date:"2026-02-09", id:"TX-9011", platform:"TIKTOK", account:"Zeta TT 02", adId:"tt_19", tag:"ZETA-TT", amount:28.30, currency:"USD", status:"settled", profile:"Zeta TT BM", desc:"Charge", last4:"5520" },
      { date:"2026-02-08", id:"TX-9012", platform:"FACEBOOK", account:"Delta FB 03", adId:"aa_77", tag:"DELTA-FB", amount:9.99, currency:"USD", status:"failed", profile:"Delta BM", desc:"Card declined", last4:"0831" },
      { date:"2026-02-07", id:"TX-9013", platform:"GOOGLE", account:"Epsilon GAds 01", adId:"ga_301", tag:"EPS-GA", amount:58.40, currency:"USD", status:"settled", profile:"Epsilon MCC", desc:"Ad spend", last4:"1908" },
      { date:"2026-02-06", id:"TX-9014", platform:"FACEBOOK", account:"Theta FB 09", adId:"aa_900", tag:"THETA-FB", amount:140.00, currency:"USD", status:"settled", profile:"Theta BM", desc:"Ad spend", last4:"1122" },
      { date:"2026-02-05", id:"TX-9015", platform:"TIKTOK", account:"Zeta TT 02", adId:"tt_19", tag:"ZETA-TT", amount:13.37, currency:"USD", status:"pending", profile:"Zeta TT BM", desc:"Charge pending", last4:"5520" },
      { date:"2026-02-04", id:"TX-9016", platform:"GOOGLE", account:"Iota GAds 05", adId:"ga_908", tag:"IOTA-GA", amount:412.12, currency:"USD", status:"settled", profile:"Iota MCC", desc:"Spend", last4:"4455" },
      { date:"2026-02-03", id:"TX-9017", platform:"FACEBOOK", account:"Theta FB 09", adId:"aa_900", tag:"THETA-FB", amount:22.22, currency:"USD", status:"reversed", profile:"Theta BM", desc:"Refund", last4:"1122" },
      { date:"2026-02-02", id:"TX-9018", platform:"GOOGLE", account:"Iota GAds 05", adId:"ga_908", tag:"IOTA-GA", amount:10.00, currency:"USD", status:"failed", profile:"Iota MCC", desc:"Processing error", last4:"4455" },
    ];

    /* =========================
       Helpers
    ========================= */
    const $ = (s) => document.querySelector(s);
    const txBody = $("#txBody");

    function fmtDateRO(iso){
      const d = new Date(iso+"T00:00:00");
      const day = d.getDate();
      const months = ["ianuarie","februarie","martie","aprilie","mai","iunie","iulie","august","septembrie","octombrie","noiembrie","decembrie"];
      return `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function badge(status){
      const s = String(status||"").toLowerCase();
      if(s === "settled") return `<span class="badge badge--green">SETTLED</span>`;
      if(s === "pending") return `<span class="badge badge--yellow">PENDING</span>`;
      if(s === "failed") return `<span class="badge badge--red">FAILED</span>`;
      if(s === "reversed") return `<span class="badge">REVERSED</span>`;
      return `<span class="badge">${String(status||"—").toUpperCase()}</span>`;
    }

    function money(amount, currency="USD"){
      const n = Number(amount||0);
      return `${currency} ${n.toFixed(2)}`;
    }

    function norm(s){ return String(s||"").trim().toLowerCase(); }

    /* =========================
       Render table
    ========================= */
    function renderRows(rows){
      txBody.innerHTML = rows.map(r => `
        <tr
          data-id="${r.id}"
          data-date="${r.date}"
          data-platform="${r.platform}"
          data-account="${r.account}"
          data-adid="${r.adId}"
          data-tag="${r.tag}"
          data-amount="${r.amount}"
          data-currency="${r.currency}"
          data-status="${r.status}"
          data-profile="${r.profile || ""}"
          data-desc="${r.desc || ""}"
          data-last4="${r.last4 || ""}"
        >
          <td>${fmtDateRO(r.date)}</td>
          <td><b>${r.id}</b></td>
          <td>${r.platform}</td>
          <td>${r.account}</td>
          <td>${r.adId}</td>
          <td>${r.tag}</td>
          <td class="right"><span class="amount">${money(r.amount, r.currency)}</span></td>
          <td>${badge(r.status)}</td>
          <td class="right">
            <button class="um-btn um-btn--ghost" type="button" data-open>Details</button>
          </td>
        </tr>
      `).join("");

      // bind buttons
      txBody.querySelectorAll("[data-open]").forEach(btn => {
        btn.addEventListener("click", () => {
          const tr = btn.closest("tr");
          openDrawer(tr);
        });
      });
    }

    /* =========================
       Populate platform filter
    ========================= */
    function initPlatformOptions(){
      const sel = $("#fPlatform");
      const platforms = Array.from(new Set(TX.map(x => x.platform))).sort();
      platforms.forEach(p => {
        const o = document.createElement("option");
        o.value = p;
        o.textContent = p;
        sel.appendChild(o);
      });
    }
    initPlatformOptions();

    /* =========================
       Filtering
    ========================= */
    function applyFilters(){
      const q = norm($("#fSearch").value);
      const st = $("#fStatus").value;
      const pl = $("#fPlatform").value;

      const filtered = TX.filter(r => {
        const okStatus = (st === "all") ? true : (norm(r.status) === st);
        const okPlatform = (pl === "all") ? true : (r.platform === pl);

        const hay = norm([
          r.id, r.platform, r.account, r.adId, r.tag
        ].join(" "));

        const okSearch = q ? hay.includes(q) : true;

        return okStatus && okPlatform && okSearch;
      });

      renderRows(filtered);
    }

    $("#fSearch").addEventListener("input", applyFilters);
    $("#fStatus").addEventListener("change", applyFilters);
    $("#fPlatform").addEventListener("change", applyFilters);

    $("#btnClear").addEventListener("click", () => {
      $("#fSearch").value = "";
      $("#fStatus").value = "all";
      $("#fPlatform").value = "all";
      applyFilters();
    });

    /* =========================
       Drawer logic (screenshot layout)
    ========================= */
    const overlay = $("#overlay");
    const drawer = $("#drawer");

    function openDrawer(tr){
      const ds = tr.dataset;

      $("#dTitle").textContent = `Transaction • ${ds.id || "—"}`;

      const kv = $("#kv");
      const statusHtml = badge(ds.status);

      kv.innerHTML = `
        <div class="kv-row">
          <div class="k">Created</div>
          <div class="v">${fmtDateRO(ds.date || "")}</div>
        </div>

        <div class="kv-row">
          <div class="k">Platform</div>
          <div class="v">${ds.platform || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Ad account</div>
          <div class="v">${ds.account || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Ad account ID</div>
          <div class="v">${ds.adid || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Tag</div>
          <div class="v">${ds.tag || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Profile</div>
          <div class="v">${ds.profile || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Description</div>
          <div class="v">${ds.desc || "—"}</div>
        </div>

        <div class="kv-row">
          <div class="k">Amount</div>
          <div class="v">${money(ds.amount, ds.currency)}</div>
        </div>

        <div class="kv-row">
          <div class="k">Status</div>
          <div class="v">${statusHtml}</div>
        </div>

        <div class="kv-row" style="border-bottom:none;">
          <div class="k">Card last 4</div>
          <div class="v"><span class="dots">••••</span> ${ds.last4 || "—"}</div>
        </div>
      `;

      overlay.classList.add("is-open");
      drawer.classList.add("is-open");
      drawer.setAttribute("aria-hidden", "false");
    }

    function closeDrawer(){
      overlay.classList.remove("is-open");
      drawer.classList.remove("is-open");
      drawer.setAttribute("aria-hidden", "true");
    }

    overlay.addEventListener("click", closeDrawer);
    $("#btnClose").addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeDrawer();
    });

    /* =========================
       Export (CSV, Excel-friendly)
    ========================= */
    function exportFilteredCSV(){
      const rows = Array.from(txBody.querySelectorAll("tr"));
      if(!rows.length){
        alert("Nothing to export.");
        return;
      }

      const header = ["Date","ID","Platform","Account","Ad Account ID","Tag","Amount","Currency","Status","Profile","Description","Card last4"];
      const lines = [header];

      rows.forEach(tr => {
        const ds = tr.dataset;
        lines.push([
          fmtDateRO(ds.date || ""),
          ds.id || "",
          ds.platform || "",
          ds.account || "",
          ds.adid || "",
          ds.tag || "",
          ds.amount || "",
          ds.currency || "",
          ds.status || "",
          ds.profile || "",
          ds.desc || "",
          ds.last4 || ""
        ]);
      });

      const csv = lines
        .map(arr => arr.map(v => `"${String(v).replace(/"/g,'""')}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `transactions_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("#btnExport").addEventListener("click", exportFilteredCSV);

    /* =========================
       Initial render
    ========================= */
    renderRows(TX);

    // Optional: set pending pill from your real pending count later
    // $("#pillPending").textContent = "3 pending";

  </script>

  <script src="../js/sidebar.js"></script>
</body>
</html>
