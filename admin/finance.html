<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Finance</title>

  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/sidebar.css" />
  <link rel="stylesheet" href="../css/accounts.css" />

   <style>
    /* =========================================================
       LIQUID GLASS (WHITE) – READY UI OVERLAY
       - Works with your existing HTML + JS
       - Adds modern spacing, sticky filters, glass panels, chips
       - Includes Light/Dark switch (optional)
    ========================================================= */

    :root{
      --bg0:#f7f8fb;
      --bg1:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      --line: rgba(15,23,42,.10);
      --line2: rgba(15,23,42,.07);

      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.58);

      --shadow: 0 18px 50px rgba(15,23,42,.12);
      --shadow2: 0 12px 28px rgba(15,23,42,.10);

      --r-xl: 18px;
      --r-lg: 14px;
      --r-md: 12px;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#2563eb;

      --focus: rgba(37,99,235,.25);
    }

    /* Dark theme (optional, toggled by JS) */
    [data-theme="dark"]{
      --bg0:#0b1220;
      --bg1:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;

      --line: rgba(255,255,255,.12);
      --line2: rgba(255,255,255,.08);

      --glass: rgba(17,24,39,.58);
      --glass2: rgba(17,24,39,.45);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);

      --focus: rgba(96,165,250,.25);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(99,102,241,.14), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, color-mix(in srgb, var(--bg0) 55%, var(--bg1)) 100%);
    }

    /* Subtle noise overlay (very light) */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.06;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    /* ============ Helpers ============ */
    .glass{
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r-xl);
    }

    .soft{
      background: color-mix(in srgb, var(--glass) 75%, transparent);
      border: 1px solid var(--line2);
      border-radius: var(--r-lg);
    }

    .muted{ color: var(--muted); }
    .mini-hint{
      font-size:.9rem;
      color: var(--muted);
      line-height:1.35;
      margin-top:.2rem;
    }

    /* Inputs */
    input, select, textarea{
      width:100%;
      padding:.7rem .8rem;
      border:1px solid var(--line2);
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
      color: var(--text);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, transform .08s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: color-mix(in srgb, var(--info) 45%, var(--line2));
      box-shadow: 0 0 0 4px var(--focus);
    }
    input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--muted) 78%, transparent); }

    /* Buttons */
    .btn{
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
      color: var(--text);
      padding: .7rem .95rem;
      border-radius: 14px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.55rem;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: color-mix(in srgb, rgba(37,99,235,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.32) 55%, var(--line2));
    }
    .btn.success{
      background: color-mix(in srgb, rgba(22,163,74,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(22,163,74,.32) 55%, var(--line2));
    }
    .btn.ghost{
      background: transparent;
      border-color: var(--line2);
    }
    .btn.gray{
      background: color-mix(in srgb, rgba(148,163,184,.18) 70%, var(--glass));
    }
    .btn-disabled{ opacity:.55; pointer-events:none; }

    /* Header polish (keeps your .header but makes it glassy) */
    .header{
      background: rgba(255,255,255,.55);
      border-bottom: 1px solid var(--line2);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
    [data-theme="dark"] .header{
      background: rgba(15,23,42,.55);
    }
    .header h1{
      letter-spacing: .2px;
      font-weight: 950;
    }

    /* Theme toggle */
    .header-right{ display:flex; align-items:center; gap:14px; }
    .theme-toggle{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(12px);
    }
    .theme-btn{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: background .12s ease, color .12s ease, border-color .12s ease;
    }
    .theme-btn.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }

    /* Make main area nicer */
    .main{ padding: 18px; }
    @media (max-width: 720px){ .main{ padding: 14px; } }

    .finance-container{ width:100%; display:flex; flex-direction:column; gap: 14px; }

    /* ============ Filters Bar ============ */
    .global-filters{
      padding: 14px 14px;
      position: sticky;
      top: 10px;
      z-index: 50;
    }
    .global-filters__row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
    }
    .global-filters__left{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
      flex:1;
    }
    .filter-group{ min-width: 240px; }
    .filter-group.small{ min-width: 180px; }
    @media (max-width: 980px){
      .filter-group{ min-width: 100%; }
      .filter-group.small{ min-width: 100%; }
    }

    .form-group{ margin:0; }
    .form-group label{
      display:block;
      margin: 0 0 .45rem 0;
      font-weight: 900;
      font-size: .88rem;
      color: color-mix(in srgb, var(--text) 85%, var(--muted));
      letter-spacing:.2px;
    }

    .quick-actions{ display:flex; gap: 10px; flex-wrap:wrap; }

    /* ============ KPI Cards ============ */
    .statistics{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1200px){
      .statistics{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 620px){
      .statistics{ grid-template-columns: 1fr; }
    }

    .stat-box{
      padding: 14px 14px;
      border-radius: var(--r-xl);
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      min-height: 108px;
    }
    .stat-box h4{
      margin:0;
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .stat-value{
      font-size: 28px;
      font-weight: 950;
      margin-top: 6px;
      letter-spacing: .2px;
    }
    .stat-description{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    /* KPI select inside card */
    .stat-box select.kpi-select{
      margin-top: 8px;
      padding: .55rem .7rem;
      border-radius: 12px;
      font-weight: 800;
    }

    /* ============ Workspace + Ledger Columns ============ */
    .widgets-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 1100px){
      .widgets-grid{ grid-template-columns: 1fr; }
    }

    .wallet-section{
      padding: 16px;
    }

    .widget-title{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .widget-title h2{
      margin:0;
      font-size: 1.18rem;
      font-weight: 950;
      letter-spacing: .2px;
    }

    /* Pills */
    .pillbar{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      padding: .48rem .72rem;
      border-radius: 999px;
      font-size: .86rem;
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      color: color-mix(in srgb, var(--text) 88%, var(--muted));
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
    .pill.active{
      border-color: color-mix(in srgb, rgba(37,99,235,.35) 70%, var(--line2));
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      color: var(--text);
    }

    /* Warning box */
    .fee-notice{
      background: color-mix(in srgb, rgba(245,158,11,.18) 65%, var(--glass));
      border: 1px solid color-mix(in srgb, rgba(245,158,11,.35) 55%, var(--line2));
      padding: 12px 12px;
      border-radius: 14px;
      margin-top: 10px;
      font-size: .92rem;
      color: color-mix(in srgb, var(--text) 85%, var(--muted));
    }

    .split{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
    }

    /* Tags + amounts */
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:.18rem .55rem;
      border-radius: 999px;
      font-size:.78rem;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      font-weight: 900;
      color: color-mix(in srgb, var(--text) 88%, var(--muted));
      margin-right: .35rem;
      white-space: nowrap;
    }
    .amount-pos{ font-weight: 950; color: color-mix(in srgb, var(--good) 92%, var(--text)); }
    .amount-neg{ font-weight: 950; color: color-mix(in srgb, var(--bad) 92%, var(--text)); }

    /* Ledger table */
    .ledger-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      border-radius: var(--r-xl);
      overflow:hidden;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      margin-top: 6px;
      font-size: .92rem;
    }
    .ledger-table th, .ledger-table td{
      padding: .8rem .75rem;
      border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);
      text-align:left;
      vertical-align: top;
    }
    .ledger-table th{
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: .78rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      background: color-mix(in srgb, var(--glass) 85%, var(--bg1));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .ledger-table tr:hover td{
      background: color-mix(in srgb, rgba(37,99,235,.10) 55%, transparent);
    }

    /* ============ Topups Section + Table ============ */
    .topups-section{ padding: 16px; }
    .topups-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .topups-header h2{
      margin:0;
      font-size: 1.25rem;
      font-weight: 950;
    }

    .topups-table-wrap{
      border:1px solid var(--line2);
      border-radius: var(--r-xl);
      overflow:auto;
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }
    .topups-table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: .92rem;
      min-width: 980px;
    }
    .topups-table th, .topups-table td{
      padding: .85rem .75rem;
      border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    .topups-table th{
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: .78rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      background: color-mix(in srgb, var(--glass) 88%, var(--bg1));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .topups-row{
      cursor:pointer;
      transition: background .12s ease;
    }
    .topups-row:hover{
      background: color-mix(in srgb, rgba(37,99,235,.10) 60%, transparent);
    }
    .td-muted{ color: var(--muted); }
    .td-right{ text-align:right; }

    /* Status badge */
    .status-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.28rem .65rem;
      border-radius: 999px;
      font-weight: 950;
      font-size:.82rem;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 72%, transparent);
      color: color-mix(in srgb, var(--text) 92%, var(--muted));
    }
    .status-badge.approved{
      background: color-mix(in srgb, rgba(22,163,74,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(22,163,74,.35) 55%, var(--line2));
      color: color-mix(in srgb, var(--good) 85%, var(--text));
    }
    .status-badge.pending{
      background: color-mix(in srgb, rgba(245,158,11,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(245,158,11,.35) 55%, var(--line2));
      color: color-mix(in srgb, var(--warn) 82%, var(--text));
    }
    .status-badge.declined{
      background: color-mix(in srgb, rgba(239,68,68,.16) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(239,68,68,.32) 55%, var(--line2));
      color: color-mix(in srgb, var(--bad) 82%, var(--text));
    }
    .status-badge.past_due{
      background: color-mix(in srgb, rgba(148,163,184,.16) 70%, var(--glass));
      border-color: color-mix(in srgb, rgba(148,163,184,.28) 60%, var(--line2));
      color: color-mix(in srgb, var(--muted) 88%, var(--text));
    }

    /* ============ Drawer + Modal (Glass) ============ */
    .drawer, .tx-modal, .modal-simple{ font-family: inherit; }

    .drawer{ position: fixed; inset: 0; z-index: 2000; display: none; }
    .drawer.active{ display:block; }
    .drawer__overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .drawer__panel{
      position:absolute; top:0; right:0;
      height: 100%;
      width: min(440px, 92vw);
      background: var(--glass);
      border-left: 1px solid var(--line2);
      box-shadow: -22px 0 60px rgba(15,23,42,.22);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform .22s ease;
    }
    .drawer.active .drawer__panel{ transform: translateX(0); }
    .drawer__header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid var(--line2);
    }
    .drawer__title{ font-size: 1.25rem; font-weight: 950; margin: 0; color: var(--text); }
    .drawer__close{
      width: 38px; height: 38px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 75%, transparent);
      border-radius: 14px; cursor:pointer;
      font-size: 18px; line-height: 36px;
      color: var(--text);
    }
    .drawer__body{ padding: 14px; overflow:auto; }
    .drawer__footer{
      padding: 14px; border-top:1px solid var(--line2);
      display:flex; gap:10px; justify-content:flex-start;
      background: color-mix(in srgb, var(--glass) 85%, transparent);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* Segmented buttons */
    .segmented{ display:flex; gap:8px; flex-wrap: wrap; margin: 10px 0 12px 0; }
    .seg-btn{
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      padding:.58rem .88rem;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 950;
      font-size: .9rem;
      color: color-mix(in srgb, var(--text) 88%, var(--muted));
    }
    .seg-btn.active{
      background: color-mix(in srgb, rgba(37,99,235,.22) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.35) 55%, var(--line2));
      color: var(--text);
    }

    /* Notice box */
    .notice-box{
      margin-top: 10px;
      background: color-mix(in srgb, rgba(239,68,68,.14) 55%, var(--glass));
      border:1px solid color-mix(in srgb, rgba(239,68,68,.26) 55%, var(--line2));
      color: color-mix(in srgb, var(--text) 85%, var(--muted));
      padding: 12px;
      border-radius: 14px;
      font-size: .88rem;
      line-height: 1.35;
    }

    /* Topup details (tx-modal) */
    .tx-modal{
      position:fixed;
      inset:0;
      z-index:3000;
      display:none;
    }
    .tx-modal.active{ display:block; }
    .tx-modal__overlay{
      position:absolute; inset:0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      opacity:0;
      transition:opacity .22s ease;
    }
    .tx-modal.active .tx-modal__overlay{ opacity:1; }

    .tx-modal__panel{
      position:absolute;
      top:0; right:0;
      height:100%;
      width:min(500px, 95vw);
      background: var(--glass);
      border-left: 1px solid var(--line2);
      box-shadow:-22px 0 60px rgba(15,23,42,.22);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);

      transform:translateX(100%);
      transition:transform .22s ease;

      display:flex;
      flex-direction:column;
    }
    .tx-modal.active .tx-modal__panel{ transform:translateX(0); }

    .tx-modal__header{
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid var(--line2);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .tx-modal__header h3{
      margin:0;
      font-size: 1.2rem;
      font-weight: 950;
    }
    .tx-close{
      width: 38px; height: 38px;
      border:1px solid var(--line2);
      border-radius: 14px;
      background: color-mix(in srgb, var(--glass) 75%, transparent);
      cursor:pointer;
      font-size: 18px;
      color: var(--text);
    }

    .tx-modal__body{
      padding: 14px;
      overflow:auto;
      flex:1;
    }

    .modal-footer{
      padding: 14px;
      border-top:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 85%, transparent);
      display:flex;
      gap:10px;
      justify-content:flex-start;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* KV card inside details */
    .kv-card{
      border:1px solid var(--line2);
      border-radius: var(--r-xl);
      background: color-mix(in srgb, var(--glass) 72%, transparent);
      overflow:hidden;
      box-shadow: var(--shadow2);
    }
    .kv-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 10px 12px;
      border-bottom:1px solid color-mix(in srgb, var(--line2) 70%, transparent);
      align-items:center;
    }
    .kv-row:last-child{ border-bottom:none; }
    .kv-key{
      font-weight: 950;
      font-size: .9rem;
      color: color-mix(in srgb, var(--text) 92%, var(--muted));
    }
    .kv-val{
      text-align:right;
      color: var(--muted);
      font-weight: 900;
      font-size: .9rem;
    }

    /* Status segmented pills (details modal) */
    .segmented-status{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin: 8px 0 12px 0;
    }
    .seg-pill{
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      padding:.55rem .85rem;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 950;
      font-size: .9rem;
      color: var(--muted);
      user-select:none;
    }
    .seg-pill.active{
      color: var(--text);
      background: color-mix(in srgb, rgba(37,99,235,.20) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.35) 55%, var(--line2));
    }
    .seg-pill.active.pending{
      background: color-mix(in srgb, rgba(245,158,11,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(245,158,11,.35) 55%, var(--line2));
    }
    .seg-pill.active.approved{
      background: color-mix(in srgb, rgba(22,163,74,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(22,163,74,.35) 55%, var(--line2));
    }
    .seg-pill.active.declined{
      background: color-mix(in srgb, rgba(239,68,68,.16) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(239,68,68,.32) 55%, var(--line2));
    }
    .seg-pill.active.past_due{
      background: color-mix(in srgb, rgba(148,163,184,.16) 70%, var(--glass));
      border-color: color-mix(in srgb, rgba(148,163,184,.28) 60%, var(--line2));
    }

    /* Ledger Modal (center) */
    .modal-simple{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.38);
      z-index: 2500;
      padding: 16px;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .modal-simple.active{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .modal-simple-content{
      width: min(980px, 100%);
      background: var(--glass);
      border: 1px solid var(--line2);
      border-radius: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      padding: 16px;
    }

    /* Fix "layout.css/dashboard.css" sometimes set section backgrounds to pure white */
    .wallet-section,
    .global-filters,
    .topups-section{
      background: var(--glass) !important;
      border: 1px solid var(--line2) !important;
      box-shadow: var(--shadow2) !important;
      backdrop-filter: blur(14px) !important;
      -webkit-backdrop-filter: blur(14px) !important;
      border-radius: var(--r-xl) !important;
    }

    /* ✅ Make your existing .transfer-btn use the same styling as .btn */
.transfer-btn{
  border: 1px solid var(--line2);
  background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
  color: var(--text);
  padding: .7rem .95rem;
  border-radius: 14px;
  font-weight: 800;
  cursor: pointer;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  user-select:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.55rem;
}
.transfer-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
.transfer-btn:active{ transform: translateY(0px); }

.transfer-btn.secondary{
  background: color-mix(in srgb, rgba(37,99,235,.18) 65%, var(--glass));
  border-color: color-mix(in srgb, rgba(37,99,235,.32) 55%, var(--line2));
}

.transfer-btn.gray{
  background: color-mix(in srgb, rgba(148,163,184,.18) 70%, var(--glass));
}

.transfer-btn.btn-disabled{
  opacity:.55;
  pointer-events:none;
}


/* ===== Header Tabs (Finance / Transactions / Ledger) ===== */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding: 12px 18px;
}

.header-left{
  display:flex;
  flex-direction:column;
  gap:6px;
  min-width: 280px;
}

.page-tabs{
  display:flex;
  gap:8px;
  padding: 6px;
  border-radius: 999px;
  border: 1px solid var(--line2);
  background: color-mix(in srgb, var(--glass) 70%, transparent);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  width: fit-content;
}

.page-tab{
  border:1px solid transparent;
  background: transparent;
  color: var(--muted);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 950;
  cursor:pointer;
  transition: background .12s ease, color .12s ease, border-color .12s ease, transform .12s ease;
  letter-spacing: .2px;
  user-select:none;
}

.page-tab:hover{ transform: translateY(-1px); }

.page-tab.active{
  background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
  border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
  color: var(--text);
}

.page-subtitle{
  font-size: .92rem;
  font-weight: 850;
  opacity: .95;
}

/* Mobile */
@media (max-width: 820px){
  .header{ flex-wrap:wrap; align-items:flex-start; }
  .header-left{ width:100%; }
  .page-tabs{ width:100%; justify-content:space-between; }
  .page-tab{ flex:1; text-align:center; }
}


.page-tabs{
  display:flex;
  gap:8px;
  padding:6px;
  border-radius:999px;
  border:1px solid var(--line2);
  background: color-mix(in srgb, var(--glass) 70%, transparent);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  width: fit-content;
}

.page-tab{
  border:1px solid transparent;
  background: transparent;
  color: var(--muted);
  padding: 10px 14px;
  border-radius: 999px;
  font-weight: 950;
  cursor:pointer;
  transition: background .12s ease, color .12s ease, border-color .12s ease, transform .12s ease;
  user-select:none;
  letter-spacing:.2px;
}
.page-tab:hover{ transform: translateY(-1px); }

.page-tab.active{
  background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
  border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
  color: var(--text);
}

@media (max-width: 820px){
  .page-tabs{ width:100%; justify-content:space-between; }
  .page-tab{ flex:1; text-align:center; }
}




  </style>
</head>

<body>
    <div class="layout">
<header class="header">
  <div class="page-tabs" id="pageTabs" role="tablist" aria-label="Finance tabs">
    <button type="button" class="page-tab" data-page="topups" role="tab" aria-selected="false">
      Topups
    </button>
    <button type="button" class="page-tab active" data-page="finance" role="tab" aria-selected="true">
      Finance
    </button>
    <button type="button" class="page-tab" data-page="fees" role="tab" aria-selected="false">
      Fees
    </button>
    <button type="button" class="page-tab" data-page="internal-transactions" role="tab" aria-selected="false">
      Internal Transactions
    </button>
    <button type="button" class="page-tab" data-page="transactions" role="tab" aria-selected="false">
      Transactions
    </button>
  </div>

</header>


    <!-- Transfer Modal -->
    <div class="modal-simple" id="transferModal">
        <div class="modal-simple-content">
            <h2 id="modalTitle">Transfer Funds</h2>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="transferAmount" placeholder="Enter amount">
            </div>
            <div class="form-group" id="accountSelectGroup" style="display: none;">
                <label>Select Account</label>
                <select id="accountSelect">
                    <option value="">Select account...</option>
                    <option value="acc1">Account 1</option>
                    <option value="acc2">Account 2</option>
                </select>
            </div>
            <div class="form-group" id="platformSelectGroup" style="display: none;">
                <label>Select Platform</label>
                <select id="platformSelect">
                    <option value="">Select platform...</option>
                    <option value="facebook">Facebook</option>
                    <option value="google">Google</option>
                    <option value="tiktok">TikTok</option>
                </select>
            </div>
            <div id="feeInfo" style="margin: 1rem 0; padding: 0.5rem; background: #f0f0f0; border-radius: 4px;"></div>
            <div style="display: flex; gap: 1rem;">
                <button class="transfer-btn" onclick="confirmTransfer()">Confirm Transfer</button>
                <button class="transfer-btn" style="background: #95a5a6;" onclick="closeTransferModal()">Cancel</button>
            </div>
        </div>
        <div class="user-info">
          <span>Admin User</span>
          <div class="user-avatar">AU</div>
        </div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="finance-container">

        <!-- GLOBAL FILTERS -->
        <div class="global-filters">
          <div class="global-filters__row">
            <div class="global-filters__left">
              <div class="form-group filter-group">
                <label>Client</label>
                <select id="global_client" onchange="onGlobalFiltersChanged()">
                  <option value="__all__">All clients</option>
                </select>
              </div>

              <div class="form-group filter-group small">
                <label>Date from</label>
                <input type="date" id="global_from" onchange="onGlobalFiltersChanged()">
              </div>

              <div class="form-group filter-group small">
                <label>Date to</label>
                <input type="date" id="global_to" onchange="onGlobalFiltersChanged()">
              </div>

              <!-- ✅ NEW: Single filter by status (for Topups table only) -->
              <!-- <div class="form-group filter-group small">
                <label>Status</label>
                <select id="topups_status" onchange="onTopupsStatusChanged()">
                  <option value="__all__">All</option>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="declined">Declined</option>
                  <option value="past_due">Past Due</option>
                </select>
              </div> -->
            </div>

            <div class="quick-actions">
              <button class="transfer-btn gray" onclick="clearGlobalFilters()">Clear</button>
            </div>
          </div>

          <div class="mini-hint" id="global_hint"></div>
        </div>

        <!-- PAGE: Finance (default view with KPIs, workspace, etc.) -->
        <div id="page_finance">

        <!-- KPI Statistics -->
        <div class="statistics">
          <div class="stat-box">
            <h4>TOTAL TOPUPS</h4>
            <div class="stat-value" id="kpi_totalTopups">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>MAIN WALLET</h4>
            <div class="stat-value" id="kpi_mainWallet">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>PLATFORMS VAULT</h4>
            <div class="stat-value" id="kpi_platformVault">$0.00</div>
            <div class="stat-description">
              <select id="kpi_platformFilter" class="kpi-select">
                <option value="__all__">Total (All Platforms)</option>
                <option value="facebook">Facebook</option>
                <option value="google">Google</option>
                <option value="tiktok">TikTok</option>
              </select>
              <div class="mini-hint">Filtered by client/date</div>
            </div>
          </div>

          <div class="stat-box">
            <h4>GENERAL BALANCE</h4>
            <div class="stat-value" id="kpi_generalBalance">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>INDIVIDUAL BALANCE</h4>
            <div class="stat-value" id="kpi_individualBalance">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>SPEND</h4>
            <div class="stat-value" id="kpi_spend">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>TOTAL FEES</h4>
            <div class="stat-value" id="kpi_totalFees">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>SETUP ACCOUNT + SERVICES</h4>
            <div class="stat-value" id="kpi_setupServices">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>
        </div>

        <!-- Workspace + Ledger -->
        <div class="widgets-grid">
          <!-- FINANCE WORKSPACE -->
          <div class="wallet-section" style="width: 168%;">
            <div class="widget-title">
              <div>
                <h2>Finance Workspace</h2>
                <div class="mini-hint">
                  Acțiunile se aplică pe <strong>clientul selectat</strong>. Dacă e "All clients", acțiunile sunt blocate.
                </div>
              </div>

              <!-- MAIN WORKSPACE TABS -->
              <div class="pillbar" id="workspaceTabs">
                <div class="pill active" data-tab="funding">Funding</div>
                <div class="pill" data-tab="setup">Setup & Services</div>
                <div class="pill" data-tab="fees">Fees</div>
              </div>
            </div>

            <!-- TAB: Funding -->
            <div id="tab_funding">

              <!-- SUBTABS IN FUNDING -->
              <div class="subtab-header">
                <div class="mini-hint">Alege fluxul (funding / allocate / individual send).</div>
                <div class="pillbar" id="fundingSubTabs">
                  <div class="pill active" data-subtab="main_to_vault">Main → Vault</div>
                  <div class="pill" data-subtab="vault_allocate">Vault → (General/Individual/Account)</div>
                  <div class="pill" data-subtab="individual_to_account">Individual → Account</div>
                </div>
              </div>

              <!-- SUBTAB: Main -> Vault -->
              <div id="subtab_main_to_vault">
                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Main Wallet</option>
                    </select>
                    <div class="mini-hint" id="tx_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To</label>
                    <select disabled>
                      <option>Platform Vault</option>
                    </select>
                    <div class="mini-hint">Din Main Wallet poți trimite doar către Platform Vault.</div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform</label>
                    <select id="tx_platform" onchange="updateFundingPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="tx_amount" min="0" step="0.01" placeholder="e.g. 250" oninput="updateFundingPreview()">
                  </div>
                </div>

                <div class="form-group">
                  <label>Note (optional)</label>
                  <input type="text" id="tx_note" placeholder="e.g. Funding for campaigns Feb" oninput="updateFundingPreview()">
                </div>

     
                <div class="split">
                  <div class="muted" id="tx_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitMainToVault()">Confirm Transfer</button>
                    <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Vault -> Allocate -->
              <div id="subtab_vault_allocate" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Allocate from Platform Vault</strong> către General / Individual / Accounts:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform Vault</label>
                    <select id="alloc_platform" onchange="updateAllocationPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                    <div class="mini-hint" id="alloc_platformHint"></div>
                  </div>

                  <div class="form-group">
                    <label>Allocate To</label>
                    <select id="alloc_to" onchange="toggleAllocAccountSelect(); updateAllocationPreview();">
                      <option value="generalBalance">General Balance</option>
                      <option value="individualBalance">Individual Balance</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group" id="alloc_accountGroup" style="display:none;">
                    <label>Select Account</label>
                    <select id="alloc_account" onchange="updateAllocationPreview()">
                      <option value="acc_1">acc_1</option>
                      <option value="acc_2">acc_2</option>
                      <option value="acc_3">acc_3</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="alloc_amount" min="0" step="0.01" placeholder="e.g. 120" oninput="updateAllocationPreview()">
                  </div>
                </div>

                <div class="form-group">
                  <label>Note (optional)</label>
                  <input type="text" id="alloc_note" placeholder="e.g. allocate to acc_1" oninput="updateAllocationPreview()">
                </div>

                <div class="split">
                  <div class="muted" id="alloc_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitAllocation()">Confirm Allocation</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Individual -> Account -->
              <div id="subtab_individual_to_account" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Send from Individual Balance</strong> către un cont anume:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Individual Balance</option>
                    </select>
                    <div class="mini-hint" id="ind_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To (Account)</label>
                    <select id="ind_toAccount" onchange="updateIndToAccountPreview()">
                      <option value="acc_1">acc_1</option>
                      <option value="acc_2">acc_2</option>
                      <option value="acc_3">acc_3</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="ind_amount" min="0" step="0.01" placeholder="e.g. 100" oninput="updateIndToAccountPreview()">
                  </div>

                  <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="ind_note" placeholder="e.g. assign to acc_2 budget" oninput="updateIndToAccountPreview()">
                  </div>
                </div>

                <div class="split">
                  <div class="muted" id="ind_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitIndividualToAccount()">Confirm Send</button>
                  </div>
                </div>
              </div>

            </div>

            <!-- TAB: Setup & Services -->
            <div id="tab_setup" style="display:none;">
              <div class="mini-hint" style="margin-bottom:.75rem;">
                Setup/Services se ia <strong>direct</strong> din Main Wallet.
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Charge Type</label>
                  <select id="charge_type">
                    <option value="setup">Setup</option>
                    <option value="service">Service</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Model</label>
                  <select id="charge_model">
                    <option value="one-time">one-time</option>
                    <option value="recurring">recurring</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Linked (Account)</label>
                  <select id="charge_linked">
                    <option value="acc_1">Account: acc_1</option>
                    <option value="acc_2">Account: acc_2</option>
                    <option value="acc_3">Account: acc_3</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Amount (USD)</label>
                  <input type="number" id="charge_amount" min="0" step="0.01" placeholder="e.g. 80">
                </div>
              </div>

              <div class="form-group">
                <label>Details (JSON/text)</label>
                <textarea id="charge_details" rows="3" placeholder='e.g. {"region":"US","level":"Standard","note":"BOV verification"}'></textarea>
              </div>

              <div class="fee-notice">
                <strong>Logic:</strong> Main Wallet scade cu amount, iar KPI <strong>Setup Account + Services</strong> crește cu amount.
              </div>

              <div class="quick-actions">
                <button class="transfer-btn secondary" onclick="submitSetupServiceCharge()">+ Add Charge</button>
                <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
              </div>
            </div>

            <!-- TAB: Fees -->
            <div id="tab_fees" style="display:none;">
              <div class="mini-hint" style="margin-bottom:1rem;">
                Derived from internal transactions - everything links back to audit log
              </div>

              <!-- Fee Summary Cards -->
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 1.5rem;">
                <div class="stat-box">
                  <h4>TOTAL FEES</h4>
                  <div class="stat-value" style="color: var(--info);">USD 25.00</div>
                  <div class="stat-description">All fee categories</div>
                </div>

                <div class="stat-box">
                  <h4>TOP-UP FEES</h4>
                  <div class="stat-value" style="color: var(--warn);">USD 20.00</div>
                  <div class="stat-description">Withdrawal fees</div>
                </div>

                <div class="stat-box">
                  <h4>TRANSFER FEES</h4>
                  <div class="stat-value" style="color: var(--good);">USD 5.00</div>
                  <div class="stat-description">Main → Platform/transfer</div>
                </div>

                <div class="stat-box">
                  <h4>SETUP + SERVICES</h4>
                  <div class="stat-value" style="color: var(--muted);">USD 0.00</div>
                  <div class="stat-description">Charges from Main Wallet</div>
                </div>
              </div>

              <!-- Add Service Fee Button -->
              <div style="margin-bottom: 1rem; text-align: right;">
                <button class="btn success" onclick="openAddServiceFeeModal()">+ Add Service Fee</button>
              </div>

              <!-- Fees Table -->
              <div style="border: 1px solid var(--line2); border-radius: var(--r-xl); overflow: hidden; background: var(--glass); backdrop-filter: blur(14px);">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: color-mix(in srgb, var(--glass) 88%, var(--bg1)); backdrop-filter: blur(14px);">
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Date</th>
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Type</th>
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Amount</th>
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Fee code</th>
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Link</th>
                      <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Description</th>
                      <th style="padding: 14px 16px; text-align: center; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Action</th>
                    </tr>
                  </thead>
                  <tbody id="feesTableBody">
                    <tr style="border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);">
                      <td style="padding: 14px 16px;">19 februarie 2026</td>
                      <td style="padding: 14px 16px;">
                        <span style="display: inline-block; padding: 4px 10px; background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-radius: 999px; font-size: 12px; font-weight: 700;">TOPUP</span>
                      </td>
                      <td style="padding: 14px 16px; font-weight: 700;">USD 20.00</td>
                      <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--muted);">TOPUP_WIRE</td>
                      <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--info); font-size: 13px;">TOPUPTU-DEMO-1</td>
                      <td style="padding: 14px 16px; color: var(--muted);">Demo > Top-up fee</td>
                      <td style="padding: 14px 16px; text-align: center;">
                        <button class="btn ghost" style="padding: 6px 12px; font-size: 13px;">Details</button>
                      </td>
                    </tr>
                    <tr style="border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);">
                      <td style="padding: 14px 16px;">19 februarie 2026</td>
                      <td style="padding: 14px 16px;">
                        <span style="display: inline-block; padding: 4px 10px; background: rgba(22, 163, 74, 0.15); color: #16a34a; border-radius: 999px; font-size: 12px; font-weight: 700;">TRANSFER</span>
                      </td>
                      <td style="padding: 14px 16px; font-weight: 700;">USD 5.00</td>
                      <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--muted);">TRANSFER_MAIN_TO_VAULT</td>
                      <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--info); font-size: 13px;">TRANSFERTR-DEMO-1</td>
                      <td style="padding: 14px 16px; color: var(--muted);">Demo > Transfer fee</td>
                      <td style="padding: 14px 16px; text-align: center;">
                        <button class="btn ghost" style="padding: 6px 12px; font-size: 13px;">Details</button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="mini-hint" style="margin-top: 1rem;">
                To be clear: internal transactions are the main audit log. These additions and data lookups are derived from them. If there's a discrepancy, the internal transactions are the source of truth. These additions and data lookups are derived from them.
              </div>
            </div>
          </div>

          <!-- LEDGER -->
          <div class="wallet-section" style="display: none;">
            <div class="widget-title">
              <div>
                <h2>Ledger</h2>
                <div class="mini-hint">Preview filtrat de client/date.</div>
              </div>

              <div class="pillbar" id="ledgerTabs">
                <div class="pill active" data-ledger="all">All</div>
                <div class="pill" data-ledger="topups">Topups</div>
                <div class="pill" data-ledger="fees">Fees</div>
                <div class="pill" data-ledger="internal">Internal</div>
              </div>
            </div>

            <table class="ledger-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Details</th>
                  <th style="text-align:right;">Amount</th>
                </tr>
              </thead>
              <tbody id="ledgerPreviewBody"></tbody>
            </table>

            <div class="split">
              <div class="muted" id="ledgerHint"></div>
              <div class="quick-actions">
                <button class="transfer-btn" onclick="openLedgerModal()">View All</button>
                <button class="transfer-btn gray" onclick="exportLedgerJson()">Export JSON</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Topups -->
        <div class="topups-section" style="display: none;">
          <div class="topups-header">
            <div>
              <h2>Total Topups</h2>
              <div class="mini-hint">Listă filtrată de client/date + Status (doar pentru tabel).</div>
            </div>
            <div class="quick-actions">
              <!-- ✅ keep button exactly here (as you requested) -->
              <button class="transfer-btn secondary" onclick="openTopupDrawer()">+ Add Topup</button>
            </div>
          </div>

          <!-- ✅ NEW table -->
          <div class="topups-table-wrap">
            <table class="topups-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Account</th>
                  <th>Proof</th>
                  <th class="td-right">Amount</th>
                  <th>Status</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="topupsTableBody"></tbody>
            </table>
          </div>

          <div class="mini-hint" id="topupsTableHint" style="margin-top:.6rem;"></div>
        </div>

        </div>
        <!-- END PAGE: Finance -->

        <!-- PAGE: Transactions -->
        <div id="page_transactions" style="display:none;">
          <div class="wallet-section" style="margin-top: 1.5rem;">
            <div class="widget-title">
              <h2>All Transactions</h2>
              <div class="mini-hint" id="txPageHint"></div>
            </div>

            <div style="max-height: 70vh; overflow:auto; border:1px solid var(--line2); border-radius: var(--r-lg); padding: .25rem;">
              <table class="ledger-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>From → To</th>
                    <th>Client</th>
                    <th>Platform</th>
                    <th>Category</th>
                    <th>Note</th>
                    <th style="text-align:right;">Amount</th>
                  </tr>
                </thead>
                <tbody id="txPageBody"></tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- END PAGE: Transactions -->

        <!-- PAGE: Internal Transactions -->
        <div id="page_internal-transactions" style="display:none;">
          <div style="margin-top: 1.5rem; padding: 1.5rem; background: var(--bg1); border-radius: var(--r-xl); border: 1px solid var(--line2);">
            
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
              <div>
                <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Internal Transactions</h2>
                <div style="font-size: 0.875rem; color: var(--muted); margin-top: 0.25rem;">
                  Full audit log of money movements • <span id="internalTxCount">0</span> entries
                </div>
              </div>
              <button class="transfer-btn" onclick="exportInternalTransactionsExcel()" style="padding: 8px 16px;">Export Excel</button>
            </div>

            <!-- Search and Filter Row -->
            <div style="display: flex; gap: 0.75rem; align-items: flex-end; margin-top: 1.5rem; margin-bottom: 1.5rem;">
              <div style="flex: 1; max-width: 500px;">
                <label style="display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.35rem;">
                  Search (ID / Date / Description / Link)
                </label>
                <input 
                  type="text" 
                  id="internalTx_search" 
                  placeholder="Search..." 
                  oninput="filterInternalTransactions()"
                  style="width: 100%; padding: 8px 12px; border: 1px solid var(--line2); border-radius: 8px; background: var(--bg0); color: var(--text); font-size: 0.9rem;"
                >
              </div>

              <div style="min-width: 180px;">
                <label style="display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.35rem;">
                  Category
                </label>
                <select 
                  id="internalTx_category" 
                  onchange="filterInternalTransactions()"
                  style="width: 100%; padding: 8px 12px; border: 1px solid var(--line2); border-radius: 8px; background: var(--bg0); color: var(--text); font-size: 0.9rem;"
                >
                  <option value="__all__">All</option>
                  <option value="topup_approval">TOPUP_APPROVAL</option>
                  <option value="topup_fee">TOPUP_FEE</option>
                  <option value="transfer">TRANSFER</option>
                  <option value="transfer_fee">TRANSFER_FEE</option>
                  <option value="service_charge">SERVICE_CHARGE</option>
                  <option value="setup_charge">SETUP_CHARGE</option>
                  <option value="refund">REFUND</option>
                  <option value="other">OTHER</option>
                </select>
              </div>

              <button class="transfer-btn gray" onclick="clearInternalTxFilters()" style="padding: 8px 16px;">Clear</button>
            </div>

            <!-- Table -->
            <div style="overflow-x: auto; border: 1px solid var(--line2); border-radius: var(--r-lg);">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead>
                  <tr style="background: var(--bg0); border-bottom: 1px solid var(--line2);">
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text); white-space: nowrap;">Date</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Category</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Amount</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">From</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">To</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Link</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Description</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--text);">Action</th>
                  </tr>
                </thead>
                <tbody id="internalTxPageBody">
                  <!-- Rows will be inserted here -->
                </tbody>
              </table>
            </div>

          </div>
        </div>
        <!-- END PAGE: Internal Transactions -->

        <!-- PAGE: Ledger -->
        <div id="page_ledger" style="display:none;">
          <div class="wallet-section" style="margin-top: 1.5rem;">
            <div class="widget-title">
              <h2>Ledger (Full View)</h2>
              <div class="mini-hint" id="ledgerPageHint"></div>
            </div>

            <div style="max-height: 70vh; overflow:auto; border:1px solid var(--line2); border-radius: var(--r-lg); padding: .25rem;">
              <table class="ledger-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Details</th>
                    <th style="text-align:right;">Amount</th>
                  </tr>
                </thead>
                <tbody id="ledgerPreviewBody_clone"></tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- END PAGE: Ledger -->
        <!-- Fees Section -->
        <div id="page_fees" style="display: none;">
          <div style="margin-bottom: 1.5rem;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">Fees</h2>
            <p style="color: var(--muted); font-size: 0.95rem;">Derived from internal transactions - everything links back to audit log</p>
          </div>

          <!-- Fee Statistics -->
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 1.5rem;">
            <div class="stat-box">
              <h4>TOTAL FEES</h4>
              <div class="stat-value" style="color: var(--info);">USD 25.00</div>
              <div class="stat-description">All fee categories</div>
            </div>

            <div class="stat-box">
              <h4>TOP-UP FEES</h4>
              <div class="stat-value" style="color: var(--warn);">USD 20.00</div>
              <div class="stat-description">Withdrawal fees</div>
            </div>

            <div class="stat-box">
              <h4>TRANSFER FEES</h4>
              <div class="stat-value" style="color: var(--good);">USD 5.00</div>
              <div class="stat-description">Main → Platform/transfer</div>
            </div>

            <div class="stat-box">
              <h4>SETUP + SERVICES</h4>
              <div class="stat-value" style="color: var(--muted);">USD 0.00</div>
              <div class="stat-description">Charges from Main Wallet</div>
            </div>
          </div>

          <!-- Add Service Fee Button -->
          <div style="margin-bottom: 1rem; text-align: right;">
            <button class="btn success" onclick="openAddServiceFeeModal()">+ Add Service Fee</button>
          </div>

          <!-- Fees Table -->
          <div style="border: 1px solid var(--line2); border-radius: var(--r-xl); overflow: hidden; background: var(--glass); backdrop-filter: blur(14px); box-shadow: var(--shadow2);">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: color-mix(in srgb, var(--glass) 88%, var(--bg1)); backdrop-filter: blur(14px);">
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Date</th>
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Type</th>
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Amount</th>
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Fee code</th>
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Link</th>
                  <th style="padding: 14px 16px; text-align: left; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Description</th>
                  <th style="padding: 14px 16px; text-align: center; font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); font-weight: 950;">Action</th>
                </tr>
              </thead>
              <tbody id="feesTableBody">
                <tr style="border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);">
                  <td style="padding: 14px 16px;">19 februarie 2026</td>
                  <td style="padding: 14px 16px;">
                    <span style="display: inline-block; padding: 4px 10px; background: rgba(245, 158, 11, 0.15); color: #f59e0b; border-radius: 999px; font-size: 12px; font-weight: 700;">TOPUP</span>
                  </td>
                  <td style="padding: 14px 16px; font-weight: 700;">USD 20.00</td>
                  <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--muted);">TOPUP_WIRE</td>
                  <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--info); font-size: 13px;">TOPUPTU-DEMO-1</td>
                  <td style="padding: 14px 16px; color: var(--muted);">Demo > Top-up fee</td>
                  <td style="padding: 14px 16px; text-align: center;">
                    <button class="btn ghost" style="padding: 6px 12px; font-size: 13px;">Details</button>
                  </td>
                </tr>
                <tr style="border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);">
                  <td style="padding: 14px 16px;">19 februarie 2026</td>
                  <td style="padding: 14px 16px;">
                    <span style="display: inline-block; padding: 4px 10px; background: rgba(22, 163, 74, 0.15); color: #16a34a; border-radius: 999px; font-size: 12px; font-weight: 700;">TRANSFER</span>
                  </td>
                  <td style="padding: 14px 16px; font-weight: 700;">USD 5.00</td>
                  <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--muted);">TRANSFER_MAIN_TO_VAULT</td>
                  <td style="padding: 14px 16px; font-family: 'Courier New', monospace; color: var(--info); font-size: 13px;">TRANSFERTR-DEMO-1</td>
                  <td style="padding: 14px 16px; color: var(--muted);">Demo > Transfer fee</td>
                  <td style="padding: 14px 16px; text-align: center;">
                    <button class="btn ghost" style="padding: 6px 12px; font-size: 13px;">Details</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="mini-hint" style="margin-top: 1rem;">
            To be clear: internal transactions are the main audit log. These additions and data lookups are derived from them. If there's a discrepancy, the internal transactions are the source of truth.
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Internal Transaction Details Modal -->
  <div id="internalTxDetailsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; backdrop-filter: blur(4px);" onclick="closeInternalTxDetails()">
    <div id="internalTxDetailsPanel" style="position: absolute; top: 0; right: -500px; width: 500px; height: 100%; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); transition: right 0.3s ease; overflow-y: auto;" onclick="event.stopPropagation()">
      
      <!-- Header -->
      <div style="padding: 2rem; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 id="internalTxModalTitle" style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">Internal Tx • [ID]</h3>
          <button onclick="closeInternalTxDetails()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.15s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">×</button>
        </div>
      </div>

      <!-- Details Grid -->
      <div style="padding: 2rem;">
        <div style="display: grid; grid-template-columns: 140px 1fr; gap: 1.25rem; font-size: 0.95rem;">
          
          <div style="color: #6b7280; font-weight: 500;">Created</div>
          <div id="txDetail_created" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Category</div>
          <div id="txDetail_category" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Amount</div>
          <div id="txDetail_amount" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">From</div>
          <div id="txDetail_from" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">To</div>
          <div id="txDetail_to" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Link</div>
          <div id="txDetail_link" style="color: #1f2937; font-weight: 600; text-align: right; font-family: monospace; font-size: 0.9rem;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Client</div>
          <div id="txDetail_client" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Fee code</div>
          <div id="txDetail_feeCode" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Description</div>
          <div id="txDetail_description" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

        </div>
      </div>

    </div>
  </div>

  <!-- Ledger Modal -->
  <div class="modal-simple" id="ledgerModal">
    <div class="modal-simple-content">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
          <h2 style="margin:0;">Ledger (Filtered)</h2>
          <div class="mini-hint">Același filtru global (client/date) + tab selection (All/Topups/Fees/Internal).</div>
        </div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="closeLedgerModal()">Close</button>
        </div>
      </div>

      <div style="max-height: 62vh; overflow:auto; border:1px solid #eee; border-radius: 10px; padding: .25rem .25rem 0 .25rem; margin-top:.75rem;">
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>From → To</th>
              <th>Client</th>
              <th>Platform</th>
              <th>Category</th>
              <th>Note</th>
              <th style="text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="ledgerAllBody"></tbody>
        </table>
      </div>

      <div class="split">
        <div class="muted" id="ledgerTotalsHint"></div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ NEW: Topup Details Modal -->
  <div class="tx-modal" id="topupDetailsModal" aria-hidden="true">
    <div class="tx-modal__overlay" onclick="closeTopupDetails()"></div>

    <div class="tx-modal__panel" role="dialog" aria-modal="true" aria-label="Topup Details">
      <div class="tx-modal__header">
        <h3>Top-Up Details</h3>
        <button class="tx-close" onclick="closeTopupDetails()" aria-label="Close">×</button>
      </div>

      <div class="tx-modal__body">
        <div class="kv-card" id="topupKvCard"></div>

        <div style="margin-top:.25rem;">
          <div class="kv-key" style="margin-bottom:.35rem;">Status</div>
          <div class="segmented-status" id="topupStatusSeg">
            <div class="seg-pill" data-status="pending" onclick="setTopupModalStatus('pending')">Pending</div>
            <div class="seg-pill" data-status="approved" onclick="setTopupModalStatus('approved')">Approved</div>
            <div class="seg-pill" data-status="declined" onclick="setTopupModalStatus('declined')">Declined</div>
            <div class="seg-pill" data-status="past_due" onclick="setTopupModalStatus('past_due')">Past Due</div>
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="topupModalDesc" rows="3" placeholder="--"></textarea>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" id="topupModalDate">
        </div>
      </div>

      <div class="modal-footer">
        <button class="transfer-btn secondary" onclick="saveTopupDetails()">Save Changes</button>
        <button class="transfer-btn gray" onclick="closeTopupDetails()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- RIGHT DRAWER: Add Topup -->
  <div class="drawer" id="topupDrawer" aria-hidden="true">
    <div class="drawer__overlay" onclick="closeTopupDrawer()"></div>

    <div class="drawer__panel" role="dialog" aria-modal="true" aria-label="Add Top-Up">
      <div class="drawer__header">
        <h3 class="drawer__title">Add Top-Up</h3>
        <button class="drawer__close" onclick="closeTopupDrawer()" aria-label="Close">×</button>
      </div>

      <div class="drawer__body">
        <div class="form-group">
          <label>Client</label>
          <select id="topup_client">
            <option value="100">100 - Alex</option>
            <option value="101">101 - Maria</option>
            <option value="102">102 - John</option>
          </select>
        </div>

        <div class="segmented" id="topupTabs">
          <button class="seg-btn active" data-tab="wire" onclick="switchTopupTab('wire')">Wire</button>
          <button class="seg-btn" data-tab="crypto" onclick="switchTopupTab('crypto')">Crypto</button>
          <button class="seg-btn" data-tab="refund" onclick="switchTopupTab('refund')">Refund</button>
        </div>

        <!-- WIRE -->
        <div id="tab_wire">
          <div class="form-group">
            <label>Company</label>
            <input id="wire_company" type="text" placeholder="e.g. Wise / Revolut / Bank" />
          </div>

          <div class="form-group">
            <label>Account</label>
            <select id="wire_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="wire_gross" type="number" min="0" step="0.01" placeholder="e.g. 1000" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Fee</label>
            <input id="wire_fee" type="number" min="0" step="0.01" placeholder="e.g. 10" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="wire_net" type="number" min="0" step="0.01" placeholder="auto" readonly />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="wire_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="wire_invoice" type="file" accept="application/pdf" />
          </div>

          <div class="notice-box">
            Minimum deposit: $500<br />
            Make sure the full amount arrives without fee deductions.
          </div>
        </div>

        <!-- CRYPTO -->
        <div id="tab_crypto" style="display:none;">
          <div class="form-group">
            <label>Method</label>
            <select id="crypto_method">
              <option value="">Select</option>
              <option value="USDT">USDT</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="crypto_net" type="number" min="0" step="0.01" placeholder="e.g. 500" />
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="crypto_gross" type="number" min="0" step="0.01" placeholder="optional" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="crypto_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="mini-hint" id="crypto_fee_hint">Fee: 0.00</div>

          <div class="form-group">
            <label>Wallet</label>
            <select id="crypto_network">
              <option value="">select network</option>
              <option value="ERC20">ERC20</option>
              <option value="TRC20">TRC20</option>
              <option value="BEP20">BEP20</option>
            </select>
          </div>

          <div class="form-group">
            <label>Hash</label>
            <input id="crypto_hash" type="text" placeholder="Transaction hash" />
          </div>
        </div>

        <!-- SPECIAL (kept, but not exposed in tabs - if you want it later, add button back) -->
        <div id="tab_special" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="special_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="special_net" type="number" min="0" step="0.01" placeholder="e.g. 750" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="special_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="special_invoice" type="file" accept="application/pdf" />
          </div>
        </div>

        <!-- REFUND -->
        <div id="tab_refund" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="refund_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount (refund)</label>
            <input id="refund_net" type="number" min="0" step="0.01" placeholder="e.g. 120" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="refund_desc" type="text" placeholder="Refund reason / note" />
          </div>

          <div class="notice-box" style="background:#e7f5ff;border-color:#74c0fc;color:#0b4a6f;">
            Refund scade din Main Wallet (filtrat pe client).
          </div>
        </div>

      </div>

      <div class="drawer__footer">
        <button class="transfer-btn secondary" id="topupSubmitBtn" onclick="submitTopup()">Submit</button>
        <button class="transfer-btn gray" onclick="closeTopupDrawer()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="../js/sidebar.js"></script>
  <script>
    const LS_KEY = "admin_finance_demo_v7";

    const state = {
      ledger: [],
      platformFilter: "__all__",
      globalClient: "__all__",
      globalFrom: "",
      globalTo: "",
      ledgerTab: "all", // all | topups | fees | internal

      // ✅ NEW: topups status filter (only affects Topups table)
      topupsStatus: "__all__",

      // ✅ NEW: modal selection
      activeTopupModalId: null
    };

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }
    function nowISO(){ return new Date().toLocaleString(); }
    function uid(){ return Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getClientLabelById(id){
      const map = { "100":"100 - Alex", "101":"101 - Maria", "102":"102 - John" };
      return map[String(id)] || String(id);
    }

    function getClientNameById(id){
      const label = getClientLabelById(id);
      const parts = String(label).split(" - ");
      return parts[1] ? parts.slice(1).join(" - ").trim() : label;
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ seedDemo(); return; }
      try{
        const parsed = JSON.parse(raw);
        
        // Force refresh if old data
        if(!parsed.dataVersion || parsed.dataVersion < 2){
          seedDemo();
          return;
        }
        
        state.ledger = Array.isArray(parsed.ledger) ? parsed.ledger : [];
        state.platformFilter = parsed.platformFilter || "__all__";
        state.globalClient = parsed.globalClient || "__all__";
        state.globalFrom = parsed.globalFrom || "";
        state.globalTo = parsed.globalTo || "";
        state.ledgerTab = parsed.ledgerTab || "all";
        state.topupsStatus = parsed.topupsStatus || "__all__";
      }catch(e){ seedDemo(); }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        dataVersion: 2,
        ledger: state.ledger,
        platformFilter: state.platformFilter,
        globalClient: state.globalClient,
        globalFrom: state.globalFrom,
        globalTo: state.globalTo,
        ledgerTab: state.ledgerTab,
        topupsStatus: state.topupsStatus
      }));
    }

    function seedDemo(){
      state.ledger = [
        // ✅ Topups for Topups table
        {
          id: uid(),
          topupId: "100147",
          date: "19 februarie 2026",
          type:"topup",
          clientId:"100",
          from:"external",
          to:"mainWallet",
          platform:"",
          category:"topup",
          status:"approved",
          account:"USD",
          proof:"—",
          description:"Demo • Top-up approved (net USD) to Main Wallet",
          grossAmount: 980.00,
          feeAmount: 0,
          netAmount: 980.00,
          note:"Demo • Top-up approved (net USD) to Main Wallet",
          amount: 980.00
        },
        {
          id: uid(),
          topupId: "100148",
          date: "19 februarie 2026",
          type:"fee",
          clientId:"100",
          from:"topup",
          to:"feesCollected",
          platform:"",
          category:"topup_fee",
          status:"approved",
          account:"USD",
          proof:"—",
          description:"Demo • Top-up fee",
          grossAmount: 20.00,
          feeAmount: 20.00,
          netAmount: 20.00,
          note:"Demo • Top-up fee",
          amount: 20.00
        },
        {
          id: uid(),
          topupId: "100149",
          date: "19 februarie 2026",
          type:"transfer",
          clientId:"100",
          from:"mainWallet",
          to:"platformVault",
          platform:"FACEBOOK",
          category:"transfer",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • Main → FB Vault",
          grossAmount: 400.00,
          feeAmount: 0,
          netAmount: 400.00,
          note:"Demo • Main → FB Vault",
          amount: 400.00
        },
        {
          id: uid(),
          date: "19 februarie 2026",
          type:"fee",
          clientId:"100",
          from:"mainWallet",
          to:"feesCollected",
          platform:"",
          category:"transfer_fee",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • Transfer fee",
          grossAmount: 5.00,
          feeAmount: 5.00,
          netAmount: 5.00,
          note:"Demo • Transfer fee",
          amount: 5.00
        },
        {
          id: uid(),
          date: "19 februarie 2026",
          type:"allocation",
          clientId:"100",
          from:"platformVault",
          to:"generalBalance",
          platform:"FACEBOOK",
          category:"allocation",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • FB Vault → FB General",
          grossAmount: 250.00,
          feeAmount: 0,
          netAmount: 250.00,
          note:"Demo • FB Vault → FB General",
          amount: 250.00
        },
        {
          id: uid(),
          date: "19 februarie 2026",
          type:"allocation",
          clientId:"100",
          from:"platformVault",
          to:"individualBalance",
          platform:"GOOGLE",
          category:"allocation",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • Google Vault → Google Individual (c1)",
          grossAmount: 120.00,
          feeAmount: 0,
          netAmount: 120.00,
          note:"Demo • Google Vault → Google Individual (c1)",
          amount: 120.00
        },

        // Additional transactions for other pages
        { id: uid(), date: "1/26/2024, 09:00:00 AM", type:"deposit", clientId:"100", from:"external", to:"mainWallet", platform:"", category:"deposit", note:"Initial funding into Main Wallet", amount: 5000 },
        { id: uid(), date: "2/01/2024, 09:16:05 AM", type:"transfer", clientId:"100", from:"mainWallet", to:"platformVault", platform:"facebook", category:"spend", note:"Funding Facebook vault", amount: 700 },
        { id: uid(), date: "2/02/2024, 10:10:00 AM", type:"transfer", clientId:"100", from:"mainWallet", to:"platformVault", platform:"google", category:"spend", note:"Funding Google vault", amount: 300 }
      ];
      state.platformFilter = "__all__";
      state.globalClient = "__all__";
      state.globalFrom = "";
      state.globalTo = "";
      state.ledgerTab = "all";
      state.topupsStatus = "__all__";
      save();
      refreshAll();
    }

    function addLedger(entry){
      state.ledger.unshift(entry);
      save();
      refreshAll();
    }

    /* DATE filter helper */
    function txDateToISO(txDateString){
      const d = new Date(txDateString);
      if(isNaN(d.getTime())) return null;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function passesGlobalFilters(tx){
      if(state.globalClient !== "__all__"){
        if(String(tx.clientId || "") !== String(state.globalClient)) return false;
      }
      const iso = txDateToISO(tx.date);
      if(iso){
        if(state.globalFrom && iso < state.globalFrom) return false;
        if(state.globalTo && iso > state.globalTo) return false;
      }
      return true;
    }

    function matchesLedgerTab(tx){
      const t = state.ledgerTab;
      if(t === "all") return true;
      if(t === "topups") return tx.type === "topup" || tx.type === "deposit" || tx.to === "topups";
      if(t === "fees") return tx.type === "fee" || tx.to === "feesCollected";
      return ["transfer","allocation","ind_to_account","setup_service","refund"].includes(tx.type);
    }

    function getFilteredLedger(){
      return state.ledger.filter(tx => passesGlobalFilters(tx) && matchesLedgerTab(tx));
    }

    function onGlobalFiltersChanged(){
      state.globalClient = document.getElementById("global_client").value;
      state.globalFrom = document.getElementById("global_from").value;
      state.globalTo = document.getElementById("global_to").value;
      save();
      refreshAll();
    }

    function onTopupsStatusChanged(){
      state.topupsStatus = document.getElementById("topups_status").value;
      save();
      renderTopupsTable();
      populateGlobalClientFilter(); // refresh hint text
    }

    function clearGlobalFilters(){
      state.globalClient = "__all__";
      state.globalFrom = "";
      state.globalTo = "";
      state.topupsStatus = "__all__";
      document.getElementById("global_client").value = "__all__";
      document.getElementById("global_from").value = "";
      document.getElementById("global_to").value = "";
      document.getElementById("topups_status").value = "__all__";
      save();
      refreshAll();
    }

    function setValueIfExists(id, value){
  const el = document.getElementById(id);
  if(el) el.value = value ?? "";
}

function populateGlobalClientFilter(){
  const clientIds = new Set(["100","101","102"]);
  for(const tx of state.ledger){
    if(tx.clientId) clientIds.add(String(tx.clientId));
  }

  const sel = document.getElementById("global_client");
  const current = state.globalClient || "__all__";

  sel.innerHTML =
    `<option value="__all__">All clients</option>` +
    [...clientIds].sort().map(cid =>
      `<option value="${cid}">${escapeHtml(getClientLabelById(cid))}</option>`
    ).join("");

  sel.value = current;

  // ✅ SAFE setters (nu mai aruncă TypeError dacă lipsește elementul)
  setValueIfExists("global_from", state.globalFrom || "");
  setValueIfExists("global_to", state.globalTo || "");
  setValueIfExists("topups_status", state.topupsStatus || "__all__"); // <- dacă e comentat, nu crapă

  const hint = document.getElementById("global_hint");
  const clientText = current === "__all__" ? "All clients" : getClientLabelById(current);
  const rangeText = (state.globalFrom || state.globalTo)
    ? `${state.globalFrom || "…"} → ${state.globalTo || "…"}`
    : "All dates";
  const stText = (state.topupsStatus === "__all__") ? "All statuses" : state.topupsStatus.toUpperCase();

  hint.textContent =
    `Current view: ${clientText} • ${rangeText} • Topups Status: ${stText} • Ledger Tab: ${state.ledgerTab.toUpperCase()}`;
}


    /* KPIs - based on FULL filtered by client/date ONLY */
    function getLedgerFilteredForKPIs(){
      return state.ledger.filter(passesGlobalFilters);
    }

    function calcKpis(){
      const ledger = getLedgerFilteredForKPIs();
      const out = {
        totalTopups: 0,
        mainWallet: 0,
        platformVault: { facebook:0, google:0, tiktok:0 },
        generalBalance: 0,
        individualBalance: 0,
        spend: 0,
        setupServices: 0,
        totalFees: 0
      };

      for(const tx of ledger){
        const amt = Number(tx.amount || 0);

        if(tx.type === "topup") out.totalTopups += amt;

        if(tx.to === "mainWallet") out.mainWallet += amt;
        if(tx.from === "mainWallet") out.mainWallet -= amt;

        if(tx.type === "transfer" && tx.from === "mainWallet" && tx.to === "platformVault"){
          out.spend += amt;
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] += amt;
        }

        if(tx.type === "allocation" && tx.from === "platformVault"){
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] -= amt;
          if(tx.to === "generalBalance") out.generalBalance += amt;
          if(tx.to === "individualBalance") out.individualBalance += amt;
        }

        if(tx.type === "ind_to_account" && tx.from === "individualBalance"){
          out.individualBalance -= amt;
        }

        if(tx.type === "setup_service" && tx.to === "setupServices"){
          out.setupServices += amt;
        }

        if(tx.to === "feesCollected"){
          out.totalFees += amt;
        }
      }
      return out;
    }

    function refreshKPIs(){
      const k = calcKpis();

      document.getElementById("kpi_totalTopups").textContent = money(k.totalTopups);
      document.getElementById("kpi_mainWallet").textContent = money(k.mainWallet);

      const pf = state.platformFilter;
      const vaultTotal = pf === "__all__"
        ? (k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok)
        : (k.platformVault[pf] || 0);

      document.getElementById("kpi_platformVault").textContent = money(vaultTotal);
      document.getElementById("kpi_generalBalance").textContent = money(k.generalBalance);
      document.getElementById("kpi_individualBalance").textContent = money(k.individualBalance);
      document.getElementById("kpi_spend").textContent = money(k.spend);
      document.getElementById("kpi_totalFees").textContent = money(k.totalFees);
      document.getElementById("kpi_setupServices").textContent = money(k.setupServices);

      document.getElementById("kpi_platformFilter").value = state.platformFilter;
    }

    document.getElementById("kpi_platformFilter").addEventListener("change", (e) => {
      state.platformFilter = e.target.value;
      save();
      refreshKPIs();
    });

    /* ✅ NEW: TOPUPS TABLE (client/date + status) */
    function passesTopupsStatusFilter(tx){
      if(state.topupsStatus === "__all__") return true;
      return String(tx.status || "").toLowerCase() === String(state.topupsStatus).toLowerCase();
    }

    function renderTopupsTable(){
      const topups = getLedgerFilteredForKPIs()
        .filter(tx => tx.type === "topup")
        .filter(passesTopupsStatusFilter)
        .slice()
        .sort((a,b) => (new Date(b.date)).getTime() - (new Date(a.date)).getTime());

      const body = document.getElementById("topupsTableBody");
      const hint = document.getElementById("topupsTableHint");

      if(!topups.length){
        body.innerHTML = `<tr><td colspan="7" class="td-muted">No topups found for current filters.</td></tr>`;
        hint.textContent = "";
        return;
      }

      body.innerHTML = topups.map(t => {
        const proof = t.proof ? escapeHtml(t.proof) : "-";
        const account = t.account ? escapeHtml(t.account) : "USD";
        const st = String(t.status || "pending").toLowerCase();
        const stLabel = st === "past_due" ? "Past Due" : (st.charAt(0).toUpperCase() + st.slice(1));
        const desc = (t.description && String(t.description).trim()) ? escapeHtml(t.description) : (t.note ? escapeHtml(t.note) : "--");

        return `
          <tr class="topups-row" onclick="openTopupDetails('${escapeHtml(t.id)}')">
            <td>${escapeHtml(t.date)}</td>
            <td>${escapeHtml(t.clientId || "")}</td>
            <td>${account}</td>
            <td class="td-muted">${proof}</td>
            <td class="td-right"><strong>${money(t.amount)}</strong></td>
            <td><span class="status-badge ${st}">${stLabel}</span></td>
            <td class="td-muted" style="max-width: 360px; overflow:hidden; text-overflow:ellipsis;">${desc}</td>
          </tr>
        `;
      }).join("");

      hint.textContent = `Showing ${topups.length} topups • Filtered by client/date + status. Click a row for details.`;
    }

    /* LEDGER PREVIEW (tabbed) */
    function buildShortDetails(tx){
      if(tx.type === "topup") return `${escapeHtml(tx.note || "Topup")} <span class="muted">(informative)</span>`;
      if(tx.type === "deposit") return `Deposit → <span class="muted">Main Wallet</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "fee") return `Fee → <span class="muted">Total Fees</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "refund") return `Refund → <span class="muted">External</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "transfer") return `Main → Vault(${escapeHtml(tx.platform || "")}) • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "allocation") return `Vault(${escapeHtml(tx.platform || "")}) → ${escapeHtml(tx.to)} • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "ind_to_account") return `Individual → <span class="muted">${escapeHtml(tx.to || "")}</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "setup_service") return `Main → Setup/Services • ${escapeHtml(tx.note || "")}`;
      return `${escapeHtml(tx.type)} • ${escapeHtml(tx.note || "")}`;
    }

    function refreshLedgerPreview(){
      const body = document.getElementById("ledgerPreviewBody");
      const preview = getFilteredLedger().slice(0, 8);

      body.innerHTML = preview.map(tx => {
        const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
        const tags = [
          `<span class="tag">${escapeHtml(tx.type.toUpperCase())}</span>`,
          tx.platform ? `<span class="tag">${escapeHtml(tx.platform)}</span>` : ""
        ].join(" ");

        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${tags}</td>
            <td>${buildShortDetails(tx)}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("ledgerHint").textContent =
        `Showing latest ${preview.length} entries • Filtered by global client/date • Tab: ${state.ledgerTab.toUpperCase()}`;
    }

    function refreshLedgerModal(){
      const body = document.getElementById("ledgerAllBody");
      const ledger = getFilteredLedger();
      const k = calcKpis();

      body.innerHTML = ledger.map(tx => {
        const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${escapeHtml(tx.type)}</td>
            <td>${escapeHtml((tx.from||"—") + " → " + (tx.to||"—"))}</td>
            <td>${escapeHtml(getClientLabelById(tx.clientId || "—"))}</td>
            <td>${escapeHtml(tx.platform || "—")}</td>
            <td>${escapeHtml(tx.category || "—")}</td>
            <td>${escapeHtml(tx.note || "")}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      const vaultTotal = k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok;
      document.getElementById("ledgerTotalsHint").textContent =
        `MainWallet: ${money(k.mainWallet)} • VaultTotal: ${money(vaultTotal)} • General: ${money(k.generalBalance)} • Individual: ${money(k.individualBalance)} • Spend: ${money(k.spend)} • Fees: ${money(k.totalFees)} • Setup/Services: ${money(k.setupServices)} • TotalTopups: ${money(k.totalTopups)}`;
    }

    function openLedgerModal(){ refreshLedgerModal(); document.getElementById("ledgerModal").classList.add("active"); }
    function closeLedgerModal(){ document.getElementById("ledgerModal").classList.remove("active"); }

    /* WORKSPACE tabs (Funding / Setup) */
    document.getElementById("workspaceTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#workspaceTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const tab = pill.getAttribute("data-tab");
      document.getElementById("tab_funding").style.display = tab === "funding" ? "block" : "none";
      document.getElementById("tab_setup").style.display = tab === "setup" ? "block" : "none";
      document.getElementById("tab_fees").style.display = tab === "fees" ? "block" : "none";
    });

    /* FUNDING SUBTABS */
    document.getElementById("fundingSubTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#fundingSubTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const subtab = pill.getAttribute("data-subtab");
      document.getElementById("subtab_main_to_vault").style.display = subtab === "main_to_vault" ? "block" : "none";
      document.getElementById("subtab_vault_allocate").style.display = subtab === "vault_allocate" ? "block" : "none";
      document.getElementById("subtab_individual_to_account").style.display = subtab === "individual_to_account" ? "block" : "none";
    });

    /* LEDGER TABS */
    function setLedgerTab(tab){
      state.ledgerTab = tab;
      save();
      document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
      document.querySelector(`#ledgerTabs .pill[data-ledger="${tab}"]`)?.classList.add("active");
      refreshAll();
    }

    document.getElementById("ledgerTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;
      setLedgerTab(pill.getAttribute("data-ledger"));
    });

    /* ACTION GUARD */
    function requireSpecificClient(){
      if(state.globalClient === "__all__"){
        alert("Select a specific client first (not 'All clients') to perform actions.");
        return false;
      }
      return true;
    }

    /* FUNDING / ALLOCATION / INDIVIDUAL SEND */
    function refreshFundingUI(){
      const k = calcKpis();
      document.getElementById("tx_fromHint").textContent =
        `Available in Main Wallet (filtered view): ${money(k.mainWallet)}`;

      toggleAllocAccountSelect();
      updateFundingPreview();
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateFundingPreview(){
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();
      const clientText = state.globalClient === "__all__" ? "All clients" : getClientLabelById(state.globalClient);

      document.getElementById("tx_preview").textContent =
        `Client: ${clientText} • Send ${money(amount)} Main → Vault (${platform})${note ? " • " + note : ""}`;
    }

    function submitMainToVault(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }
      if(amount > k.mainWallet){
        alert(`Not enough funds in Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "transfer",
        clientId: String(state.globalClient),
        from: "mainWallet",
        to: "platformVault",
        platform,
        category: "spend",
        note: note || `Funding ${platform} vault`,
        amount
      });

      document.getElementById("tx_amount").value = "";
      document.getElementById("tx_note").value = "";
      updateFundingPreview();
    }

    function toggleAllocAccountSelect(){
      const to = document.getElementById("alloc_to").value;
      document.getElementById("alloc_accountGroup").style.display = (to === "account") ? "block" : "none";
    }

    function updateAllocationPreview(){
      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const account = document.getElementById("alloc_account").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      const available = k.platformVault[platform] || 0;
      document.getElementById("alloc_platformHint").textContent = `Available in ${platform} vault (filtered): ${money(available)}`;

      const targetText = (to === "account") ? `Account (${account})` : to;
      document.getElementById("alloc_preview").textContent =
        `Allocate ${money(amount)} Vault(${platform}) → ${targetText}${note ? " • " + note : ""}`;
    }

    function submitAllocation(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const account = document.getElementById("alloc_account").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }

      const available = k.platformVault[platform] || 0;
      if(amount > available){
        alert(`Not enough funds in ${platform} vault (filtered). Available: ${money(available)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "allocation",
        clientId: String(state.globalClient),
        from: "platformVault",
        to: to,
        platform,
        category: to === "generalBalance" ? "budget_general"
                : to === "individualBalance" ? "budget_individual"
                : "budget_account",
        note: (to === "account" ? `Account: ${account}` : "") + (note ? (" • " + note) : ""),
        amount
      });

      document.getElementById("alloc_amount").value = "";
      document.getElementById("alloc_note").value = "";
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateIndToAccountPreview(){
      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      document.getElementById("ind_fromHint").textContent =
        `Available in Individual Balance (filtered): ${money(k.individualBalance)}`;

      const clientText = state.globalClient === "__all__" ? "All clients" : getClientLabelById(state.globalClient);
      document.getElementById("ind_preview").textContent =
        `Client: ${clientText} • Send ${money(amount)} Individual → ${account}${note ? " • " + note : ""}`;
    }

    function submitIndividualToAccount(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      if(!amount || amount <= 0){
        alert("Please enter a valid amount.");
        return;
      }

      if(amount > k.individualBalance){
        alert(`Not enough funds in Individual Balance (filtered). Available: ${money(k.individualBalance)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "ind_to_account",
        clientId: String(state.globalClient),
        from: "individualBalance",
        to: `account:${account}`,
        platform: "",
        category: "ind_to_account",
        note: note || `Assign to ${account}`,
        amount
      });

      document.getElementById("ind_amount").value = "";
      document.getElementById("ind_note").value = "";
      updateIndToAccountPreview();
    }

    function submitSetupServiceCharge(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const type = document.getElementById("charge_type").value;
      const model = document.getElementById("charge_model").value;
      const linked = document.getElementById("charge_linked").value;
      const amount = Number(document.getElementById("charge_amount").value || 0);
      const details = (document.getElementById("charge_details").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }
      if(amount > k.mainWallet){
        alert(`Not enough funds in Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
        return;
      }

      const title = type === "setup" ? "Setup" : "Service";
      const note = `Account: ${linked} | ${model} - ${title}${details ? " | " + details : ""}`;

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "setup_service",
        clientId: String(state.globalClient),
        from: "mainWallet",
        to: "setupServices",
        platform: "",
        category: type,
        note,
        amount
      });

      document.getElementById("charge_amount").value = "";
      document.getElementById("charge_details").value = "";
    }

    function openAddServiceFeeModal(){
      alert("Add Service Fee modal - to be implemented");
      // This would open a modal similar to Add Topup
      // For now, just showing an alert
    }

    /* Render Fees Page */
    function renderFeesPage(){
      // For now, just show the static content
      // In the future, this could dynamically populate fees from state.ledger
      console.log("Fees page rendered");
    }

    /* Add Topup Drawer logic */
    let activeTopupTab = "wire";

    function openTopupDrawer(){
      document.getElementById("topupDrawer").classList.add("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "false");

      if(state.globalClient !== "__all__"){
        document.getElementById("topup_client").value = String(state.globalClient);
      }
      recalcWireNet();
      validateTopupForm();
    }
    function closeTopupDrawer(){
      document.getElementById("topupDrawer").classList.remove("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "true");
    }

    function switchTopupTab(tab){
      activeTopupTab = tab;

      document.querySelectorAll("#topupTabs .seg-btn").forEach(b => b.classList.remove("active"));
      document.querySelector(`#topupTabs .seg-btn[data-tab="${tab}"]`).classList.add("active");

      document.getElementById("tab_wire").style.display = tab === "wire" ? "block" : "none";
      document.getElementById("tab_crypto").style.display = tab === "crypto" ? "block" : "none";
      document.getElementById("tab_special").style.display = tab === "special" ? "block" : "none";
      document.getElementById("tab_refund").style.display = tab === "refund" ? "block" : "none";

      validateTopupForm();
    }

    function recalcWireNet(){
      const gross = Number(document.getElementById("wire_gross").value || 0);
      const fee = Number(document.getElementById("wire_fee").value || 0);
      const net = Math.max(0, +(gross - fee).toFixed(2));
      document.getElementById("wire_net").value = net ? net : "";
      validateTopupForm();
    }

    function validateTopupForm(){
      const btn = document.getElementById("topupSubmitBtn");
      let ok = true;

      if(activeTopupTab === "wire"){
        const account = document.getElementById("wire_account").value;
        const net = Number(document.getElementById("wire_net").value || 0);
        ok = !!account && net > 0;
      }
      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();
        ok = !!method && net > 0 && !!network && !!hash;
      }
      if(activeTopupTab === "special"){
        const net = Number(document.getElementById("special_net").value || 0);
        ok = net > 0;
      }
      if(activeTopupTab === "refund"){
        const net = Number(document.getElementById("refund_net").value || 0);
        ok = net > 0;
      }

      btn.classList.toggle("btn-disabled", !ok);
    }

    ["crypto_method","crypto_net","crypto_network","crypto_hash","special_net","refund_net","wire_account","wire_gross","wire_fee"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input", validateTopupForm);
        el.addEventListener("change", validateTopupForm);
      }
    });

    function submitTopup(){
      validateTopupForm();
      const btn = document.getElementById("topupSubmitBtn");
      if(btn.classList.contains("btn-disabled")) return;

      const clientId = document.getElementById("topup_client").value;

      function nextTopupId(){
        // simple demo topupId generator
        const base = 100100;
        const count = state.ledger.filter(x => x.type === "topup").length;
        return String(base + count + 1);
      }

      function addTopupDepositAndFee({ topupAmount, netAmount, feeAmount, category, note, proof, account, description, grossAmount }){
        const topupId = nextTopupId();

        addLedger({
          id: uid(),
          topupId,
          date: nowISO(),
          type: "topup",
          clientId,
          from: "external",
          to: "topups",
          platform: "",
          category,
          status: "pending",           // ✅ default, editable in modal
          account: account || "USD",
          proof: proof || "-",
          description: description || "--",
          grossAmount: Number(grossAmount || topupAmount || 0),
          feeAmount: Number(feeAmount || 0),
          netAmount: Number(netAmount || topupAmount || 0),
          note: note || "Topup",
          amount: Number(topupAmount)
        });

        addLedger({
          id: uid(),
          date: nowISO(),
          type: "deposit",
          clientId,
          from: "external",
          to: "mainWallet",
          platform: "",
          category: "deposit",
          note: `Topup credited to Main Wallet (${category})`,
          amount: Number(netAmount)
        });

        const f = Number(feeAmount || 0);
        if(f > 0){
          addLedger({
            id: uid(),
            date: nowISO(),
            type: "fee",
            clientId,
            from: "",
            to: "feesCollected",
            platform: "",
            category: category + "_fee",
            note: `Fee collected (${category})`,
            amount: f
          });
        }
      }

      if(activeTopupTab === "wire"){
        const company = (document.getElementById("wire_company").value || "").trim();
        const accountSel = document.getElementById("wire_account").value;
        const gross = Number(document.getElementById("wire_gross").value || 0);
        const fee = Number(document.getElementById("wire_fee").value || 0);
        const net = Number(document.getElementById("wire_net").value || 0);
        const desc = (document.getElementById("wire_desc").value || "").trim();
        const invoice = document.getElementById("wire_invoice").files?.[0]?.name || "";

        addTopupDepositAndFee({
          topupAmount: net,
          netAmount: net,
          feeAmount: fee,
          grossAmount: gross || net,
          category: "wire",
          account: "USD",
          proof: invoice || "-",
          description: desc || "--",
          note: `Client ${getClientLabelById(clientId)} | Wire${company ? " | " + company : ""} | Account: ${accountSel} | Gross: ${gross || net}`
        });

        document.getElementById("wire_company").value = "";
        document.getElementById("wire_account").value = "";
        document.getElementById("wire_gross").value = "";
        document.getElementById("wire_fee").value = "";
        document.getElementById("wire_net").value = "";
        document.getElementById("wire_desc").value = "";
        document.getElementById("wire_invoice").value = "";
      }

      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const gross = Number(document.getElementById("crypto_gross").value || 0);
        const desc = (document.getElementById("crypto_desc").value || "").trim();
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();

        const fee = gross > 0 ? Math.max(0, +(gross - net).toFixed(2)) : 0;
        document.getElementById("crypto_fee_hint").textContent = "Fee: " + fee.toFixed(2);

        addTopupDepositAndFee({
          topupAmount: net,
          netAmount: net,
          feeAmount: fee,
          grossAmount: gross || net,
          category: "crypto",
          account: method || "USDT",
          proof: hash,
          description: desc || `${method || "Crypto"} ${network}`,
          note: `Client ${getClientLabelById(clientId)} | Crypto ${method} | ${network} | Hash: ${hash}`
        });

        document.getElementById("crypto_method").value = "";
        document.getElementById("crypto_net").value = "";
        document.getElementById("crypto_gross").value = "";
        document.getElementById("crypto_desc").value = "";
        document.getElementById("crypto_network").value = "";
        document.getElementById("crypto_hash").value = "";
        document.getElementById("crypto_fee_hint").textContent = "Fee: 0.00";
      }

      if(activeTopupTab === "refund"){
        const k = calcKpis();
        const net = Number(document.getElementById("refund_net").value || 0);
        const account = document.getElementById("refund_account").value;
        const desc = (document.getElementById("refund_desc").value || "").trim();

        if(net > k.mainWallet){
          alert(`Refund amount exceeds filtered Main Wallet. Available: ${money(k.mainWallet)}`);
          return;
        }

        addLedger({
          id: uid(),
          date: nowISO(),
          type: "refund",
          clientId,
          from: "mainWallet",
          to: "external",
          platform: "",
          category: "refund",
          note: `Client ${getClientLabelById(clientId)} | Refund${account ? " | Account: " + account : ""}${desc ? " | " + desc : ""}`,
          amount: net
        });

        document.getElementById("refund_account").value = "";
        document.getElementById("refund_net").value = "";
        document.getElementById("refund_desc").value = "";
      }

      closeTopupDrawer();
    }

    function exportLedgerJson(){
      const json = JSON.stringify({ ledger: state.ledger }, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "finance-ledger-demo.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    /* ✅ NEW: Topup details modal logic */
    function findTopupById(id){
      return state.ledger.find(tx => String(tx.id) === String(id));
    }

    function statusBadgeClass(st){
      const s = String(st || "pending").toLowerCase();
      if(s === "approved") return "approved";
      if(s === "declined") return "declined";
      if(s === "past_due") return "past_due";
      return "pending";
    }

    function formatDatetimeLocalFromTx(tx){
      const d = new Date(tx.date);
      if(isNaN(d.getTime())) return "";
      const pad = (n)=>String(n).padStart(2,"0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function openTopupDetails(id){
      const tx = findTopupById(id);
      if(!tx || tx.type !== "topup") return;

      state.activeTopupModalId = id;

      const kv = document.getElementById("topupKvCard");
      kv.innerHTML = `
        <div class="kv-row"><div class="kv-key">User ID:</div><div class="kv-val">${escapeHtml(tx.clientId || "")}</div></div>
        <div class="kv-row"><div class="kv-key">Top-Up ID:</div><div class="kv-val">${escapeHtml(tx.topupId || tx.id)}</div></div>
        <div class="kv-row"><div class="kv-key">Full Name:</div><div class="kv-val">${escapeHtml(getClientNameById(tx.clientId || ""))}</div></div>
        <div class="kv-row"><div class="kv-key">Gross Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.grossAmount ?? tx.amount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Fee Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.feeAmount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Net Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.netAmount ?? tx.amount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Account:</div><div class="kv-val">${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Type:</div><div class="kv-val">${escapeHtml(tx.category || "—")}</div></div>
      `;

      document.getElementById("topupModalDesc").value = (tx.description && String(tx.description).trim()) ? tx.description : (tx.note || "--");
      document.getElementById("topupModalDate").value = formatDatetimeLocalFromTx(tx);

      setTopupModalStatus(String(tx.status || "pending").toLowerCase(), true);

      document.getElementById("topupDetailsModal").classList.add("active");
      document.getElementById("topupDetailsModal").setAttribute("aria-hidden", "false");
    }

    function closeTopupDetails(){
      state.activeTopupModalId = null;
      document.getElementById("topupDetailsModal").classList.remove("active");
      document.getElementById("topupDetailsModal").setAttribute("aria-hidden", "true");
    }

    function setTopupModalStatus(status, silent){
      const st = String(status || "pending").toLowerCase();
      const seg = document.getElementById("topupStatusSeg");
      seg.querySelectorAll(".seg-pill").forEach(p => {
        p.classList.remove("active","pending","approved","declined","past_due");
      });

      const el = seg.querySelector(`.seg-pill[data-status="${st}"]`);
      if(el){
        el.classList.add("active", st);
      }

      if(!silent){
        const tx = findTopupById(state.activeTopupModalId);
        if(tx) tx.status = st;
      }
    }

    function saveTopupDetails(){
      const tx = findTopupById(state.activeTopupModalId);
      if(!tx) return;

      tx.description = (document.getElementById("topupModalDesc").value || "").trim() || "--";

      const dt = document.getElementById("topupModalDate").value;
      if(dt){
        const d = new Date(dt);
        if(!isNaN(d.getTime())){
          tx.date = d.toLocaleString();
        }
      }

      save();
      refreshAll();
      closeTopupDetails();
    }

    /* Boot */
    function refreshAll(){
      populateGlobalClientFilter();
      refreshKPIs();
      refreshFundingUI();
      renderTopupsTable();
      refreshLedgerPreview();

      if(document.getElementById("ledgerModal").classList.contains("active")){
        refreshLedgerModal();
      }
    }

    load();

    // init ledger tabs active state
    document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
    document.querySelector(`#ledgerTabs .pill[data-ledger="${state.ledgerTab}"]`)?.classList.add("active");

    refreshAll();

    /* ===============================
   PAGE TABS (Finance/Transactions/Ledger)
================================ */
state.activePage = state.activePage || "finance";

function setActivePage(page){
  state.activePage = page;
  save();

  // tabs UI
  document.querySelectorAll("#pageTabs .page-tab").forEach(b=>{
    const isOn = b.getAttribute("data-page") === page;
    b.classList.toggle("active", isOn);
    b.setAttribute("aria-selected", isOn ? "true" : "false");
  });

  // Handle default content (topups/finance view) vs page-specific sections
  const defaultPages = ["topups", "finance"];
  const isDefaultPage = defaultPages.includes(page);
  
  // Show/hide default content (global filters, KPIs, Finance Workspace, Ledger, Topups)
  const globalFilters = document.querySelector(".global-filters");
  const statistics = document.querySelector(".statistics");
  const widgetsGrid = document.querySelector(".widgets-grid");
  const topupsSection = document.querySelector(".topups-section");
  
  if(globalFilters) globalFilters.style.display = isDefaultPage ? "block" : "none";
  if(statistics) statistics.style.display = isDefaultPage ? "grid" : "none";
  if(widgetsGrid) widgetsGrid.style.display = isDefaultPage ? "grid" : "none";
  if(topupsSection) topupsSection.style.display = isDefaultPage ? "block" : "none";

  // Show/hide page-specific sections
  const pageSpecificSections = ["fees","transactions","ledger"];
  pageSpecificSections.forEach(p=>{
    const el = document.getElementById(`page_${p}`);
    if(el) el.style.display = (p === page) ? "block" : "none";
  });

  // subtitle
  const sub = document.getElementById("pageSubtitle");
  if(sub){
    sub.textContent =
      page === "topups" ? "Top-ups • Client Funding • Status Management"
      : page === "finance" ? "Overview • KPIs • Funding / Setup"
      : page === "fees" ? "Fee Management • Audit • Service Fees"
      : page === "transactions" ? "Transactions • Filters • Export"
      : "Ledger • Audit trail • Review";
  }

  // render page bodies
  if(page === "fees") renderFeesPage();
  if(page === "transactions") renderTransactionsPage();
  if(page === "ledger") renderLedgerPage();
}

document.getElementById("pageTabs").addEventListener("click", (e)=>{
  const btn = e.target.closest(".page-tab");
  if(!btn) return;
  setActivePage(btn.getAttribute("data-page"));
});

/* Render Transactions Page */
function renderTransactionsPage(){
  const body = document.getElementById("txPageBody");
  const hint = document.getElementById("txPageHint");
  if(!body) return;

  // Use global filters + show everything (or you can reuse matchesLedgerTab if you want)
  const rows = state.ledger
    .filter(passesGlobalFilters)
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date));

  if(!rows.length){
    body.innerHTML = `<tr><td colspan="8" class="td-muted">No transactions for current filters.</td></tr>`;
    if(hint) hint.textContent = "";
    return;
  }

  body.innerHTML = rows.map(tx=>{
    const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
    return `
      <tr>
        <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
        <td>${escapeHtml(tx.type)}</td>
        <td>${escapeHtml((tx.from||"—") + " → " + (tx.to||"—"))}</td>
        <td>${escapeHtml(getClientLabelById(tx.clientId || "—"))}</td>
        <td>${escapeHtml(tx.platform || "—")}</td>
        <td>${escapeHtml(tx.category || "—")}</td>
        <td>${escapeHtml(tx.note || tx.description || "")}</td>
        <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
      </tr>
    `;
  }).join("");

  if(hint) hint.textContent = `Showing ${rows.length} entries • Filtered by global client/date.`;
}

/* Render Internal Transactions Page */
function renderInternalTransactionsPage(){
  const body = document.getElementById("internalTxPageBody");
  if(!body) return;

  // Get all transactions and apply filters
  let rows = state.ledger
    .filter(passesGlobalFilters)
    .slice()
    .sort((a,b)=> new Date(b.date) - new Date(a.date));

  // Apply search filter
  const searchTerm = (document.getElementById("internalTx_search")?.value || "").toLowerCase();
  if(searchTerm){
    rows = rows.filter(tx => {
      const searchableText = [
        tx.id || "",
        tx.date || "",
        tx.note || "",
        tx.description || "",
        tx.from || "",
        tx.to || "",
        generateLinkId(tx)
      ].join(" ").toLowerCase();
      return searchableText.includes(searchTerm);
    });
  }

  // Apply category filter
  const categoryFilter = document.getElementById("internalTx_category")?.value || "__all__";
  if(categoryFilter !== "__all__"){
    rows = rows.filter(tx => {
      const cat = String(tx.category || tx.type || "").toLowerCase();
      
      if(categoryFilter === "topup_approval") return cat.includes("topup") && !cat.includes("fee");
      if(categoryFilter === "topup_fee") return cat.includes("topup") && cat.includes("fee");
      if(categoryFilter === "transfer") return cat.includes("transfer") && !cat.includes("fee");
      if(categoryFilter === "transfer_fee") return cat.includes("transfer") && cat.includes("fee");
      if(categoryFilter === "service_charge") return cat.includes("service");
      if(categoryFilter === "setup_charge") return cat.includes("setup");
      if(categoryFilter === "refund") return cat.includes("refund");
      if(categoryFilter === "other") return !cat.includes("topup") && !cat.includes("transfer") && !cat.includes("service") && !cat.includes("setup") && !cat.includes("refund");
      
      return cat.includes(categoryFilter);
    });
  }

  // Update count
  const countEl = document.getElementById("internalTxCount");
  if(countEl) countEl.textContent = rows.length;

  if(!rows.length){
    body.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 3rem; color: var(--muted);">No internal transactions found for current filters.</td></tr>`;
    return;
  }

  body.innerHTML = rows.map(tx=>{
    // Format category as badge (matching screenshot colors)
    const categoryBadge = getCategoryBadgeStyled(tx);
    
    // Generate link ID
    const linkId = generateLinkId(tx);
    
    // Format from/to with platform info
    let fromText = formatAccountName(tx.from || "—");
    let toText = formatAccountName(tx.to || "—");
    
    // Add platform info to vault names
    if(tx.platform && fromText === "Platform Vault"){
      fromText = `Platform Vault:${tx.platform.toUpperCase()}`;
    }
    if(tx.platform && toText === "Platform Vault"){
      toText = `Platform Vault:${tx.platform.toUpperCase()}`;
    }
    
    // Add platform info to balance names
    if(tx.platform && toText === "General Balance"){
      toText = `General Balance:${tx.platform.toUpperCase()}`;
    }
    if(tx.platform && toText === "Individual Balance"){
      toText = `Individual Balance:${tx.platform.toUpperCase()}`;
    }
    
    // Format amount with currency
    const amountFormatted = `USD ${Number(tx.amount || 0).toFixed(2)}`;
    
    return `
      <tr style="border-bottom: 1px solid var(--line2);">
        <td style="padding: 12px 16px; white-space: nowrap; color: var(--text);">${escapeHtml(tx.date)}</td>
        <td style="padding: 12px 16px;">${categoryBadge}</td>
        <td style="padding: 12px 16px; color: var(--text);">${amountFormatted}</td>
        <td style="padding: 12px 16px; color: var(--text);">${escapeHtml(fromText)}</td>
        <td style="padding: 12px 16px; color: var(--text);">${escapeHtml(toText)}</td>
        <td style="padding: 12px 16px; font-family: monospace; font-size: 0.85rem; color: var(--muted);">${escapeHtml(linkId)}</td>
        <td style="padding: 12px 16px; color: var(--text); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(tx.note || tx.description || "—")}</td>
        <td style="padding: 12px 16px; text-align: center;">
          <button 
            onclick="viewInternalTxDetails('${escapeHtml(tx.id)}')" 
            style="padding: 6px 14px; background: var(--bg0); border: 1px solid var(--line2); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.15s ease;"
            onmouseover="this.style.background='var(--glass)'; this.style.transform='translateY(-1px)'"
            onmouseout="this.style.background='var(--bg0)'; this.style.transform='translateY(0)'"
          >Details</button>
        </td>
      </tr>
    `;
  }).join("");
}

function getCategoryBadgeStyled(tx){
  const cat = String(tx.category || tx.type || "").toLowerCase();
  let bgColor = "#e5e7eb"; // default gray
  let textColor = "#374151";
  let displayText = (tx.category || tx.type || "—").toUpperCase().replace(/_/g, " ");
  
  // Match screenshot colors exactly
  if(cat.includes("topup") && !cat.includes("fee")){
    bgColor = "#dcfce7"; // green background
    textColor = "#166534"; // dark green text
    displayText = "TOPUP APPROVAL";
  } else if(cat.includes("topup") && cat.includes("fee")){
    bgColor = "#fef3c7"; // yellow/orange background
    textColor = "#92400e"; // dark orange text
    displayText = "TOPUP FEE";
  } else if(cat.includes("transfer") && cat.includes("fee")){
    bgColor = "#fef3c7"; // yellow/orange background
    textColor = "#92400e"; // dark orange text
    displayText = "TRANSFER FEE";
  } else if(cat.includes("transfer") || cat.includes("allocation")){
    bgColor = "#dbeafe"; // light blue background
    textColor = "#1e40af"; // dark blue text
    displayText = "TRANSFER";
  } else if(cat.includes("service")){
    bgColor = "#e0e7ff"; // light purple background
    textColor = "#4338ca"; // dark purple text
    displayText = "SERVICE CHARGE";
  } else if(cat.includes("setup")){
    bgColor = "#e0e7ff"; // light purple background
    textColor = "#4338ca"; // dark purple text
    displayText = "SETUP CHARGE";
  } else if(cat.includes("refund")){
    bgColor = "#fee2e2"; // light red background
    textColor = "#991b1b"; // dark red text
    displayText = "REFUND";
  } else {
    bgColor = "#f3f4f6"; // light gray background
    textColor = "#4b5563"; // dark gray text
    displayText = "OTHER";
  }
  
  return `<span style="display: inline-block; padding: 4px 10px; border-radius: 6px; background: ${bgColor}; color: ${textColor}; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.3px;">${displayText}</span>`;
}

function formatAccountName(account){
  if(!account || account === "—") return "—";
  
  // Format exact ca în screenshot
  let formatted = String(account);
  
  if(formatted === "external") return "Wire (EUR)";
  if(formatted === "mainWallet") return "Main Wallet";
  if(formatted === "platformVault") return "Platform Vault";
  if(formatted === "generalBalance") return "General Balance";
  if(formatted === "individualBalance") return "Individual Balance";
  if(formatted === "feesCollected") return "Fees";
  if(formatted === "topups") return "Topups";
  if(formatted === "topup") return "Top-up";
  
  return formatted;
}

function generateLinkId(tx){
  // Generate a link ID based on transaction type and details
  const type = (tx.type || "").toUpperCase();
  const id = String(tx.id || "").substring(0, 6).toUpperCase();
  
  if(type === "TOPUP") return `TOPUP-TN-DEMO-${id}`;
  if(type === "TRANSFER") return `TRANSFER-TE-DEMO-${id}`;
  if(type === "ALLOCATION") return `TRANSFER-TN-DEMO-${id}`;
  if(type === "FEE") return `TRANSFER-TE-DEMO-${id}`;
  
  return `TX-${id}`;
}

function filterInternalTransactions(){
  renderInternalTransactionsPage();
}

function clearInternalTxFilters(){
  const searchEl = document.getElementById("internalTx_search");
  const categoryEl = document.getElementById("internalTx_category");
  
  if(searchEl) searchEl.value = "";
  if(categoryEl) categoryEl.value = "__all__";
  
  renderInternalTransactionsPage();
}

function viewInternalTxDetails(txId){
  const tx = state.ledger.find(t => String(t.id) === String(txId));
  if(!tx){
    alert("Transaction not found.");
    return;
  }
  
  // Populate modal
  document.getElementById("internalTxModalTitle").textContent = `Internal Tx • ${tx.id}`;
  document.getElementById("txDetail_created").textContent = tx.date || "—";
  document.getElementById("txDetail_category").textContent = (tx.category || tx.type || "—").toUpperCase().replace(/_/g, " ");
  document.getElementById("txDetail_amount").textContent = `USD ${Number(tx.amount || 0).toFixed(2)}`;
  
  // Format from/to with platform
  let fromText = formatAccountName(tx.from || "—");
  let toText = formatAccountName(tx.to || "—");
  
  if(tx.platform && fromText === "Platform Vault"){
    fromText = `Platform Vault:${tx.platform.toUpperCase()}`;
  }
  if(tx.platform && toText === "Platform Vault"){
    toText = `Platform Vault:${tx.platform.toUpperCase()}`;
  }
  if(tx.platform && toText === "General Balance"){
    toText = `General Balance:${tx.platform.toUpperCase()}`;
  }
  if(tx.platform && toText === "Individual Balance"){
    toText = `Individual Balance:${tx.platform.toUpperCase()}`;
  }
  
  document.getElementById("txDetail_from").textContent = fromText;
  document.getElementById("txDetail_to").textContent = toText;
  document.getElementById("txDetail_link").textContent = generateLinkId(tx);
  document.getElementById("txDetail_client").textContent = `c${tx.clientId || "1"}`;
  document.getElementById("txDetail_feeCode").textContent = tx.feeCode || "—";
  document.getElementById("txDetail_description").textContent = tx.note || tx.description || "—";
  
  // Show modal with animation
  const modal = document.getElementById("internalTxDetailsModal");
  const panel = document.getElementById("internalTxDetailsPanel");
  modal.style.display = "block";
  
  // Trigger animation after display
  setTimeout(() => {
    panel.style.right = "0";
  }, 10);
}

function closeInternalTxDetails(){
  const modal = document.getElementById("internalTxDetailsModal");
  const panel = document.getElementById("internalTxDetailsPanel");
  
  // Animate out
  panel.style.right = "-500px";
  
  // Hide after animation
  setTimeout(() => {
    modal.style.display = "none";
  }, 300);
}

function exportInternalTransactionsExcel(){
  // Simple CSV export
  const rows = state.ledger
    .filter(passesGlobalFilters)
    .sort((a,b)=> new Date(b.date) - new Date(a.date));
  
  let csv = "Date,Category,Amount,From,To,Link,Description\n";
  
  rows.forEach(tx => {
    const linkId = generateLinkId(tx);
    const cat = tx.category || tx.type || "—";
    const row = [
      tx.date,
      cat,
      tx.amount,
      formatAccountName(tx.from || "—"),
      formatAccountName(tx.to || "—"),
      linkId,
      (tx.note || tx.description || "—").replace(/,/g, ";")
    ].join(",");
    csv += row + "\n";
  });
  
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `internal-transactions-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* Render Ledger Page (simple clone of preview) */
function renderLedgerPage(){
  const cloneBody = document.getElementById("ledgerPreviewBody_clone");
  if(!cloneBody) return;

  const preview = getFilteredLedger().slice(0, 12);

  cloneBody.innerHTML = preview.map(tx=>{
    const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
    const tags = [
      `<span class="tag">${escapeHtml(tx.type.toUpperCase())}</span>`,
      tx.platform ? `<span class="tag">${escapeHtml(tx.platform)}</span>` : ""
    ].join(" ");
    return `
      <tr>
        <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
        <td>${tags}</td>
        <td>${buildShortDetails(tx)}</td>
        <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
      </tr>
    `;
  }).join("");
}

/* Restore active page on load */
(function initPageTabs(){
  setActivePage(state.activePage || "finance");
})();

  </script>



<script>
  // === CONFIG: map page keys -> filenames (adjust if needed) ===
  const PAGE_ROUTES = {
    topups: "topups.html",
    finance: "finance.html",
    fees: "fees.html",
    "internal-transactions": "internal-transactions.html",
    transactions: "transactions.html"
  };

  function getCurrentFileName(){
    // Works for file:// and http(s)
    const p = window.location.pathname || "";
    const parts = p.split("/");
    return (parts[parts.length - 1] || "").toLowerCase();
  }

  function detectActivePage(){
    const file = getCurrentFileName();
    // match by file name
    for (const [key, filename] of Object.entries(PAGE_ROUTES)){
      if ((filename || "").toLowerCase() === file) return key;
    }
    // fallback: if open folder/index
    return "finance";
  }

  function setActiveTabUI(activeKey){
    document.querySelectorAll("#pageTabs .page-tab").forEach(btn=>{
      const isOn = btn.dataset.page === activeKey;
      btn.classList.toggle("active", isOn);
      btn.setAttribute("aria-selected", isOn ? "true" : "false");
    });
  }

  function navigateTo(key){
    const target = PAGE_ROUTES[key];
    if(!target) return;
    // Keep same folder, works in file:// too
    window.location.href = target;
  }


  // Init UI
  const active = detectActivePage();
  setActiveTabUI(active);

  // Click behavior
  document.getElementById("pageTabs")?.addEventListener("click", (e)=>{
    const btn = e.target.closest(".page-tab");
    if(!btn) return;

    const key = btn.dataset.page;
    // instant UI feedback
    setActiveTabUI(key);

    // if already on same page, do nothing
    if(key === detectActivePage()) return;

    navigateTo(key);
  });

  // Optional: keyboard left/right like a true switcher
  document.getElementById("pageTabs")?.addEventListener("keydown", (e)=>{
    const tabs = [...document.querySelectorAll("#pageTabs .page-tab")];
    const idx = tabs.findIndex(t => t.classList.contains("active"));
    if(idx < 0) return;

    if(e.key === "ArrowRight" || e.key === "ArrowLeft"){
      e.preventDefault();
      const next = e.key === "ArrowRight"
        ? tabs[(idx + 1) % tabs.length]
        : tabs[(idx - 1 + tabs.length) % tabs.length];
      next.focus();
      next.click();
    }
  });
</script>

<script>
/* ==============================
   GLOBAL TAB SWITCHER
============================== */

const TAB_ROUTES = {
  finance: "finance.html",
  topups: "topups.html",
  transactions: "transactions.html",
  ledger: "ledger.html"
};

function getCurrentPageKey(){

  const file = window.location.pathname
    .split("/")
    .pop()
    .toLowerCase();

  if(file.includes("finance")) return "finance";
  if(file.includes("topup")) return "topups";
  if(file.includes("transaction")) return "transactions";
  if(file.includes("ledger")) return "ledger";

  return "finance";
}

function setActiveTab(){

  const active = getCurrentPageKey();

  document.querySelectorAll(".page-tab").forEach(tab => {

    const isActive = tab.dataset.page === active;

    tab.classList.toggle("active", isActive);

  });

}

function initTabSwitcher(){

  setActiveTab();

  document.querySelectorAll(".page-tab").forEach(tab => {

    tab.addEventListener("click", () => {

      const page = tab.dataset.page;

      if(page === getCurrentPageKey())
        return;

      window.location.href = TAB_ROUTES[page];

    });

  });

}

initTabSwitcher();
</script>




</body>
</html>
