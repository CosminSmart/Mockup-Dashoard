<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Finance</title>

  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/sidebar.css" />
  <link rel="stylesheet" href="../css/accounts.css" />

  <style>
    .finance-container { width: 100%; }

    /* GLOBAL FILTERS BAR */
    .global-filters{
      background:#fff;
      padding: 1rem 1.25rem;
      border-radius: 8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-bottom: 1rem;
    }
    .global-filters__row{
      display:flex;
      gap: .9rem;
      flex-wrap: wrap;
      align-items: flex-end;
      justify-content: space-between;
    }
    .global-filters__left{
      display:flex;
      gap: .9rem;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group{ min-width: 240px; }
    .filter-group.small{ min-width: 180px; }

    .statistics{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:1rem;
      margin-bottom: 1.25rem;
    }

    .wallet-section{
      background:#fff;
      padding: 1.25rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    .transfer-btn{
      padding: .75rem 1.1rem;
      border:none;
      border-radius:6px;
      cursor:pointer;
      background:#3498db;
      color:#fff;
      font-size:.9rem;
      font-weight: 600;
    }
    .transfer-btn:hover{ background:#2980b9; }
    .transfer-btn.secondary{ background:#2ecc71; }
    .transfer-btn.secondary:hover{ background:#27ae60; }
    .transfer-btn.gray{ background:#95a5a6; }
    .transfer-btn.gray:hover{ background:#7f8c8d; }

    .fee-notice{
      background:#fff3cd;
      border:1px solid #ffc107;
      padding:.9rem 1rem;
      border-radius:6px;
      margin-top:.9rem;
      font-size:.9rem;
    }

    .topups-section{
      background:#fff;
      padding: 1.25rem;
      border-radius:8px;
      box-shadow:0 2px 4px rgba(0,0,0,0.08);
      margin-top: 1rem;
    }

    .topups-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .75rem;
    }
    .topups-header h2{
      margin:0;
      font-size: 1.35rem;
    }

    /* ✅ NEW: Topups table (like screenshot #1) */
    .topups-table-wrap{
      border:1px solid #eee;
      border-radius: 10px;
      overflow:auto;
      background:#fff;
    }
    .topups-table{
      width:100%;
      border-collapse: collapse;
      font-size: .92rem;
      min-width: 920px;
    }
    .topups-table th, .topups-table td{
      padding:.85rem .75rem;
      border-bottom:1px solid #f0f0f0;
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    .topups-table th{
      font-size:.78rem;
      letter-spacing:.03em;
      text-transform: uppercase;
      color:#6c7a89;
      background:#fafafa;
    }
    .topups-row{
      cursor:pointer;
      transition: background .12s ease;
    }
    .topups-row:hover{ background:#fafafa; }
    .td-muted{ color:#6c7a89; }
    .td-right{ text-align:right; }

    /* Status badge like screenshot */
    .status-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.28rem .65rem;
      border-radius: 999px;
      font-weight: 800;
      font-size:.8rem;
      border:1px solid #e6e6e6;
      background:#fafafa;
      color:#2c3e50;
    }
    .status-badge.approved{
      background: rgba(46, 204, 113, .14);
      border-color: rgba(46, 204, 113, .35);
      color: #1f8a4c;
    }
    .status-badge.pending{
      background: rgba(241, 196, 15, .14);
      border-color: rgba(241, 196, 15, .35);
      color: #8a6d00;
    }
    .status-badge.declined{
      background: rgba(231, 76, 60, .12);
      border-color: rgba(231, 76, 60, .30);
      color:#a93226;
    }
    .status-badge.past_due{
      background: rgba(149, 165, 166, .16);
      border-color: rgba(149, 165, 166, .35);
      color:#5f6a6a;
    }

    /* ✅ NEW: Topup details modal (like screenshot #2) */
    /* RIGHT DRAWER MODAL */
.tx-modal{
  position:fixed;
  inset:0;
  z-index:3000;
  display:none;
}

.tx-modal.active{
  display:block;
}

.tx-modal__overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.45);
  backdrop-filter: blur(2px);
}

.tx-modal__panel{
  position:absolute;
  top:0;
  right:0;

  height:100%;
  width:min(480px, 95vw);

  background:#fff;

  box-shadow:-10px 0 30px rgba(0,0,0,.18);

  transform:translateX(100%);
  transition:transform .25s ease;

  display:flex;
  flex-direction:column;
}

.tx-modal.active .tx-modal__panel{
  transform:translateX(0);
}

/* header */
.tx-modal__header{
  padding:1rem;
  border-bottom:1px solid #eee;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

/* body scrollable */
.tx-modal__body{
  padding:1rem;
  overflow:auto;
  flex:1;
}

/* footer pinned bottom */
.modal-footer{
  padding:1rem;
  border-top:1px solid #eee;
  background:#fff;
}

.tx-modal__overlay{
  opacity:0;
  transition:opacity .25s ease;
}

.tx-modal.active .tx-modal__overlay{
  opacity:1;
}


    .tx-close{
      width: 36px; height: 36px;
      border:none;
      border-radius: 10px;
      background:#f2f2f2;
      cursor:pointer;
      font-size: 18px;
      line-height: 36px;
    }
    .tx-modal__body{ padding: 1rem; }

    .kv-card{
      border:1px solid #eee;
      border-radius: 12px;
      background:#fff;
      overflow:hidden;
      margin-bottom: 1rem;
    }
    .kv-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: .75rem;
      padding: .65rem .9rem;
      border-bottom:1px solid #f1f1f1;
      align-items:center;
    }
    .kv-row:last-child{ border-bottom:none; }
    .kv-key{
      font-weight: 900;
      color:#2c3e50;
      font-size: .88rem;
    }
    .kv-val{
      text-align:right;
      color:#6c7a89;
      font-weight: 800;
      font-size: .9rem;
    }

    .segmented-status{
      display:flex;
      gap:.5rem;
      flex-wrap: wrap;
      margin: .5rem 0 1rem 0;
    }
    .seg-pill{
      border:1px solid #ddd;
      background:#f8f8f8;
      padding:.55rem .85rem;
      border-radius: 999px;
      cursor:pointer;
      font-weight: 900;
      font-size: .9rem;
      color:#6c7a89;
      user-select:none;
    }
    .seg-pill.active{
      background: rgba(46, 204, 113, .14);
      border-color: rgba(46, 204, 113, .35);
      color:#1f8a4c;
    }
    .seg-pill.active.pending{
      background: rgba(241, 196, 15, .14);
      border-color: rgba(241, 196, 15, .35);
      color:#8a6d00;
    }
    .seg-pill.active.declined{
      background: rgba(231, 76, 60, .12);
      border-color: rgba(231, 76, 60, .30);
      color:#a93226;
    }
    .seg-pill.active.past_due{
      background: rgba(149, 165, 166, .16);
      border-color: rgba(149, 165, 166, .35);
      color:#5f6a6a;
    }

    .modal-footer{
      padding: 1rem;
      border-top:1px solid #eee;
      display:flex;
      gap:.75rem;
      justify-content:flex-start;
      background:#fff;
    }

    .modal-simple{
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      padding: 16px;
    }
    .modal-simple.active{
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .modal-simple-content{
      background:#fff;
      padding:1.25rem;
      border-radius:10px;
      max-width:860px;
      width:100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    .form-group{ margin-bottom:.9rem; }
    .form-group label{
      display:block;
      margin-bottom:.45rem;
      font-weight:800;
      color:#2c3e50;
      font-size:.9rem;
    }
    .form-group input, .form-group select, .form-group textarea{
      width:100%;
      padding:.6rem .7rem;
      border:1px solid #ddd;
      border-radius:6px;
      font-size: .95rem;
      outline: none;
      background:#fff;
    }
    .form-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: .9rem;
    }
    @media (max-width: 780px){
      .form-row{ grid-template-columns: 1fr; }
    }

    .widgets-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 1100px){
      .widgets-grid{ grid-template-columns: 1fr; }
    }

    .widget-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 0 0 .8rem 0;
    }
    .widget-title h2{ margin:0; font-size: 1.2rem; }

    /* pill tabs */
    .pillbar{ display:flex; gap:.5rem; flex-wrap: wrap; }
    .pill{
      border:1px solid #e6e6e6;
      background:#fafafa;
      padding:.45rem .7rem;
      border-radius: 999px;
      font-size: .85rem;
      cursor:pointer;
      user-select:none;
      font-weight: 700;
      color:#2c3e50;
    }
    .pill.active{
      border-color:#3498db;
      background: rgba(52,152,219,.10);
      color:#1f6fa8;
    }

    .mini-hint{
      font-size:.88rem;
      color:#6c7a89;
      margin-top: .15rem;
      line-height: 1.35;
    }

    .ledger-table{
      width:100%;
      border-collapse:collapse;
      margin-top: .5rem;
      font-size:.92rem;
    }
    .ledger-table th, .ledger-table td{
      padding:.75rem .6rem;
      border-bottom:1px solid #eee;
      text-align:left;
      vertical-align: top;
    }
    .ledger-table th{
      font-size:.8rem;
      letter-spacing:.02em;
      text-transform: uppercase;
      color:#6c7a89;
      background:#fafafa;
    }

    .amount-pos{ font-weight: 900; color:#1f8a4c; }
    .amount-neg{ font-weight: 900; color:#c0392b; }

    .tag{
      display:inline-block;
      padding:.18rem .5rem;
      border-radius: 999px;
      font-size:.78rem;
      border:1px solid #e6e6e6;
      background:#fafafa;
      font-weight: 800;
      color:#2c3e50;
      margin-right: .35rem;
    }

    .split{
      display:flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-top: .75rem;
    }

    .quick-actions{ display:flex; gap: .6rem; flex-wrap: wrap; }

    .muted{ color:#6c7a89; font-size: .9rem; }

    .stat-box select.kpi-select{
      width: 100%;
      padding: 0.35rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 0.5rem;
      font-size: 0.85rem;
      background: #fff;
    }

    /* RIGHT DRAWER */
    .drawer{ position: fixed; inset: 0; z-index: 2000; display: none; }
    .drawer.active{ display:block; }
    .drawer__overlay{ position:absolute; inset:0; background: rgba(0,0,0,.45); backdrop-filter: blur(2px); }
    .drawer__panel{
      position:absolute; top:0; right:0;
      height: 100%;
      width: min(420px, 92vw);
      background:#fff;
      box-shadow: -10px 0 30px rgba(0,0,0,.15);
      display:flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform .22s ease;
    }
    .drawer.active .drawer__panel{ transform: translateX(0); }
    .drawer__header{
      display:flex; align-items:center; justify-content:space-between;
      padding: 1rem 1rem .75rem 1rem;
      border-bottom:1px solid #eee;
    }
    .drawer__title{ font-size: 1.35rem; font-weight: 900; margin: 0; color:#2c3e50; }
    .drawer__close{
      width: 34px; height: 34px;
      border:none; background:#f2f2f2;
      border-radius: 10px; cursor:pointer;
      font-size: 18px; line-height: 34px;
    }
    .drawer__body{ padding: 1rem; overflow:auto; }
    .segmented{ display:flex; gap:.5rem; flex-wrap: wrap; margin: .75rem 0 1rem 0; }
    .seg-btn{
      border:1px solid #ddd; background:#f8f8f8;
      padding:.55rem .85rem; border-radius: 8px;
      cursor:pointer; font-weight: 800; font-size: .9rem; color:#2c3e50;
    }
    .seg-btn.active{ background:#3b5bdb; border-color:#2f4fcb; color:#fff; }
    .notice-box{
      margin-top: .75rem;
      background:#ffe3e3;
      border:1px solid #ffa8a8;
      color:#7b1e1e;
      padding:.75rem;
      border-radius: 10px;
      font-size: .85rem;
      line-height: 1.35;
    }
    .drawer__footer{
      padding: 1rem; border-top:1px solid #eee;
      display:flex; gap:.75rem; justify-content:flex-start; background:#fff;
    }
    .btn-disabled{ opacity: .55; pointer-events: none; }

    /* workspace section divider */
    .hr { border:none; border-top:1px solid #eee; margin: 1rem 0; }

    /* small card inside workspace tabs */
    .subtab-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: .5rem;
    }
  </style>
</head>

<body>
    <div class="layout">
        <header class="header">
            <h1>Finance</h1>
            <div class="header-right">
                <div class="theme-toggle">
                    <button class="theme-btn active">Light</button>
                    <button class="theme-btn">Dark</button>
                </div>
                <div class="user-info">
                    <span>Admin User</span>
                    <div class="user-avatar">AU</div>
                </div>
            </div>
        </header>
    <!-- Transfer Modal -->
    <div class="modal-simple" id="transferModal">
        <div class="modal-simple-content">
            <h2 id="modalTitle">Transfer Funds</h2>
            <div class="form-group">
                <label>Amount</label>
                <input type="number" id="transferAmount" placeholder="Enter amount">
            </div>
            <div class="form-group" id="accountSelectGroup" style="display: none;">
                <label>Select Account</label>
                <select id="accountSelect">
                    <option value="">Select account...</option>
                    <option value="acc1">Account 1</option>
                    <option value="acc2">Account 2</option>
                </select>
            </div>
            <div class="form-group" id="platformSelectGroup" style="display: none;">
                <label>Select Platform</label>
                <select id="platformSelect">
                    <option value="">Select platform...</option>
                    <option value="facebook">Facebook</option>
                    <option value="google">Google</option>
                    <option value="tiktok">TikTok</option>
                </select>
            </div>
            <div id="feeInfo" style="margin: 1rem 0; padding: 0.5rem; background: #f0f0f0; border-radius: 4px;"></div>
            <div style="display: flex; gap: 1rem;">
                <button class="transfer-btn" onclick="confirmTransfer()">Confirm Transfer</button>
                <button class="transfer-btn" style="background: #95a5a6;" onclick="closeTransferModal()">Cancel</button>
            </div>
        </div>
        <div class="user-info">
          <span>Admin User</span>
          <div class="user-avatar">AU</div>
        </div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="finance-container">

        <!-- GLOBAL FILTERS -->
        <div class="global-filters">
          <div class="global-filters__row">
            <div class="global-filters__left">
              <div class="form-group filter-group">
                <label>Client</label>
                <select id="global_client" onchange="onGlobalFiltersChanged()">
                  <option value="__all__">All clients</option>
                </select>
              </div>

              <div class="form-group filter-group small">
                <label>Date from</label>
                <input type="date" id="global_from" onchange="onGlobalFiltersChanged()">
              </div>

              <div class="form-group filter-group small">
                <label>Date to</label>
                <input type="date" id="global_to" onchange="onGlobalFiltersChanged()">
              </div>

              <!-- ✅ NEW: Single filter by status (for Topups table only) -->
              <!-- <div class="form-group filter-group small">
                <label>Status</label>
                <select id="topups_status" onchange="onTopupsStatusChanged()">
                  <option value="__all__">All</option>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="declined">Declined</option>
                  <option value="past_due">Past Due</option>
                </select>
              </div> -->
            </div>

            <div class="quick-actions">
              <button class="transfer-btn gray" onclick="clearGlobalFilters()">Clear</button>
            </div>
          </div>

          <div class="mini-hint" id="global_hint"></div>
        </div>

        <!-- KPI Statistics -->
        <div class="statistics">
          <div class="stat-box">
            <h4>TOTAL TOPUPS</h4>
            <div class="stat-value" id="kpi_totalTopups">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>MAIN WALLET</h4>
            <div class="stat-value" id="kpi_mainWallet">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>PLATFORMS VAULT</h4>
            <div class="stat-value" id="kpi_platformVault">$0.00</div>
            <div class="stat-description">
              <select id="kpi_platformFilter" class="kpi-select">
                <option value="__all__">Total (All Platforms)</option>
                <option value="facebook">Facebook</option>
                <option value="google">Google</option>
                <option value="tiktok">TikTok</option>
              </select>
              <div class="mini-hint">Filtered by client/date</div>
            </div>
          </div>

          <div class="stat-box">
            <h4>GENERAL BALANCE</h4>
            <div class="stat-value" id="kpi_generalBalance">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>INDIVIDUAL BALANCE</h4>
            <div class="stat-value" id="kpi_individualBalance">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>SPEND</h4>
            <div class="stat-value" id="kpi_spend">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>TOTAL FEES</h4>
            <div class="stat-value" id="kpi_totalFees">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>

          <div class="stat-box">
            <h4>SETUP ACCOUNT + SERVICES</h4>
            <div class="stat-value" id="kpi_setupServices">$0.00</div>
            <div class="stat-description">Filtered by client/date</div>
          </div>
        </div>

        <!-- Workspace + Ledger -->
        <div class="widgets-grid">
          <!-- FINANCE WORKSPACE -->
          <div class="wallet-section">
            <div class="widget-title">
              <div>
                <h2>Finance Workspace</h2>
                <div class="mini-hint">
                  Acțiunile se aplică pe <strong>clientul selectat</strong>. Dacă e "All clients", acțiunile sunt blocate.
                </div>
              </div>

              <!-- MAIN WORKSPACE TABS -->
              <div class="pillbar" id="workspaceTabs">
                <div class="pill active" data-tab="funding" style="display: none;">Funding</div>
                <div class="pill" data-tab="setup" style="display: none;">Setup & Services</div>
              </div>
            </div>

            <!-- TAB: Funding -->
            <div id="tab_funding">

              <!-- SUBTABS IN FUNDING -->
              <div class="subtab-header">
                <div class="mini-hint">Alege fluxul (funding / allocate / individual send).</div>
                <div class="pillbar" id="fundingSubTabs">
                  <div class="pill active" data-subtab="main_to_vault">Main → Vault</div>
                  <div class="pill" data-subtab="vault_allocate">Vault → (General/Individual/Account)</div>
                  <div class="pill" data-subtab="individual_to_account">Individual → Account</div>
                </div>
              </div>

              <!-- SUBTAB: Main -> Vault -->
              <div id="subtab_main_to_vault">
                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Main Wallet</option>
                    </select>
                    <div class="mini-hint" id="tx_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To</label>
                    <select disabled>
                      <option>Platform Vault</option>
                    </select>
                    <div class="mini-hint">Din Main Wallet poți trimite doar către Platform Vault.</div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform</label>
                    <select id="tx_platform" onchange="updateFundingPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="tx_amount" min="0" step="0.01" placeholder="e.g. 250" oninput="updateFundingPreview()">
                  </div>
                </div>

                <div class="form-group">
                  <label>Note (optional)</label>
                  <input type="text" id="tx_note" placeholder="e.g. Funding for campaigns Feb" oninput="updateFundingPreview()">
                </div>

     
                <div class="split">
                  <div class="muted" id="tx_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitMainToVault()">Confirm Transfer</button>
                    <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Vault -> Allocate -->
              <div id="subtab_vault_allocate" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Allocate from Platform Vault</strong> către General / Individual / Accounts:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Platform Vault</label>
                    <select id="alloc_platform" onchange="updateAllocationPreview()">
                      <option value="facebook">Facebook</option>
                      <option value="google">Google</option>
                      <option value="tiktok">TikTok</option>
                    </select>
                    <div class="mini-hint" id="alloc_platformHint"></div>
                  </div>

                  <div class="form-group">
                    <label>Allocate To</label>
                    <select id="alloc_to" onchange="toggleAllocAccountSelect(); updateAllocationPreview();">
                      <option value="generalBalance">General Balance</option>
                      <option value="individualBalance">Individual Balance</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group" id="alloc_accountGroup" style="display:none;">
                    <label>Select Account</label>
                    <select id="alloc_account" onchange="updateAllocationPreview()">
                      <option value="acc_1">acc_1</option>
                      <option value="acc_2">acc_2</option>
                      <option value="acc_3">acc_3</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="alloc_amount" min="0" step="0.01" placeholder="e.g. 120" oninput="updateAllocationPreview()">
                  </div>
                </div>

                <div class="form-group">
                  <label>Note (optional)</label>
                  <input type="text" id="alloc_note" placeholder="e.g. allocate to acc_1" oninput="updateAllocationPreview()">
                </div>

                <div class="split">
                  <div class="muted" id="alloc_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitAllocation()">Confirm Allocation</button>
                  </div>
                </div>
              </div>

              <!-- SUBTAB: Individual -> Account -->
              <div id="subtab_individual_to_account" style="display:none;">
                <div class="mini-hint" style="margin-bottom:.6rem;">
                  <strong>Send from Individual Balance</strong> către un cont anume:
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>From</label>
                    <select disabled>
                      <option>Individual Balance</option>
                    </select>
                    <div class="mini-hint" id="ind_fromHint"></div>
                  </div>

                  <div class="form-group">
                    <label>To (Account)</label>
                    <select id="ind_toAccount" onchange="updateIndToAccountPreview()">
                      <option value="acc_1">acc_1</option>
                      <option value="acc_2">acc_2</option>
                      <option value="acc_3">acc_3</option>
                    </select>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Amount (USD)</label>
                    <input type="number" id="ind_amount" min="0" step="0.01" placeholder="e.g. 100" oninput="updateIndToAccountPreview()">
                  </div>

                  <div class="form-group">
                    <label>Note (optional)</label>
                    <input type="text" id="ind_note" placeholder="e.g. assign to acc_2 budget" oninput="updateIndToAccountPreview()">
                  </div>
                </div>

                <div class="split">
                  <div class="muted" id="ind_preview"></div>
                  <div class="quick-actions">
                    <button class="transfer-btn secondary" onclick="submitIndividualToAccount()">Confirm Send</button>
                  </div>
                </div>
              </div>

            </div>

            <!-- TAB: Setup & Services -->
            <div id="tab_setup" style="display:none;">
              <div class="mini-hint" style="margin-bottom:.75rem;">
                Setup/Services se ia <strong>direct</strong> din Main Wallet.
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Charge Type</label>
                  <select id="charge_type">
                    <option value="setup">Setup</option>
                    <option value="service">Service</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Model</label>
                  <select id="charge_model">
                    <option value="one-time">one-time</option>
                    <option value="recurring">recurring</option>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Linked (Account)</label>
                  <select id="charge_linked">
                    <option value="acc_1">Account: acc_1</option>
                    <option value="acc_2">Account: acc_2</option>
                    <option value="acc_3">Account: acc_3</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Amount (USD)</label>
                  <input type="number" id="charge_amount" min="0" step="0.01" placeholder="e.g. 80">
                </div>
              </div>

              <div class="form-group">
                <label>Details (JSON/text)</label>
                <textarea id="charge_details" rows="3" placeholder='e.g. {"region":"US","level":"Standard","note":"BOV verification"}'></textarea>
              </div>

              <div class="fee-notice">
                <strong>Logic:</strong> Main Wallet scade cu amount, iar KPI <strong>Setup Account + Services</strong> crește cu amount.
              </div>

              <div class="quick-actions">
                <button class="transfer-btn secondary" onclick="submitSetupServiceCharge()">+ Add Charge</button>
                <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
              </div>
            </div>
          </div>

          <!-- LEDGER -->
          <div class="wallet-section">
            <div class="widget-title">
              <div>
                <h2>Ledger</h2>
                <div class="mini-hint">Preview filtrat de client/date.</div>
              </div>

              <div class="pillbar" id="ledgerTabs">
                <div class="pill active" data-ledger="all">All</div>
                <div class="pill" data-ledger="topups">Topups</div>
                <div class="pill" data-ledger="fees">Fees</div>
                <div class="pill" data-ledger="internal">Internal</div>
              </div>
            </div>

            <table class="ledger-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Details</th>
                  <th style="text-align:right;">Amount</th>
                </tr>
              </thead>
              <tbody id="ledgerPreviewBody"></tbody>
            </table>

            <div class="split">
              <div class="muted" id="ledgerHint"></div>
              <div class="quick-actions">
                <button class="transfer-btn" onclick="openLedgerModal()">View All</button>
                <button class="transfer-btn gray" onclick="exportLedgerJson()">Export JSON</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Topups -->
        <div class="topups-section">
          <div class="topups-header">
            <div>
              <h2>Total Topups</h2>
              <div class="mini-hint">Listă filtrată de client/date + Status (doar pentru tabel).</div>
            </div>
            <div class="quick-actions">
              <!-- ✅ keep button exactly here (as you requested) -->
              <button class="transfer-btn secondary" onclick="openTopupDrawer()">+ Add Topup</button>
            </div>
          </div>

          <!-- ✅ NEW table -->
          <div class="topups-table-wrap">
            <table class="topups-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Account</th>
                  <th>Proof</th>
                  <th class="td-right">Amount</th>
                  <th>Status</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody id="topupsTableBody"></tbody>
            </table>
          </div>

          <div class="mini-hint" id="topupsTableHint" style="margin-top:.6rem;"></div>
        </div>

      </div>
    </main>
  </div>

  <!-- Ledger Modal -->
  <div class="modal-simple" id="ledgerModal">
    <div class="modal-simple-content">
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
        <div>
          <h2 style="margin:0;">Ledger (Filtered)</h2>
          <div class="mini-hint">Același filtru global (client/date) + tab selection (All/Topups/Fees/Internal).</div>
        </div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="closeLedgerModal()">Close</button>
        </div>
      </div>

      <div style="max-height: 62vh; overflow:auto; border:1px solid #eee; border-radius: 10px; padding: .25rem .25rem 0 .25rem; margin-top:.75rem;">
        <table class="ledger-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>From → To</th>
              <th>Client</th>
              <th>Platform</th>
              <th>Category</th>
              <th>Note</th>
              <th style="text-align:right;">Amount</th>
            </tr>
          </thead>
          <tbody id="ledgerAllBody"></tbody>
        </table>
      </div>

      <div class="split">
        <div class="muted" id="ledgerTotalsHint"></div>
        <div class="quick-actions">
          <button class="transfer-btn gray" onclick="seedDemo()">Reset Demo Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ NEW: Topup Details Modal -->
  <div class="tx-modal" id="topupDetailsModal" aria-hidden="true">
    <div class="tx-modal__overlay" onclick="closeTopupDetails()"></div>

    <div class="tx-modal__panel" role="dialog" aria-modal="true" aria-label="Topup Details">
      <div class="tx-modal__header">
        <h3>Top-Up Details</h3>
        <button class="tx-close" onclick="closeTopupDetails()" aria-label="Close">×</button>
      </div>

      <div class="tx-modal__body">
        <div class="kv-card" id="topupKvCard"></div>

        <div style="margin-top:.25rem;">
          <div class="kv-key" style="margin-bottom:.35rem;">Status</div>
          <div class="segmented-status" id="topupStatusSeg">
            <div class="seg-pill" data-status="pending" onclick="setTopupModalStatus('pending')">Pending</div>
            <div class="seg-pill" data-status="approved" onclick="setTopupModalStatus('approved')">Approved</div>
            <div class="seg-pill" data-status="declined" onclick="setTopupModalStatus('declined')">Declined</div>
            <div class="seg-pill" data-status="past_due" onclick="setTopupModalStatus('past_due')">Past Due</div>
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea id="topupModalDesc" rows="3" placeholder="--"></textarea>
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="datetime-local" id="topupModalDate">
        </div>
      </div>

      <div class="modal-footer">
        <button class="transfer-btn secondary" onclick="saveTopupDetails()">Save Changes</button>
        <button class="transfer-btn gray" onclick="closeTopupDetails()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- RIGHT DRAWER: Add Topup -->
  <div class="drawer" id="topupDrawer" aria-hidden="true">
    <div class="drawer__overlay" onclick="closeTopupDrawer()"></div>

    <div class="drawer__panel" role="dialog" aria-modal="true" aria-label="Add Top-Up">
      <div class="drawer__header">
        <h3 class="drawer__title">Add Top-Up</h3>
        <button class="drawer__close" onclick="closeTopupDrawer()" aria-label="Close">×</button>
      </div>

      <div class="drawer__body">
        <div class="form-group">
          <label>Client</label>
          <select id="topup_client">
            <option value="100">100 - Alex</option>
            <option value="101">101 - Maria</option>
            <option value="102">102 - John</option>
          </select>
        </div>

        <div class="segmented" id="topupTabs">
          <button class="seg-btn active" data-tab="wire" onclick="switchTopupTab('wire')">Wire</button>
          <button class="seg-btn" data-tab="crypto" onclick="switchTopupTab('crypto')">Crypto</button>
          <button class="seg-btn" data-tab="refund" onclick="switchTopupTab('refund')">Refund</button>
        </div>

        <!-- WIRE -->
        <div id="tab_wire">
          <div class="form-group">
            <label>Company</label>
            <input id="wire_company" type="text" placeholder="e.g. Wise / Revolut / Bank" />
          </div>

          <div class="form-group">
            <label>Account</label>
            <select id="wire_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="wire_gross" type="number" min="0" step="0.01" placeholder="e.g. 1000" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Fee</label>
            <input id="wire_fee" type="number" min="0" step="0.01" placeholder="e.g. 10" oninput="recalcWireNet()" />
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="wire_net" type="number" min="0" step="0.01" placeholder="auto" readonly />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="wire_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="wire_invoice" type="file" accept="application/pdf" />
          </div>

          <div class="notice-box">
            Minimum deposit: $500<br />
            Make sure the full amount arrives without fee deductions.
          </div>
        </div>

        <!-- CRYPTO -->
        <div id="tab_crypto" style="display:none;">
          <div class="form-group">
            <label>Method</label>
            <select id="crypto_method">
              <option value="">Select</option>
              <option value="USDT">USDT</option>
              <option value="USDC">USDC</option>
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="crypto_net" type="number" min="0" step="0.01" placeholder="e.g. 500" />
          </div>

          <div class="form-group">
            <label>Gross Amount</label>
            <input id="crypto_gross" type="number" min="0" step="0.01" placeholder="optional" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="crypto_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="mini-hint" id="crypto_fee_hint">Fee: 0.00</div>

          <div class="form-group">
            <label>Wallet</label>
            <select id="crypto_network">
              <option value="">select network</option>
              <option value="ERC20">ERC20</option>
              <option value="TRC20">TRC20</option>
              <option value="BEP20">BEP20</option>
            </select>
          </div>

          <div class="form-group">
            <label>Hash</label>
            <input id="crypto_hash" type="text" placeholder="Transaction hash" />
          </div>
        </div>

        <!-- SPECIAL (kept, but not exposed in tabs - if you want it later, add button back) -->
        <div id="tab_special" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="special_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount</label>
            <input id="special_net" type="number" min="0" step="0.01" placeholder="e.g. 750" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="special_desc" type="text" placeholder="Optional note" />
          </div>

          <div class="form-group">
            <label>Invoice (PDF)</label>
            <input id="special_invoice" type="file" accept="application/pdf" />
          </div>
        </div>

        <!-- REFUND -->
        <div id="tab_refund" style="display:none;">
          <div class="form-group">
            <label>Account</label>
            <select id="refund_account">
              <option value="">Select</option>
              <option value="acc_1">acc_1</option>
              <option value="acc_2">acc_2</option>
              <option value="acc_3">acc_3</option>
            </select>
          </div>

          <div class="form-group">
            <label>Net Amount (refund)</label>
            <input id="refund_net" type="number" min="0" step="0.01" placeholder="e.g. 120" />
          </div>

          <div class="form-group">
            <label>Description</label>
            <input id="refund_desc" type="text" placeholder="Refund reason / note" />
          </div>

          <div class="notice-box" style="background:#e7f5ff;border-color:#74c0fc;color:#0b4a6f;">
            Refund scade din Main Wallet (filtrat pe client).
          </div>
        </div>

      </div>

      <div class="drawer__footer">
        <button class="transfer-btn secondary" id="topupSubmitBtn" onclick="submitTopup()">Submit</button>
        <button class="transfer-btn gray" onclick="closeTopupDrawer()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="../js/sidebar.js"></script>
  <script>
    const LS_KEY = "admin_finance_demo_v7";

    const state = {
      ledger: [],
      platformFilter: "__all__",
      globalClient: "__all__",
      globalFrom: "",
      globalTo: "",
      ledgerTab: "all", // all | topups | fees | internal

      // ✅ NEW: topups status filter (only affects Topups table)
      topupsStatus: "__all__",

      // ✅ NEW: modal selection
      activeTopupModalId: null
    };

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }
    function nowISO(){ return new Date().toLocaleString(); }
    function uid(){ return Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getClientLabelById(id){
      const map = { "100":"100 - Alex", "101":"101 - Maria", "102":"102 - John" };
      return map[String(id)] || String(id);
    }

    function getClientNameById(id){
      const label = getClientLabelById(id);
      const parts = String(label).split(" - ");
      return parts[1] ? parts.slice(1).join(" - ").trim() : label;
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ seedDemo(); return; }
      try{
        const parsed = JSON.parse(raw);
        state.ledger = Array.isArray(parsed.ledger) ? parsed.ledger : [];
        state.platformFilter = parsed.platformFilter || "__all__";
        state.globalClient = parsed.globalClient || "__all__";
        state.globalFrom = parsed.globalFrom || "";
        state.globalTo = parsed.globalTo || "";
        state.ledgerTab = parsed.ledgerTab || "all";
        state.topupsStatus = parsed.topupsStatus || "__all__";
      }catch(e){ seedDemo(); }
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        ledger: state.ledger,
        platformFilter: state.platformFilter,
        globalClient: state.globalClient,
        globalFrom: state.globalFrom,
        globalTo: state.globalTo,
        ledgerTab: state.ledgerTab,
        topupsStatus: state.topupsStatus
      }));
    }

    function seedDemo(){
      state.ledger = [
        // ✅ topups now contain fields required by table + modal
        {
          id: uid(),
          topupId: "100147",
          date: "1/15/2024, 10:00:00 AM",
          type:"topup",
          clientId:"100",
          from:"external",
          to:"topups",
          platform:"",
          category:"wire",
          status:"approved",
          account:"USD",
          proof:"INV_100147.pdf",
          description:"--",
          grossAmount: 1000,
          feeAmount: 0,
          netAmount: 1000,
          note:"Topup #1 (Wire)",
          amount: 1000
        },
        {
          id: uid(),
          topupId: "100148",
          date: "1/20/2024, 10:00:00 AM",
          type:"topup",
          clientId:"100",
          from:"external",
          to:"topups",
          platform:"",
          category:"wire",
          status:"pending",
          account:"USD",
          proof:"INV_100148.pdf",
          description:"Bank wire topup",
          grossAmount: 2000,
          feeAmount: 0,
          netAmount: 2000,
          note:"Topup #2 (Wire)",
          amount: 2000
        },
        {
          id: uid(),
          topupId: "100149",
          date: "1/25/2024, 10:00:00 AM",
          type:"topup",
          clientId:"101",
          from:"external",
          to:"topups",
          platform:"",
          category:"crypto",
          status:"approved",
          account:"USDT",
          proof:"0x7a1b...9c2f",
          description:"USDT TRC20",
          grossAmount: 2000,
          feeAmount: 0,
          netAmount: 2000,
          note:"Topup #3 (Crypto)",
          amount: 2000
        },

        { id: uid(), date: "1/26/2024, 09:00:00 AM", type:"deposit", clientId:"100", from:"external", to:"mainWallet", platform:"", category:"deposit", note:"Initial funding into Main Wallet", amount: 5000 },
        { id: uid(), date: "1/26/2024, 09:01:00 AM", type:"fee", clientId:"100", from:"", to:"feesCollected", platform:"", category:"wire_fee", note:"Wire processing fee", amount: 200 },

        { id: uid(), date: "2/01/2024, 09:16:05 AM", type:"transfer", clientId:"100", from:"mainWallet", to:"platformVault", platform:"facebook", category:"spend", note:"Funding Facebook vault", amount: 700 },
        { id: uid(), date: "2/02/2024, 10:10:00 AM", type:"transfer", clientId:"100", from:"mainWallet", to:"platformVault", platform:"google", category:"spend", note:"Funding Google vault", amount: 300 },

        { id: uid(), date: "2/03/2024, 11:00:00 AM", type:"allocation", clientId:"100", from:"platformVault", to:"generalBalance", platform:"facebook", category:"budget_general", note:"Allocate to General", amount: 200 },
        { id: uid(), date: "2/03/2024, 11:05:00 AM", type:"allocation", clientId:"100", from:"platformVault", to:"individualBalance", platform:"google", category:"budget_individual", note:"Allocate to Individual", amount: 150 },

        { id: uid(), date: "2/04/2024, 12:00:00 PM", type:"ind_to_account", clientId:"100", from:"individualBalance", to:"account:acc_2", platform:"", category:"ind_to_account", note:"Assign to acc_2", amount: 50 },

        { id: uid(), date: "2/16/2026, 10:12:55 AM", type:"setup_service", clientId:"100", from:"mainWallet", to:"setupServices", platform:"", category:"service", note:"Account: acc_1 | Service | BOV {...}", amount: 50 },
        { id: uid(), date: "2/16/2026, 10:12:55 AM", type:"setup_service", clientId:"100", from:"mainWallet", to:"setupServices", platform:"", category:"setup", note:"Account: acc_1 | one-time - Setup account #1", amount: 80 }
      ];
      state.platformFilter = "__all__";
      state.globalClient = "__all__";
      state.globalFrom = "";
      state.globalTo = "";
      state.ledgerTab = "all";
      state.topupsStatus = "__all__";
      save();
      refreshAll();
    }

    function addLedger(entry){
      state.ledger.unshift(entry);
      save();
      refreshAll();
    }

    /* DATE filter helper */
    function txDateToISO(txDateString){
      const d = new Date(txDateString);
      if(isNaN(d.getTime())) return null;
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function passesGlobalFilters(tx){
      if(state.globalClient !== "__all__"){
        if(String(tx.clientId || "") !== String(state.globalClient)) return false;
      }
      const iso = txDateToISO(tx.date);
      if(iso){
        if(state.globalFrom && iso < state.globalFrom) return false;
        if(state.globalTo && iso > state.globalTo) return false;
      }
      return true;
    }

    function matchesLedgerTab(tx){
      const t = state.ledgerTab;
      if(t === "all") return true;
      if(t === "topups") return tx.type === "topup" || tx.type === "deposit" || tx.to === "topups";
      if(t === "fees") return tx.type === "fee" || tx.to === "feesCollected";
      return ["transfer","allocation","ind_to_account","setup_service","refund"].includes(tx.type);
    }

    function getFilteredLedger(){
      return state.ledger.filter(tx => passesGlobalFilters(tx) && matchesLedgerTab(tx));
    }

    function onGlobalFiltersChanged(){
      state.globalClient = document.getElementById("global_client").value;
      state.globalFrom = document.getElementById("global_from").value;
      state.globalTo = document.getElementById("global_to").value;
      save();
      refreshAll();
    }

    function onTopupsStatusChanged(){
      state.topupsStatus = document.getElementById("topups_status").value;
      save();
      renderTopupsTable();
      populateGlobalClientFilter(); // refresh hint text
    }

    function clearGlobalFilters(){
      state.globalClient = "__all__";
      state.globalFrom = "";
      state.globalTo = "";
      state.topupsStatus = "__all__";
      document.getElementById("global_client").value = "__all__";
      document.getElementById("global_from").value = "";
      document.getElementById("global_to").value = "";
      document.getElementById("topups_status").value = "__all__";
      save();
      refreshAll();
    }

    function populateGlobalClientFilter(){
      const clientIds = new Set(["100","101","102"]);
      for(const tx of state.ledger){
        if(tx.clientId) clientIds.add(String(tx.clientId));
      }
      const sel = document.getElementById("global_client");
      const current = state.globalClient || "__all__";
      sel.innerHTML = `<option value="__all__">All clients</option>` +
        [...clientIds].sort().map(cid => `<option value="${cid}">${escapeHtml(getClientLabelById(cid))}</option>`).join("");
      sel.value = current;

      document.getElementById("global_from").value = state.globalFrom || "";
      document.getElementById("global_to").value = state.globalTo || "";
      document.getElementById("topups_status").value = state.topupsStatus || "__all__";

      const hint = document.getElementById("global_hint");
      const clientText = current === "__all__" ? "All clients" : getClientLabelById(current);
      const rangeText = (state.globalFrom || state.globalTo) ? `${state.globalFrom || "…"} → ${state.globalTo || "…"}`
                                                           : "All dates";
      const stText = (state.topupsStatus === "__all__") ? "All statuses" : state.topupsStatus.toUpperCase();
      hint.textContent = `Current view: ${clientText} • ${rangeText} • Topups Status: ${stText} • Ledger Tab: ${state.ledgerTab.toUpperCase()}`;
    }

    /* KPIs - based on FULL filtered by client/date ONLY */
    function getLedgerFilteredForKPIs(){
      return state.ledger.filter(passesGlobalFilters);
    }

    function calcKpis(){
      const ledger = getLedgerFilteredForKPIs();
      const out = {
        totalTopups: 0,
        mainWallet: 0,
        platformVault: { facebook:0, google:0, tiktok:0 },
        generalBalance: 0,
        individualBalance: 0,
        spend: 0,
        setupServices: 0,
        totalFees: 0
      };

      for(const tx of ledger){
        const amt = Number(tx.amount || 0);

        if(tx.type === "topup") out.totalTopups += amt;

        if(tx.to === "mainWallet") out.mainWallet += amt;
        if(tx.from === "mainWallet") out.mainWallet -= amt;

        if(tx.type === "transfer" && tx.from === "mainWallet" && tx.to === "platformVault"){
          out.spend += amt;
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] += amt;
        }

        if(tx.type === "allocation" && tx.from === "platformVault"){
          if(tx.platform && out.platformVault[tx.platform] != null) out.platformVault[tx.platform] -= amt;
          if(tx.to === "generalBalance") out.generalBalance += amt;
          if(tx.to === "individualBalance") out.individualBalance += amt;
        }

        if(tx.type === "ind_to_account" && tx.from === "individualBalance"){
          out.individualBalance -= amt;
        }

        if(tx.type === "setup_service" && tx.to === "setupServices"){
          out.setupServices += amt;
        }

        if(tx.to === "feesCollected"){
          out.totalFees += amt;
        }
      }
      return out;
    }

    function refreshKPIs(){
      const k = calcKpis();

      document.getElementById("kpi_totalTopups").textContent = money(k.totalTopups);
      document.getElementById("kpi_mainWallet").textContent = money(k.mainWallet);

      const pf = state.platformFilter;
      const vaultTotal = pf === "__all__"
        ? (k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok)
        : (k.platformVault[pf] || 0);

      document.getElementById("kpi_platformVault").textContent = money(vaultTotal);
      document.getElementById("kpi_generalBalance").textContent = money(k.generalBalance);
      document.getElementById("kpi_individualBalance").textContent = money(k.individualBalance);
      document.getElementById("kpi_spend").textContent = money(k.spend);
      document.getElementById("kpi_totalFees").textContent = money(k.totalFees);
      document.getElementById("kpi_setupServices").textContent = money(k.setupServices);

      document.getElementById("kpi_platformFilter").value = state.platformFilter;
    }

    document.getElementById("kpi_platformFilter").addEventListener("change", (e) => {
      state.platformFilter = e.target.value;
      save();
      refreshKPIs();
    });

    /* ✅ NEW: TOPUPS TABLE (client/date + status) */
    function passesTopupsStatusFilter(tx){
      if(state.topupsStatus === "__all__") return true;
      return String(tx.status || "").toLowerCase() === String(state.topupsStatus).toLowerCase();
    }

    function renderTopupsTable(){
      const topups = getLedgerFilteredForKPIs()
        .filter(tx => tx.type === "topup")
        .filter(passesTopupsStatusFilter)
        .slice()
        .sort((a,b) => (new Date(b.date)).getTime() - (new Date(a.date)).getTime());

      const body = document.getElementById("topupsTableBody");
      const hint = document.getElementById("topupsTableHint");

      if(!topups.length){
        body.innerHTML = `<tr><td colspan="7" class="td-muted">No topups found for current filters.</td></tr>`;
        hint.textContent = "";
        return;
      }

      body.innerHTML = topups.map(t => {
        const proof = t.proof ? escapeHtml(t.proof) : "-";
        const account = t.account ? escapeHtml(t.account) : "USD";
        const st = String(t.status || "pending").toLowerCase();
        const stLabel = st === "past_due" ? "Past Due" : (st.charAt(0).toUpperCase() + st.slice(1));
        const desc = (t.description && String(t.description).trim()) ? escapeHtml(t.description) : (t.note ? escapeHtml(t.note) : "--");

        return `
          <tr class="topups-row" onclick="openTopupDetails('${escapeHtml(t.id)}')">
            <td>${escapeHtml(t.date)}</td>
            <td>${escapeHtml(t.clientId || "")}</td>
            <td>${account}</td>
            <td class="td-muted">${proof}</td>
            <td class="td-right"><strong>${money(t.amount)}</strong></td>
            <td><span class="status-badge ${st}">${stLabel}</span></td>
            <td class="td-muted" style="max-width: 360px; overflow:hidden; text-overflow:ellipsis;">${desc}</td>
          </tr>
        `;
      }).join("");

      hint.textContent = `Showing ${topups.length} topups • Filtered by client/date + status. Click a row for details.`;
    }

    /* LEDGER PREVIEW (tabbed) */
    function buildShortDetails(tx){
      if(tx.type === "topup") return `${escapeHtml(tx.note || "Topup")} <span class="muted">(informative)</span>`;
      if(tx.type === "deposit") return `Deposit → <span class="muted">Main Wallet</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "fee") return `Fee → <span class="muted">Total Fees</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "refund") return `Refund → <span class="muted">External</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "transfer") return `Main → Vault(${escapeHtml(tx.platform || "")}) • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "allocation") return `Vault(${escapeHtml(tx.platform || "")}) → ${escapeHtml(tx.to)} • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "ind_to_account") return `Individual → <span class="muted">${escapeHtml(tx.to || "")}</span> • ${escapeHtml(tx.note || "")}`;
      if(tx.type === "setup_service") return `Main → Setup/Services • ${escapeHtml(tx.note || "")}`;
      return `${escapeHtml(tx.type)} • ${escapeHtml(tx.note || "")}`;
    }

    function refreshLedgerPreview(){
      const body = document.getElementById("ledgerPreviewBody");
      const preview = getFilteredLedger().slice(0, 8);

      body.innerHTML = preview.map(tx => {
        const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
        const tags = [
          `<span class="tag">${escapeHtml(tx.type.toUpperCase())}</span>`,
          tx.platform ? `<span class="tag">${escapeHtml(tx.platform)}</span>` : ""
        ].join(" ");

        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${tags}</td>
            <td>${buildShortDetails(tx)}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      document.getElementById("ledgerHint").textContent =
        `Showing latest ${preview.length} entries • Filtered by global client/date • Tab: ${state.ledgerTab.toUpperCase()}`;
    }

    function refreshLedgerModal(){
      const body = document.getElementById("ledgerAllBody");
      const ledger = getFilteredLedger();
      const k = calcKpis();

      body.innerHTML = ledger.map(tx => {
        const amountClass = (tx.from === "mainWallet" || tx.from === "individualBalance") ? "amount-neg" : "amount-pos";
        return `
          <tr>
            <td style="white-space:nowrap;">${escapeHtml(tx.date)}</td>
            <td>${escapeHtml(tx.type)}</td>
            <td>${escapeHtml((tx.from||"—") + " → " + (tx.to||"—"))}</td>
            <td>${escapeHtml(getClientLabelById(tx.clientId || "—"))}</td>
            <td>${escapeHtml(tx.platform || "—")}</td>
            <td>${escapeHtml(tx.category || "—")}</td>
            <td>${escapeHtml(tx.note || "")}</td>
            <td style="text-align:right;" class="${amountClass}">${money(tx.amount)}</td>
          </tr>
        `;
      }).join("");

      const vaultTotal = k.platformVault.facebook + k.platformVault.google + k.platformVault.tiktok;
      document.getElementById("ledgerTotalsHint").textContent =
        `MainWallet: ${money(k.mainWallet)} • VaultTotal: ${money(vaultTotal)} • General: ${money(k.generalBalance)} • Individual: ${money(k.individualBalance)} • Spend: ${money(k.spend)} • Fees: ${money(k.totalFees)} • Setup/Services: ${money(k.setupServices)} • TotalTopups: ${money(k.totalTopups)}`;
    }

    function openLedgerModal(){ refreshLedgerModal(); document.getElementById("ledgerModal").classList.add("active"); }
    function closeLedgerModal(){ document.getElementById("ledgerModal").classList.remove("active"); }

    /* WORKSPACE tabs (Funding / Setup) */
    document.getElementById("workspaceTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#workspaceTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const tab = pill.getAttribute("data-tab");
      document.getElementById("tab_funding").style.display = tab === "funding" ? "block" : "none";
      document.getElementById("tab_setup").style.display = tab === "setup" ? "block" : "none";
    });

    /* FUNDING SUBTABS */
    document.getElementById("fundingSubTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;

      document.querySelectorAll("#fundingSubTabs .pill").forEach(p => p.classList.remove("active"));
      pill.classList.add("active");

      const subtab = pill.getAttribute("data-subtab");
      document.getElementById("subtab_main_to_vault").style.display = subtab === "main_to_vault" ? "block" : "none";
      document.getElementById("subtab_vault_allocate").style.display = subtab === "vault_allocate" ? "block" : "none";
      document.getElementById("subtab_individual_to_account").style.display = subtab === "individual_to_account" ? "block" : "none";
    });

    /* LEDGER TABS */
    function setLedgerTab(tab){
      state.ledgerTab = tab;
      save();
      document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
      document.querySelector(`#ledgerTabs .pill[data-ledger="${tab}"]`)?.classList.add("active");
      refreshAll();
    }

    document.getElementById("ledgerTabs").addEventListener("click", (e) => {
      const pill = e.target.closest(".pill");
      if(!pill) return;
      setLedgerTab(pill.getAttribute("data-ledger"));
    });

    /* ACTION GUARD */
    function requireSpecificClient(){
      if(state.globalClient === "__all__"){
        alert("Select a specific client first (not 'All clients') to perform actions.");
        return false;
      }
      return true;
    }

    /* FUNDING / ALLOCATION / INDIVIDUAL SEND */
    function refreshFundingUI(){
      const k = calcKpis();
      document.getElementById("tx_fromHint").textContent =
        `Available in Main Wallet (filtered view): ${money(k.mainWallet)}`;

      toggleAllocAccountSelect();
      updateFundingPreview();
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateFundingPreview(){
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();
      const clientText = state.globalClient === "__all__" ? "All clients" : getClientLabelById(state.globalClient);

      document.getElementById("tx_preview").textContent =
        `Client: ${clientText} • Send ${money(amount)} Main → Vault (${platform})${note ? " • " + note : ""}`;
    }

    function submitMainToVault(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const platform = document.getElementById("tx_platform").value;
      const amount = Number(document.getElementById("tx_amount").value || 0);
      const note = (document.getElementById("tx_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }
      if(amount > k.mainWallet){
        alert(`Not enough funds in Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "transfer",
        clientId: String(state.globalClient),
        from: "mainWallet",
        to: "platformVault",
        platform,
        category: "spend",
        note: note || `Funding ${platform} vault`,
        amount
      });

      document.getElementById("tx_amount").value = "";
      document.getElementById("tx_note").value = "";
      updateFundingPreview();
    }

    function toggleAllocAccountSelect(){
      const to = document.getElementById("alloc_to").value;
      document.getElementById("alloc_accountGroup").style.display = (to === "account") ? "block" : "none";
    }

    function updateAllocationPreview(){
      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const account = document.getElementById("alloc_account").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      const available = k.platformVault[platform] || 0;
      document.getElementById("alloc_platformHint").textContent = `Available in ${platform} vault (filtered): ${money(available)}`;

      const targetText = (to === "account") ? `Account (${account})` : to;
      document.getElementById("alloc_preview").textContent =
        `Allocate ${money(amount)} Vault(${platform}) → ${targetText}${note ? " • " + note : ""}`;
    }

    function submitAllocation(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const platform = document.getElementById("alloc_platform").value;
      const to = document.getElementById("alloc_to").value;
      const account = document.getElementById("alloc_account").value;
      const amount = Number(document.getElementById("alloc_amount").value || 0);
      const note = (document.getElementById("alloc_note").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }

      const available = k.platformVault[platform] || 0;
      if(amount > available){
        alert(`Not enough funds in ${platform} vault (filtered). Available: ${money(available)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "allocation",
        clientId: String(state.globalClient),
        from: "platformVault",
        to: to,
        platform,
        category: to === "generalBalance" ? "budget_general"
                : to === "individualBalance" ? "budget_individual"
                : "budget_account",
        note: (to === "account" ? `Account: ${account}` : "") + (note ? (" • " + note) : ""),
        amount
      });

      document.getElementById("alloc_amount").value = "";
      document.getElementById("alloc_note").value = "";
      updateAllocationPreview();
      updateIndToAccountPreview();
    }

    function updateIndToAccountPreview(){
      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      document.getElementById("ind_fromHint").textContent =
        `Available in Individual Balance (filtered): ${money(k.individualBalance)}`;

      const clientText = state.globalClient === "__all__" ? "All clients" : getClientLabelById(state.globalClient);
      document.getElementById("ind_preview").textContent =
        `Client: ${clientText} • Send ${money(amount)} Individual → ${account}${note ? " • " + note : ""}`;
    }

    function submitIndividualToAccount(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const account = document.getElementById("ind_toAccount").value;
      const amount = Number(document.getElementById("ind_amount").value || 0);
      const note = (document.getElementById("ind_note").value || "").trim();

      if(!amount || amount <= 0){
        alert("Please enter a valid amount.");
        return;
      }

      if(amount > k.individualBalance){
        alert(`Not enough funds in Individual Balance (filtered). Available: ${money(k.individualBalance)}`);
        return;
      }

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "ind_to_account",
        clientId: String(state.globalClient),
        from: "individualBalance",
        to: `account:${account}`,
        platform: "",
        category: "ind_to_account",
        note: note || `Assign to ${account}`,
        amount
      });

      document.getElementById("ind_amount").value = "";
      document.getElementById("ind_note").value = "";
      updateIndToAccountPreview();
    }

    function submitSetupServiceCharge(){
      if(!requireSpecificClient()) return;

      const k = calcKpis();
      const type = document.getElementById("charge_type").value;
      const model = document.getElementById("charge_model").value;
      const linked = document.getElementById("charge_linked").value;
      const amount = Number(document.getElementById("charge_amount").value || 0);
      const details = (document.getElementById("charge_details").value || "").trim();

      if(!amount || amount <= 0){ alert("Please enter a valid amount."); return; }
      if(amount > k.mainWallet){
        alert(`Not enough funds in Main Wallet (filtered). Available: ${money(k.mainWallet)}`);
        return;
      }

      const title = type === "setup" ? "Setup" : "Service";
      const note = `Account: ${linked} | ${model} - ${title}${details ? " | " + details : ""}`;

      addLedger({
        id: uid(),
        date: nowISO(),
        type: "setup_service",
        clientId: String(state.globalClient),
        from: "mainWallet",
        to: "setupServices",
        platform: "",
        category: type,
        note,
        amount
      });

      document.getElementById("charge_amount").value = "";
      document.getElementById("charge_details").value = "";
    }

    /* Add Topup Drawer logic */
    let activeTopupTab = "wire";

    function openTopupDrawer(){
      document.getElementById("topupDrawer").classList.add("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "false");

      if(state.globalClient !== "__all__"){
        document.getElementById("topup_client").value = String(state.globalClient);
      }
      recalcWireNet();
      validateTopupForm();
    }
    function closeTopupDrawer(){
      document.getElementById("topupDrawer").classList.remove("active");
      document.getElementById("topupDrawer").setAttribute("aria-hidden", "true");
    }

    function switchTopupTab(tab){
      activeTopupTab = tab;

      document.querySelectorAll("#topupTabs .seg-btn").forEach(b => b.classList.remove("active"));
      document.querySelector(`#topupTabs .seg-btn[data-tab="${tab}"]`).classList.add("active");

      document.getElementById("tab_wire").style.display = tab === "wire" ? "block" : "none";
      document.getElementById("tab_crypto").style.display = tab === "crypto" ? "block" : "none";
      document.getElementById("tab_special").style.display = tab === "special" ? "block" : "none";
      document.getElementById("tab_refund").style.display = tab === "refund" ? "block" : "none";

      validateTopupForm();
    }

    function recalcWireNet(){
      const gross = Number(document.getElementById("wire_gross").value || 0);
      const fee = Number(document.getElementById("wire_fee").value || 0);
      const net = Math.max(0, +(gross - fee).toFixed(2));
      document.getElementById("wire_net").value = net ? net : "";
      validateTopupForm();
    }

    function validateTopupForm(){
      const btn = document.getElementById("topupSubmitBtn");
      let ok = true;

      if(activeTopupTab === "wire"){
        const account = document.getElementById("wire_account").value;
        const net = Number(document.getElementById("wire_net").value || 0);
        ok = !!account && net > 0;
      }
      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();
        ok = !!method && net > 0 && !!network && !!hash;
      }
      if(activeTopupTab === "special"){
        const net = Number(document.getElementById("special_net").value || 0);
        ok = net > 0;
      }
      if(activeTopupTab === "refund"){
        const net = Number(document.getElementById("refund_net").value || 0);
        ok = net > 0;
      }

      btn.classList.toggle("btn-disabled", !ok);
    }

    ["crypto_method","crypto_net","crypto_network","crypto_hash","special_net","refund_net","wire_account","wire_gross","wire_fee"].forEach(id=>{
      const el = document.getElementById(id);
      if(el){
        el.addEventListener("input", validateTopupForm);
        el.addEventListener("change", validateTopupForm);
      }
    });

    function submitTopup(){
      validateTopupForm();
      const btn = document.getElementById("topupSubmitBtn");
      if(btn.classList.contains("btn-disabled")) return;

      const clientId = document.getElementById("topup_client").value;

      function nextTopupId(){
        // simple demo topupId generator
        const base = 100100;
        const count = state.ledger.filter(x => x.type === "topup").length;
        return String(base + count + 1);
      }

      function addTopupDepositAndFee({ topupAmount, netAmount, feeAmount, category, note, proof, account, description, grossAmount }){
        const topupId = nextTopupId();

        addLedger({
          id: uid(),
          topupId,
          date: nowISO(),
          type: "topup",
          clientId,
          from: "external",
          to: "topups",
          platform: "",
          category,
          status: "pending",           // ✅ default, editable in modal
          account: account || "USD",
          proof: proof || "-",
          description: description || "--",
          grossAmount: Number(grossAmount || topupAmount || 0),
          feeAmount: Number(feeAmount || 0),
          netAmount: Number(netAmount || topupAmount || 0),
          note: note || "Topup",
          amount: Number(topupAmount)
        });

        addLedger({
          id: uid(),
          date: nowISO(),
          type: "deposit",
          clientId,
          from: "external",
          to: "mainWallet",
          platform: "",
          category: "deposit",
          note: `Topup credited to Main Wallet (${category})`,
          amount: Number(netAmount)
        });

        const f = Number(feeAmount || 0);
        if(f > 0){
          addLedger({
            id: uid(),
            date: nowISO(),
            type: "fee",
            clientId,
            from: "",
            to: "feesCollected",
            platform: "",
            category: category + "_fee",
            note: `Fee collected (${category})`,
            amount: f
          });
        }
      }

      if(activeTopupTab === "wire"){
        const company = (document.getElementById("wire_company").value || "").trim();
        const accountSel = document.getElementById("wire_account").value;
        const gross = Number(document.getElementById("wire_gross").value || 0);
        const fee = Number(document.getElementById("wire_fee").value || 0);
        const net = Number(document.getElementById("wire_net").value || 0);
        const desc = (document.getElementById("wire_desc").value || "").trim();
        const invoice = document.getElementById("wire_invoice").files?.[0]?.name || "";

        addTopupDepositAndFee({
          topupAmount: net,
          netAmount: net,
          feeAmount: fee,
          grossAmount: gross || net,
          category: "wire",
          account: "USD",
          proof: invoice || "-",
          description: desc || "--",
          note: `Client ${getClientLabelById(clientId)} | Wire${company ? " | " + company : ""} | Account: ${accountSel} | Gross: ${gross || net}`
        });

        document.getElementById("wire_company").value = "";
        document.getElementById("wire_account").value = "";
        document.getElementById("wire_gross").value = "";
        document.getElementById("wire_fee").value = "";
        document.getElementById("wire_net").value = "";
        document.getElementById("wire_desc").value = "";
        document.getElementById("wire_invoice").value = "";
      }

      if(activeTopupTab === "crypto"){
        const method = document.getElementById("crypto_method").value;
        const net = Number(document.getElementById("crypto_net").value || 0);
        const gross = Number(document.getElementById("crypto_gross").value || 0);
        const desc = (document.getElementById("crypto_desc").value || "").trim();
        const network = document.getElementById("crypto_network").value;
        const hash = (document.getElementById("crypto_hash").value || "").trim();

        const fee = gross > 0 ? Math.max(0, +(gross - net).toFixed(2)) : 0;
        document.getElementById("crypto_fee_hint").textContent = "Fee: " + fee.toFixed(2);

        addTopupDepositAndFee({
          topupAmount: net,
          netAmount: net,
          feeAmount: fee,
          grossAmount: gross || net,
          category: "crypto",
          account: method || "USDT",
          proof: hash,
          description: desc || `${method || "Crypto"} ${network}`,
          note: `Client ${getClientLabelById(clientId)} | Crypto ${method} | ${network} | Hash: ${hash}`
        });

        document.getElementById("crypto_method").value = "";
        document.getElementById("crypto_net").value = "";
        document.getElementById("crypto_gross").value = "";
        document.getElementById("crypto_desc").value = "";
        document.getElementById("crypto_network").value = "";
        document.getElementById("crypto_hash").value = "";
        document.getElementById("crypto_fee_hint").textContent = "Fee: 0.00";
      }

      if(activeTopupTab === "refund"){
        const k = calcKpis();
        const net = Number(document.getElementById("refund_net").value || 0);
        const account = document.getElementById("refund_account").value;
        const desc = (document.getElementById("refund_desc").value || "").trim();

        if(net > k.mainWallet){
          alert(`Refund amount exceeds filtered Main Wallet. Available: ${money(k.mainWallet)}`);
          return;
        }

        addLedger({
          id: uid(),
          date: nowISO(),
          type: "refund",
          clientId,
          from: "mainWallet",
          to: "external",
          platform: "",
          category: "refund",
          note: `Client ${getClientLabelById(clientId)} | Refund${account ? " | Account: " + account : ""}${desc ? " | " + desc : ""}`,
          amount: net
        });

        document.getElementById("refund_account").value = "";
        document.getElementById("refund_net").value = "";
        document.getElementById("refund_desc").value = "";
      }

      closeTopupDrawer();
    }

    function exportLedgerJson(){
      const json = JSON.stringify({ ledger: state.ledger }, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "finance-ledger-demo.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    /* ✅ NEW: Topup details modal logic */
    function findTopupById(id){
      return state.ledger.find(tx => String(tx.id) === String(id));
    }

    function statusBadgeClass(st){
      const s = String(st || "pending").toLowerCase();
      if(s === "approved") return "approved";
      if(s === "declined") return "declined";
      if(s === "past_due") return "past_due";
      return "pending";
    }

    function formatDatetimeLocalFromTx(tx){
      const d = new Date(tx.date);
      if(isNaN(d.getTime())) return "";
      const pad = (n)=>String(n).padStart(2,"0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function openTopupDetails(id){
      const tx = findTopupById(id);
      if(!tx || tx.type !== "topup") return;

      state.activeTopupModalId = id;

      const kv = document.getElementById("topupKvCard");
      kv.innerHTML = `
        <div class="kv-row"><div class="kv-key">User ID:</div><div class="kv-val">${escapeHtml(tx.clientId || "")}</div></div>
        <div class="kv-row"><div class="kv-key">Top-Up ID:</div><div class="kv-val">${escapeHtml(tx.topupId || tx.id)}</div></div>
        <div class="kv-row"><div class="kv-key">Full Name:</div><div class="kv-val">${escapeHtml(getClientNameById(tx.clientId || ""))}</div></div>
        <div class="kv-row"><div class="kv-key">Gross Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.grossAmount ?? tx.amount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Fee Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.feeAmount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Net Amount:</div><div class="kv-val">${escapeHtml(String(Number(tx.netAmount ?? tx.amount ?? 0).toFixed(2)))} ${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Account:</div><div class="kv-val">${escapeHtml(tx.account || "USD")}</div></div>
        <div class="kv-row"><div class="kv-key">Type:</div><div class="kv-val">${escapeHtml(tx.category || "—")}</div></div>
      `;

      document.getElementById("topupModalDesc").value = (tx.description && String(tx.description).trim()) ? tx.description : (tx.note || "--");
      document.getElementById("topupModalDate").value = formatDatetimeLocalFromTx(tx);

      setTopupModalStatus(String(tx.status || "pending").toLowerCase(), true);

      document.getElementById("topupDetailsModal").classList.add("active");
      document.getElementById("topupDetailsModal").setAttribute("aria-hidden", "false");
    }

    function closeTopupDetails(){
      state.activeTopupModalId = null;
      document.getElementById("topupDetailsModal").classList.remove("active");
      document.getElementById("topupDetailsModal").setAttribute("aria-hidden", "true");
    }

    function setTopupModalStatus(status, silent){
      const st = String(status || "pending").toLowerCase();
      const seg = document.getElementById("topupStatusSeg");
      seg.querySelectorAll(".seg-pill").forEach(p => {
        p.classList.remove("active","pending","approved","declined","past_due");
      });

      const el = seg.querySelector(`.seg-pill[data-status="${st}"]`);
      if(el){
        el.classList.add("active", st);
      }

      if(!silent){
        const tx = findTopupById(state.activeTopupModalId);
        if(tx) tx.status = st;
      }
    }

    function saveTopupDetails(){
      const tx = findTopupById(state.activeTopupModalId);
      if(!tx) return;

      tx.description = (document.getElementById("topupModalDesc").value || "").trim() || "--";

      const dt = document.getElementById("topupModalDate").value;
      if(dt){
        const d = new Date(dt);
        if(!isNaN(d.getTime())){
          tx.date = d.toLocaleString();
        }
      }

      save();
      refreshAll();
      closeTopupDetails();
    }

    /* Boot */
    function refreshAll(){
      populateGlobalClientFilter();
      refreshKPIs();
      refreshFundingUI();
      renderTopupsTable();
      refreshLedgerPreview();

      if(document.getElementById("ledgerModal").classList.contains("active")){
        refreshLedgerModal();
      }
    }

    load();

    // init ledger tabs active state
    document.querySelectorAll("#ledgerTabs .pill").forEach(p => p.classList.remove("active"));
    document.querySelector(`#ledgerTabs .pill[data-ledger="${state.ledgerTab}"]`)?.classList.add("active");

    refreshAll();
  </script>
</body>
</html>
