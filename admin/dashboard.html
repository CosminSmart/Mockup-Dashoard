<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/sidebar.css">
  
  <!-- Google Charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root{
      --bg: #f6f7fb;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: rgba(15,23,42,.10);
      --shadow: 0 12px 30px rgba(15,23,42,.08);

      --green: #10b981;
      --red: #ef4444;
      --blue: #2563eb;
      --amber: #f59e0b;
      --violet: #8b5cf6;

      --r: 16px;
      --gap: 16px;
    }

    body{ 
      background: var(--bg) !important; 
      color: var(--text);
    }

    .header{
      background: rgba(255,255,255,.92) !important;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 8px 20px rgba(15,23,42,.06) !important;
    }
    
    .header h1{
      margin: 0;
      font-size: 24px;
      font-weight: 900;
      color: var(--text);
    }

    .main{ 
      padding: 24px !important;
    }

    /* Dashboard Grid */
    .dash-grid{ display: grid; gap: var(--gap); }

    /* KPI Cards */
    .kpi-row{
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
    }
    @media (max-width: 1100px){ .kpi-row{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px){ .kpi-row{ grid-template-columns: 1fr; } }

    .kpi-card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }
    .kpi-card:before{
      content: "";
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--blue);
    }
    .kpi-card.green:before{ background: var(--green); }
    .kpi-card.amber:before{ background: var(--amber); }
    .kpi-card.violet:before{ background: var(--violet); }

    .kpi-label{
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      font-weight: 700;
      margin-bottom: 8px;
    }
    .kpi-value{
      font-size: 32px;
      font-weight: 900;
      color: var(--text);
      letter-spacing: -0.5px;
    }
    .kpi-sub{
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
      font-weight: 600;
    }

    /* Content Row */
    .content-row{
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: var(--gap);
    }
    @media (max-width: 1000px){ .content-row{ grid-template-columns: 1fr; } }

    /* Card */
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header{
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(15,23,42,.02), transparent);
    }
    .card-title{
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
      margin: 0;
    }
    .card-subtitle{
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    .card-body{
      padding: 20px;
    }

    /* Table */
    table{
      width: 100%;
      border-collapse: collapse;
    }
    thead th{
      text-align: left;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      padding: 12px;
      font-weight: 800;
      border-bottom: 1px solid var(--border);
    }
    tbody td{
      padding: 14px 12px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    tbody tr:last-child td{ border-bottom: none; }
    tbody tr:hover{ background: rgba(37,99,235,.04); }

    .name{
      font-weight: 800;
      color: var(--text);
    }
    .email{
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }

    .action-btn{
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--panel);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn.approve{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.30);
      color: #065f46;
    }
    .action-btn.approve:hover{
      background: rgba(16,185,129,.20);
    }
    .action-btn.reject{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.30);
      color: #991b1b;
    }
    .action-btn.reject:hover{
      background: rgba(239,68,68,.20);
    }

    .badge{
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.04);
    }
    .badge.active{
      background: rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.30);
      color: #065f46;
    }
    .badge.pending{
      background: rgba(245,158,11,.12);
      border-color: rgba(245,158,11,.30);
      color: #92400e;
    }
    .badge.suspended{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.30);
      color: #991b1b;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #94a3b8;
    }
    .badge.active .dot{ background: var(--green); }
    .badge.pending .dot{ background: var(--amber); }
    .badge.suspended .dot{ background: var(--red); }

    /* Activity List */
    .topup-list{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .topup-item{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(245,158,11,.05);
      border-color: rgba(245,158,11,.20);
    }
    .topup-info{
      flex: 1;
    }
    .topup-client{
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }
    .topup-details{
      font-size: 13px;
      color: var(--muted);
    }
    .topup-amount{
      font-size: 18px;
      font-weight: 900;
      color: var(--amber);
    }

    /* Fee Breakdown with Google Charts */
    .fee-breakdown{
      padding: 20px;
      min-height: 450px;
    }

    #feeChart{
      width: 100%;
      height: 400px;
    }

    /* Client Stats */
    .client-stats{
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .stat-item{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(15,23,42,.02);
    }
    .stat-label{
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }
    .stat-value{
      font-size: 24px;
      font-weight: 900;
      color: var(--text);
    }
    .stat-bar{
      margin-top: 8px;
      height: 6px;
      background: rgba(15,23,42,.08);
      border-radius: 3px;
      overflow: hidden;
    }
    .stat-bar-fill{
      height: 100%;
      background: var(--blue);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .stat-bar-fill.green{ background: var(--green); }
    .stat-bar-fill.amber{ background: var(--amber); }
    .stat-bar-fill.red{ background: var(--red); }

    /* Platform Stats */
    .platform-stats{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .platform-item{
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(15,23,42,.02);
    }
    .platform-info{
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .platform-icon{
      font-size: 20px;
    }
    .platform-name{
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }
    .platform-balance{
      font-size: 16px;
      font-weight: 900;
      color: var(--text);
    }
  </style>
</head>

<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar"></aside>

    <header class="header">
      <div>
        <h1>ðŸ“Š Dashboard</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <span>Admin User</span>
          <div class="user-avatar">AU</div>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="dash-grid">
        
        <!-- KPI Cards -->
        <div class="kpi-row">
          <div class="kpi-card blue">
            <div class="kpi-label">Main Wallet</div>
            <div class="kpi-value" id="kpiMainWallet">$0.00</div>
            <div class="kpi-sub">Available balance</div>
          </div>

          <div class="kpi-card green">
            <div class="kpi-label">Total Topups</div>
            <div class="kpi-value" id="kpiTopups">$0.00</div>
            <div class="kpi-sub">All time deposits</div>
          </div>

          <div class="kpi-card amber">
            <div class="kpi-label">Platform Spend</div>
            <div class="kpi-value" id="kpiSpend">$0.00</div>
            <div class="kpi-sub">Allocated to platforms</div>
          </div>

          <div class="kpi-card violet">
            <div class="kpi-label">Total Fees</div>
            <div class="kpi-value" id="kpiFees">$0.00</div>
            <div class="kpi-sub">Collected fees</div>
          </div>
        </div>

        <!-- Content Row -->
        <div class="content-row">
          <!-- Pending Clients -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Pending Clients</h2>
              <div class="card-subtitle">Awaiting approval</div>
            </div>
            <div class="card-body" style="padding: 0;">
              <table>
                <thead>
                  <tr>
                    <th>Client</th>
                    <th>Registered</th>
                    <th>Type</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="pendingClientsTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Pending Topups -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Pending Topups</h2>
              <div class="card-subtitle">Awaiting approval</div>
            </div>
            <div class="card-body">
              <div class="topup-list" id="topupList">
                <!-- Populated by JS -->
              </div>
            </div>
          </div>
        </div>

        <!-- Second Row -->
        <div class="content-row">
          <!-- Fee Breakdown -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Fee Breakdown</h2>
              <div class="card-subtitle">Revenue by fee type</div>
            </div>
            <div class="card-body">
              <div class="fee-breakdown">
                <div id="feeChart"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script src="../js/sidebar.js"></script>
  <script>
    // Demo data matching finance page structure
    const LS_KEY = "admin_finance_demo_v7";

    const pendingClients = [
      { name: "John D.", email: "john@example.com", registered: "2 days ago", type: "Client" },
      { name: "Sarah K.", email: "sarah@example.com", registered: "3 days ago", type: "Employee" },
      { name: "Mike R.", email: "mike@example.com", registered: "5 days ago", type: "Client" }
    ];

    const clients = [
      { id: "100", name: "Alex M.", email: "alex@example.com", role: "Client", status: "active", balance: 2450.00 },
      { id: "101", name: "Maria P.", email: "maria@example.com", role: "Client", status: "active", balance: 1890.50 },
      { id: "102", name: "John D.", email: "john@example.com", role: "Client", status: "pending", balance: 0 },
      { id: "103", name: "Sarah K.", email: "sarah@example.com", role: "Employee", status: "active", balance: 0 },
    ];

    const platforms = [
      { name: "Facebook", icon: "ðŸ“˜", balance: 1250.00 },
      { name: "Google", icon: "ðŸ”", balance: 890.50 },
      { name: "TikTok", icon: "ðŸŽµ", balance: 650.00 },
      { name: "Instagram", icon: "ðŸ“·", balance: 420.75 }
    ];

    const pendingTopups = [
      { client: "Alex M.", amount: 1500.00, type: "Wire", date: "Today" },
      { client: "Maria P.", amount: 1200.00, type: "Wire", date: "Today" },
      { client: "John D.", amount: 1000.00, type: "Crypto USDT", date: "Yesterday" }
    ];

    const feeBreakdown = [
      { type: "Topup Fees", icon: "ðŸ’°", amount: 20.00 },
      { type: "Transfer Fees", icon: "ðŸ”„", amount: 5.00 },
      { type: "Service Charges", icon: "âš™ï¸", amount: 0.00 },
      { type: "Setup Charges", icon: "ðŸ”§", amount: 0.00 }
    ];

    const clientStatistics = {
      totalClients: 12,
      activeClients: 9,
      pendingApproval: 2,
      suspended: 1
    };

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    function loadFinanceData(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return null;
      try{
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function calculateKPIs(){
      const data = loadFinanceData();
      if(!data || !data.ledger) return { mainWallet: 2450, topups: 980, spend: 700, fees: 25 };

      let mainWallet = 0;
      let topups = 0;
      let spend = 0;
      let fees = 0;

      data.ledger.forEach(tx => {
        const amt = Number(tx.amount || 0);
        
        if(tx.type === "topup") topups += amt;
        if(tx.to === "mainWallet") mainWallet += amt;
        if(tx.from === "mainWallet") mainWallet -= amt;
        if(tx.type === "transfer" && tx.from === "mainWallet") spend += amt;
        if(tx.type === "fee" || tx.category?.includes("fee")) fees += amt;
      });

      return { mainWallet, topups, spend, fees };
    }

    function renderKPIs(){
      const kpis = calculateKPIs();
      
      document.getElementById("kpiMainWallet").textContent = money(kpis.mainWallet);
      document.getElementById("kpiTopups").textContent = money(kpis.topups);
      document.getElementById("kpiSpend").textContent = money(kpis.spend);
      document.getElementById("kpiFees").textContent = money(kpis.fees);
    }

    function renderPendingClients(){
      const tbody = document.getElementById("pendingClientsTable");
      
      if(pendingClients.length === 0){
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--muted);">No pending clients</td></tr>';
        return;
      }
      
      tbody.innerHTML = pendingClients.map(client => `
        <tr>
          <td>
            <div class="name">${client.name}</div>
            <div class="email">${client.email}</div>
          </td>
          <td>${client.registered}</td>
          <td>
            <span class="badge pending">
              <span class="dot"></span>
              ${client.type}
            </span>
          </td>
          <td>
            <div style="display: flex; gap: 8px;">
              <button class="action-btn approve" onclick="approveClient('${client.name}')">âœ“ Approve</button>
              <button class="action-btn reject" onclick="rejectClient('${client.name}')">âœ— Reject</button>
            </div>
          </td>
        </tr>
      `).join("");
    }

    function approveClient(name){
      alert(`Approved: ${name}`);
      // Here you would call your API to approve the client
    }

    function rejectClient(name){
      alert(`Rejected: ${name}`);
      // Here you would call your API to reject the client
    }

    function renderClients(){
      const tbody = document.getElementById("clientsTable");
      
      tbody.innerHTML = clients.map(client => `
        <tr>
          <td>
            <div class="name">${client.name}</div>
            <div class="email">${client.email}</div>
          </td>
          <td>${client.role}</td>
          <td>
            <span class="badge ${client.status}">
              <span class="dot"></span>
              ${client.status.charAt(0).toUpperCase() + client.status.slice(1)}
            </span>
          </td>
          <td style="font-weight: 700;">${money(client.balance)}</td>
        </tr>
      `).join("");
    }

    function renderTopups(){
      const list = document.getElementById("topupList");
      
      if(pendingTopups.length === 0){
        list.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 20px;">No pending topups</div>';
        return;
      }
      
      list.innerHTML = pendingTopups.map(topup => `
        <div class="topup-item">
          <div class="topup-info">
            <div class="topup-client">${topup.client}</div>
            <div class="topup-details">${topup.type} â€¢ ${topup.date}</div>
          </div>
          <div class="topup-amount">${money(topup.amount)}</div>
        </div>
      `).join("");
    }

    // Load Google Charts
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawFeeChart);

    function drawFeeChart() {
      // Prepare data for Google Charts
      const chartData = [['Task', 'Hours per Day']];
      feeBreakdown.forEach(fee => {
        chartData.push([fee.type, fee.amount]);
      });

      const data = google.visualization.arrayToDataTable(chartData);

      const options = {
        title: 'Fee Breakdown',
        pieHole: 0.4, // Creates a Donut Chart. Does not do anything when is3D is enabled
        is3D: true, // Enables 3D view
        pieStartAngle: 100, // Rotates the chart
        sliceVisibilityThreshold: 0.02, // Hides slices smaller than 2%
        legend: {
          position: 'bottom',
          alignment: 'center',
          textStyle: {
            color: '#233238',
            fontSize: 14,
          },
        },
        colors: ['#8AD1C2', '#9F8AD1', '#D18A99', '#BCD18A', '#D1C28A'],
      };

      const chart = new google.visualization.PieChart(document.getElementById('feeChart'));
      chart.draw(data, options);
    }

    // Redraw chart on window resize
    window.addEventListener('resize', () => {
      if (typeof google !== 'undefined' && google.visualization) {
        drawFeeChart();
      }
    });

    function renderClientStats(){
      const container = document.getElementById("clientStats");
      const total = clientStatistics.totalClients;
      
      container.innerHTML = `
        <div class="stat-item">
          <div>
            <div class="stat-label">Total Clients</div>
            <div class="stat-bar">
              <div class="stat-bar-fill" style="width: 100%;"></div>
            </div>
          </div>
          <div class="stat-value">${clientStatistics.totalClients}</div>
        </div>
        
        <div class="stat-item">
          <div>
            <div class="stat-label">Active Clients</div>
            <div class="stat-bar">
              <div class="stat-bar-fill green" style="width: ${(clientStatistics.activeClients / total * 100).toFixed(0)}%;"></div>
            </div>
          </div>
          <div class="stat-value">${clientStatistics.activeClients}</div>
        </div>
        
        <div class="stat-item">
          <div>
            <div class="stat-label">Pending Approval</div>
            <div class="stat-bar">
              <div class="stat-bar-fill amber" style="width: ${(clientStatistics.pendingApproval / total * 100).toFixed(0)}%;"></div>
            </div>
          </div>
          <div class="stat-value">${clientStatistics.pendingApproval}</div>
        </div>
        
        <div class="stat-item">
          <div>
            <div class="stat-label">Suspended</div>
            <div class="stat-bar">
              <div class="stat-bar-fill red" style="width: ${(clientStatistics.suspended / total * 100).toFixed(0)}%;"></div>
            </div>
          </div>
          <div class="stat-value">${clientStatistics.suspended}</div>
        </div>
      `;
    }

    function renderPlatforms(){
      const container = document.getElementById("platformStats");
      
      container.innerHTML = platforms.map(platform => `
        <div class="platform-item">
          <div class="platform-info">
            <span class="platform-icon">${platform.icon}</span>
            <span class="platform-name">${platform.name}</span>
          </div>
          <div class="platform-balance">${money(platform.balance)}</div>
        </div>
      `).join("");
    }

    // Initialize dashboard
    document.addEventListener("DOMContentLoaded", function(){
      renderKPIs();
      renderPendingClients();
      renderTopups();
      // Fee chart is drawn by Google Charts callback
      renderClientStats();
      renderPlatforms();
    });
  </script>
</body>
</html>
