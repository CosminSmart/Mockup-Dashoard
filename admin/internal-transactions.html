<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Internal Transactions • Admin Finance</title>

  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/dashboard.css" />
  <link rel="stylesheet" href="../css/sidebar.css" />
  <link rel="stylesheet" href="../css/accounts.css" />

  <style>
    /* =========================================================
       LIQUID GLASS (WHITE) – TOPUPS PAGE
    ========================================================= */
    :root{
      --bg0:#f7f8fb;
      --bg1:#ffffff;
      --text:#0f172a;
      --muted:#64748b;

      --line: rgba(15,23,42,.10);
      --line2: rgba(15,23,42,.07);

      --glass: rgba(255,255,255,.72);
      --glass2: rgba(255,255,255,.58);

      --shadow: 0 18px 50px rgba(15,23,42,.12);
      --shadow2: 0 12px 28px rgba(15,23,42,.10);

      --r-xl: 18px;
      --r-lg: 14px;
      --r-md: 12px;

      --good:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#2563eb;

      --focus: rgba(37,99,235,.25);
    }
    [data-theme="dark"]{
      --bg0:#0b1220;
      --bg1:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;

      --line: rgba(255,255,255,.12);
      --line2: rgba(255,255,255,.08);

      --glass: rgba(17,24,39,.58);
      --glass2: rgba(17,24,39,.45);

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 12px 28px rgba(0,0,0,.35);

      --focus: rgba(96,165,250,.25);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }

    body{
      color: var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(37,99,235,.14), transparent 60%),
        radial-gradient(900px 520px at 90% 20%, rgba(99,102,241,.14), transparent 55%),
        radial-gradient(900px 600px at 35% 95%, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0) 0%, color-mix(in srgb, var(--bg0) 55%, var(--bg1)) 100%);
    }
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.06;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
    }

    body.modal-open{ overflow:hidden; }

    .muted{ color: var(--muted); }
    .mini-hint{ font-size:.9rem; color: var(--muted); line-height:1.35; margin-top:.2rem; }

    input, select, textarea{
      width:100%;
      padding:.7rem .8rem;
      border:1px solid var(--line2);
      border-radius: 12px;
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
      color: var(--text);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: color-mix(in srgb, var(--info) 45%, var(--line2));
      box-shadow: 0 0 0 4px var(--focus);
    }

    /* Header (tabs + theme + user) */
    .header{
      background: rgba(255,255,255,.55);
      border-bottom: 1px solid var(--line2);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 12px 18px;
    }
    [data-theme="dark"] .header{ background: rgba(15,23,42,.55); }

    .header-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 280px;
    }
    .page-tabs{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      width: fit-content;
    }
    .page-tab{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      cursor:pointer;
      transition: background .12s ease, color .12s ease, border-color .12s ease, transform .12s ease;
      user-select:none;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .page-tab:hover{ transform: translateY(-1px); }
    .page-tab.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }

    .header-right{ display:flex; align-items:center; gap:14px; }

    .theme-toggle{
      display:flex;
      gap:8px;
      padding:6px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .theme-btn{
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      cursor:pointer;
      transition: background .12s ease, color .12s ease, border-color .12s ease;
    }
    .theme-btn.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }

    .main{ padding: 18px; }
    @media (max-width: 720px){ .main{ padding: 14px; } }

    @media (max-width: 980px){
      .header{ flex-wrap:wrap; align-items:flex-start; }
      .header-left{ width:100%; }
      .page-tabs{ width:100%; justify-content:space-between; }
      .page-tab{ flex:1; text-align:center; }
    }

    /* Panels */
    .glass-panel{
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: var(--r-xl);
      padding: 16px;
    }

    /* Buttons */
    .btn{
      border: 1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
      color: var(--text);
      padding: .7rem .95rem;
      border-radius: 14px;
      font-weight: 800;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.55rem;
      white-space:nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: color-mix(in srgb, rgba(37,99,235,.20) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.35) 55%, var(--line2));
    }
    .btn.ghost{
      background: color-mix(in srgb, rgba(148,163,184,.18) 70%, var(--glass));
    }
    .btn.danger{
      background: color-mix(in srgb, rgba(239,68,68,.16) 70%, var(--glass));
      border-color: color-mix(in srgb, rgba(239,68,68,.32) 60%, var(--line2));
      color: #991b1b;
    }
    .btn[disabled], .btn.disabled{
      opacity:.55;
      pointer-events:none;
    }

    .top-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .top-head__title{
      font-weight:950;
      font-size:1.15rem;
      letter-spacing:.2px;
    }

    /* Filters bar (match screenshot style) */
    .filters{
      position: sticky;
      top: 10px;
      z-index: 50;
      padding: 12px;
      border-radius: var(--r-xl);
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .filters__row{
      display:grid;
      grid-template-columns:
        1.25fr
        220px
        340px
        180px
        170px
        170px
        auto;
      gap: 12px;
      align-items:end;
    }
    @media (max-width: 1200px){
      .filters__row{ grid-template-columns: 1fr 1fr; }
    }
    .fg .label{
      display:block;
      margin: 0 0 .45rem 0;
      font-weight: 900;
      font-size: .88rem;
      color: color-mix(in srgb, var(--text) 85%, var(--muted));
      letter-spacing:.2px;
    }
    .date-range{
      display:grid;
      grid-template-columns: 1fr 40px 1fr;
      gap: 10px;
      align-items:end;
    }
    .date-range .sep{
      height: 44px;
      border:1px solid var(--line2);
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      background: color-mix(in srgb, var(--glass) 78%, var(--bg1));
    }

    /* KPIs */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
    }
    @media (max-width: 1200px){ .stats{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width: 620px){ .stats{ grid-template-columns: 1fr; } }

    .stat-box{
      padding: 14px 14px 12px 14px;
      border-radius: var(--r-xl);
      background: var(--glass);
      border: 1px solid var(--line2);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      min-height: 112px;
      position: relative;
      overflow:hidden;
    }
    .stat-box:before{
      content:"";
      position:absolute;
      left:0; top:0; bottom:0;
      width:4px;
      background: color-mix(in srgb, rgba(37,99,235,.55) 70%, transparent);
      opacity:.9;
    }
    .stat-box.pending:before{ background: color-mix(in srgb, rgba(245,158,11,.65) 70%, transparent); }
    .stat-box.approved:before{ background: color-mix(in srgb, rgba(22,163,74,.65) 70%, transparent); }
    .stat-box.declined:before{ background: color-mix(in srgb, rgba(239,68,68,.65) 70%, transparent); }

    .stat-box h4{
      margin:0;
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 950;
    }
    .stat-value{
      font-size: 30px;
      font-weight: 950;
      margin-top: 6px;
      letter-spacing: .2px;
      line-height:1.05;
    }
    .stat-sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 800;
    }

    /* Table */
    .table-wrap{
      border:1px solid var(--line2);
      border-radius: var(--r-xl);
      overflow:auto;
      background: color-mix(in srgb, var(--glass) 70%, transparent);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      box-shadow: var(--shadow2);
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: .92rem;
      min-width: 1180px;
    }
    th, td{
      padding: .85rem .75rem;
      border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);
      text-align:left;
      vertical-align: middle;
      white-space: nowrap;
    }
    th{
      position: sticky;
      top: 0;
      z-index: 1;
      font-size: .78rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: var(--muted);
      background: color-mix(in srgb, var(--glass) 88%, var(--bg1));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    tr.row{
      cursor:pointer;
      transition: background .12s ease;
    }
    tr.row:hover{
      background: color-mix(in srgb, rgba(37,99,235,.10) 60%, transparent);
    }
    .td-right{ text-align:right; }
    .td-muted{ color: var(--muted); }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:.28rem .65rem;
      border-radius: 999px;
      font-weight: 950;
      font-size:.82rem;
      border:1px solid var(--line2);
      background: color-mix(in srgb, var(--glass) 72%, transparent);
      color: color-mix(in srgb, var(--text) 92%, var(--muted));
    }
    .pill.pending{
      background: color-mix(in srgb, rgba(245,158,11,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(245,158,11,.35) 55%, var(--line2));
      color: color-mix(in srgb, var(--warn) 82%, var(--text));
    }
    .pill.approved{
      background: color-mix(in srgb, rgba(22,163,74,.18) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(22,163,74,.35) 55%, var(--line2));
      color: color-mix(in srgb, var(--good) 85%, var(--text));
    }
    .pill.declined{
      background: color-mix(in srgb, rgba(239,68,68,.16) 65%, var(--glass));
      border-color: color-mix(in srgb, rgba(239,68,68,.32) 55%, var(--line2));
      color: color-mix(in srgb, var(--bad) 82%, var(--text));
    }

    /* =========================================================
       ✅ RIGHT DRAWER MODAL (FIX: NEVER CENTER)
    ========================================================= */
    .drawer-modal{
      position: fixed; /* <-- fixed, not absolute */
      inset: 0;
      z-index: 9999; /* high */
      display: none;
    }
    .drawer-modal.active{ display:block; }

    .drawer-modal__overlay{
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      opacity: 0;
      transition: opacity .18s ease;
    }
    .drawer-modal.active .drawer-modal__overlay{ opacity:1; }

    .drawer-modal__panel{
      position: absolute;
      top: 0;
      right: 0; /* <-- always right */
      height: 100%;
      width: min(980px, 94vw);  /* wide like screenshot */
      background: var(--bg1);
      border-left: 1px solid var(--line2);
      box-shadow: -22px 0 60px rgba(15,23,42,.22);
      transform: translateX(100%);
      transition: transform .18s ease;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      border-top-left-radius: 16px;
      border-bottom-left-radius: 16px;
    }
    [data-theme="dark"] .drawer-modal__panel{
      background: color-mix(in srgb, var(--glass) 30%, var(--bg1));
    }
    .drawer-modal.active .drawer-modal__panel{ transform: translateX(0); }

    .drawer-modal__header{
      padding: 14px 16px;
      border-bottom:1px solid var(--line2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: color-mix(in srgb, var(--glass) 55%, var(--bg1));
    }
    .drawer-modal__title{
      font-weight: 950;
      font-size: 1.05rem;
    }
    .drawer-modal__close{
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 900;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 10px;
    }
    .drawer-modal__close:hover{
      background: color-mix(in srgb, rgba(148,163,184,.18) 70%, transparent);
      color: var(--text);
    }

    .drawer-modal__body{
      padding: 16px;
      overflow:auto;
      flex:1;
    }

    /* inside drawer layout: left timeline + right details */
    .topup-layout{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .drawer-modal__panel{ width: min(980px, 98vw); }
      .topup-layout{ grid-template-columns: 1fr; }
    }

    .seg{
      display:flex;
      gap:10px;
      margin: 8px 0 14px 0;
    }
    .seg button{
      border:1px solid var(--line2);
      background: transparent;
      padding: 9px 12px;
      border-radius: 12px;
      font-weight: 900;
      cursor:pointer;
      color: var(--muted);
    }
    .seg button.active{
      background: color-mix(in srgb, rgba(37,99,235,.18) 60%, var(--glass));
      border-color: color-mix(in srgb, rgba(37,99,235,.25) 60%, var(--line2));
      color: var(--text);
    }

    .step-card{
      border:1px dashed color-mix(in srgb, var(--line2) 90%, transparent);
      border-radius: 16px;
      padding: 14px;
      background: #fbfcff;
    }
    [data-theme="dark"] .step-card{
      background: color-mix(in srgb, var(--glass) 25%, transparent);
    }
    .step{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding: 10px 8px;
      border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);
    }
    .step:last-child{ border-bottom:none; }
    .dot{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid color-mix(in srgb, var(--muted) 70%, transparent);
      margin-top: 4px;
      flex: 0 0 auto;
      background: transparent;
    }
    .dot.done{
      border-color: color-mix(in srgb, var(--good) 70%, transparent);
      background: color-mix(in srgb, rgba(22,163,74,.18) 70%, transparent);
    }
    .step h4{
      margin:0;
      font-size: .95rem;
      font-weight: 950;
    }
    .step .sub{
      margin-top: 4px;
      color: var(--muted);
      font-weight: 800;
      font-size: .86rem;
    }

    .right-box{
      border-left: 1px solid var(--line2);
      padding-left: 16px;
    }
    @media (max-width: 980px){
      .right-box{ border-left:none; padding-left:0; }
    }

    .kv{
      border-top: 1px solid var(--line2);
      margin-top: 10px;
    }
    .kv-row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid color-mix(in srgb, var(--line2) 70%, transparent);
      align-items:center;
    }
    .kv-row .k{
      color: color-mix(in srgb, var(--muted) 95%, var(--text));
      font-weight: 850;
      font-size: .84rem;
    }
    .kv-row .v{
      font-weight: 950;
      color: var(--text);
    }

    .admin-actions{
      margin-top: 14px;
    }
    .card-lite{
      border: 1px solid var(--line2);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      margin-top: 10px;
    }
    [data-theme="dark"] .card-lite{
      background: color-mix(in srgb, var(--glass) 35%, transparent);
    }
    .card-lite h5{
      margin:0;
      font-size: .95rem;
      font-weight: 950;
    }
    .card-lite .muted{
      font-size: .82rem;
      font-weight: 800;
    }

    .fx-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .fx-grid .full{ grid-column: 1 / -1; }
    .hr{ height:1px; background: var(--line2); margin: 12px 0; }

    .totals{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin-top: 10px;
    }
    .totals .label{ color: var(--muted); font-weight: 900; font-size:.85rem; }
    .totals .val{ font-weight: 950; }

    .danger-zone{
      margin-top: 10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
  </style>
</head>

<body>
  <div class="layout">

    <header class="header">
      <div class="header-left">
        <div class="page-tabs" id="pageTabs" role="tablist" aria-label="Finance tabs">
          <button type="button" class="page-tab" data-page="topups" role="tab" aria-selected="false">Topups</button>
          <button type="button" class="page-tab" data-page="finance" role="tab" aria-selected="false">Finance</button>
          <button type="button" class="page-tab" data-page="fees" role="tab" aria-selected="false">Charges</button>
          <button type="button" class="page-tab active" data-page="internal-transactions" role="tab" aria-selected="true">Internal Transactions</button>
          <button type="button" class="page-tab" data-page="transactions" role="tab" aria-selected="false">Transactions</button>
        </div>
      </div>

      <div class="header-right">
        <div class="theme-toggle" id="themeToggle">
          <button class="theme-btn active" data-theme="light" type="button">Light</button>
          <button class="theme-btn" data-theme="dark" type="button">Dark</button>
        </div>

        <div class="user-info">
          <span>Admin User</span>
          <div class="user-avatar">AU</div>
        </div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="glass-panel" style="margin-top: 1.5rem; padding: 1.5rem;">
        
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
          <div>
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700;">Internal Transactions</h2>
            <div style="font-size: 0.875rem; color: var(--muted); margin-top: 0.25rem;">
              Full audit log of money movements • <span id="internalTxCount">0</span> entries
            </div>
          </div>
          <button class="btn" onclick="exportInternalTransactionsExcel()" style="padding: 8px 16px;">Export Excel</button>
        </div>

        <!-- Search and Filter Row -->
        <div style="display: flex; gap: 0.75rem; align-items: flex-end; margin-top: 1.5rem; margin-bottom: 1.5rem;">
          <div style="flex: 1; max-width: 500px;">
            <label style="display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.35rem;">
              Search (ID / Date / Description / Link)
            </label>
            <input 
              type="text" 
              id="internalTx_search" 
              placeholder="Search..." 
              oninput="filterInternalTransactions()"
              style="width: 100%; padding: 8px 12px; border: 1px solid var(--line2); border-radius: 8px; background: var(--bg0); color: var(--text); font-size: 0.9rem;"
            >
          </div>

          <div style="min-width: 180px;">
            <label style="display: block; font-size: 0.875rem; color: var(--muted); margin-bottom: 0.35rem;">
              Category
            </label>
            <select 
              id="internalTx_category" 
              onchange="filterInternalTransactions()"
              style="width: 100%; padding: 8px 12px; border: 1px solid var(--line2); border-radius: 8px; background: var(--bg0); color: var(--text); font-size: 0.9rem;"
            >
              <option value="__all__">All</option>
              <option value="topup_approval">TOPUP_APPROVAL</option>
              <option value="topup_fee">TOPUP_FEE</option>
              <option value="transfer">TRANSFER</option>
              <option value="transfer_fee">TRANSFER_FEE</option>
              <option value="service_charge">SERVICE_CHARGE</option>
              <option value="setup_charge">SETUP_CHARGE</option>
              <option value="refund">REFUND</option>
              <option value="other">OTHER</option>
            </select>
          </div>

          <button class="btn gray" onclick="clearInternalTxFilters()" style="padding: 8px 16px;">Clear</button>
        </div>

        <!-- Table -->
        <div style="overflow-x: auto; border: 1px solid var(--line2); border-radius: var(--r-lg);">
          <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
            <thead>
              <tr style="background: var(--bg0); border-bottom: 1px solid var(--line2);">
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text); white-space: nowrap;">Date</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Category</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Amount</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">From</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">To</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Link</th>
                <th style="padding: 12px 16px; text-align: left; font-weight: 600; color: var(--text);">Description</th>
                <th style="padding: 12px 16px; text-align: center; font-weight: 600; color: var(--text);">Action</th>
              </tr>
            </thead>
            <tbody id="internalTxPageBody">
              <!-- Rows will be inserted here -->
            </tbody>
          </table>
        </div>

      </div>
    </main>
  </div>

  <!-- Internal Transaction Details Modal -->
  <div id="internalTxDetailsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; backdrop-filter: blur(4px);" onclick="closeInternalTxDetails()">
    <div id="internalTxDetailsPanel" style="position: absolute; top: 0; right: -500px; width: 500px; height: 100%; background: white; box-shadow: -4px 0 20px rgba(0,0,0,0.2); transition: right 0.3s ease; overflow-y: auto;" onclick="event.stopPropagation()">
      
      <!-- Header -->
      <div style="padding: 2rem; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; background: white; z-index: 10;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3 id="internalTxModalTitle" style="margin: 0; font-size: 1.1rem; font-weight: 600; color: #1f2937;">Internal Tx • [ID]</h3>
          <button onclick="closeInternalTxDetails()" style="background: none; border: none; font-size: 1.5rem; color: #6b7280; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.15s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">×</button>
        </div>
      </div>

      <!-- Details Grid -->
      <div style="padding: 2rem;">
        <div style="display: grid; grid-template-columns: 140px 1fr; gap: 1.25rem; font-size: 0.95rem;">
          
          <div style="color: #6b7280; font-weight: 500;">Created</div>
          <div id="txDetail_created" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Category</div>
          <div id="txDetail_category" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Amount</div>
          <div id="txDetail_amount" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">From</div>
          <div id="txDetail_from" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">To</div>
          <div id="txDetail_to" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Link</div>
          <div id="txDetail_link" style="color: #1f2937; font-weight: 600; text-align: right; font-family: monospace; font-size: 0.9rem;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Client</div>
          <div id="txDetail_client" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Fee code</div>
          <div id="txDetail_feeCode" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

          <div style="color: #6b7280; font-weight: 500;">Description</div>
          <div id="txDetail_description" style="color: #1f2937; font-weight: 600; text-align: right;">—</div>

        </div>
      </div>

    </div>
  </div>
                  <th class="td-right">Amount (USD)</th>
                  <th>Status</th>
                  <th>Timeline</th>
                  <th class="td-right">Action</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>

        <div class="mini-hint" style="padding:0 2px;">
          Tip for devs: Internal Transactions are the single source of truth. Fees and balances are derived from them. Backend is intentionally omitted.
        </div>

      </div>
    </main>
  </div>

  <!-- ✅ RIGHT DRAWER: Top-up details -->
  <div class="drawer-modal" id="topupDrawerModal" aria-hidden="true">
    <div class="drawer-modal__overlay" id="drawerOverlay"></div>

    <div class="drawer-modal__panel" role="dialog" aria-modal="true" aria-label="Topup details">
      <div class="drawer-modal__header">
        <div class="drawer-modal__title" id="dTitle">Top-up • TU-00000</div>
        <button class="drawer-modal__close" type="button" id="drawerClose">Close</button>
      </div>

      <div class="drawer-modal__body">
        <div class="seg" id="viewSeg">
          <button type="button" data-view="client" class="active">Client view</button>
          <button type="button" data-view="admin">Admin view</button>
        </div>

        <div class="topup-layout">
          <!-- LEFT -->
          <div>
            <div class="step-card">
              <div class="step">
                <div class="dot" id="dotInvoice"></div>
                <div>
                  <h4>Invoice provided</h4>
                  <div class="sub" id="txtInvoice">—</div>
                </div>
              </div>
              <div class="step">
                <div class="dot" id="dotProof"></div>
                <div>
                  <h4>Proof uploaded</h4>
                  <div class="sub" id="txtProof">—</div>
                </div>
              </div>
              <div class="step">
                <div class="dot" id="dotOTW"></div>
                <div>
                  <h4>Money OTW</h4>
                  <div class="sub" id="txtOTW">—</div>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="right-box">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <span class="pill pending" id="dStatusPill">PENDING</span>
              <span class="muted" id="dMainWallet">Main Wallet: USD 0.00</span>
            </div>

            <div class="kv" id="dKv"></div>

            <div style="margin-top:10px;" id="billingBlock">
              <div class="kv-row">
                <div class="k">Billing company</div>
                <div class="v" id="dCompany">—</div>
              </div>
              <div class="kv-row">
                <div class="k">IBAN</div>
                <div class="v" id="dIban">—</div>
              </div>
              <div class="kv-row">
                <div class="k">Currency</div>
                <div class="v" id="dCurrency">—</div>
              </div>

              <div class="mini-hint" style="margin-top:8px;">Admin can edit billing company while pending.</div>
              <button class="btn" type="button" id="btnEditBilling">Edit billing company</button>
            </div>

            <div class="admin-actions" id="adminActions">
              <div class="hr"></div>
              <div style="font-weight:950; margin-bottom:6px;">Admin actions</div>

              <div class="card-lite">
                <h5>Invoice upload</h5>
                <div class="muted">Demo stores metadata only.</div>
                <div style="margin-top:8px;">
                  <input type="file" id="fileInvoice" />
                </div>
              </div>

              <div class="card-lite">
                <h5>Payment proof upload</h5>
                <div class="muted">Admin can upload if client asks.</div>
                <div style="margin-top:8px;">
                  <input type="file" id="fileProof" />
                </div>
              </div>

              <div style="margin-top:10px;">
                <button class="btn" type="button" id="btnMarkWire">Mark wire received</button>
                <div class="mini-hint">FX shows only here (admin). Locked until “wire received”.</div>
              </div>

              <div class="fx-grid">
                <div>
                  <label class="label" style="margin:0 0 6px;">Received amount</label>
                  <input id="fxReceivedAmount" type="number" step="0.01" placeholder="0" />
                </div>
                <div>
                  <label class="label" style="margin:0 0 6px;">Received currency</label>
                  <select id="fxCurrency">
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="GBP">GBP</option>
                  </select>
                </div>
                <div>
                  <label class="label" style="margin:0 0 6px;">FX rate to USD</label>
                  <input id="fxRate" type="number" step="0.0001" placeholder="1" />
                </div>
                <div>
                  <label class="label" style="margin:0 0 6px;">Fee (USD)</label>
                  <input id="fxFee" type="number" step="0.01" placeholder="0" />
                </div>
              </div>

              <div class="totals">
                <div class="label">Approved USD amount</div>
                <div class="val" id="dApprovedUsd">USD 0.00</div>
              </div>
              <div class="totals">
                <div class="label">Net to Main Wallet</div>
                <div class="val" id="dNetUsd">USD 0.00</div>
              </div>

              <div style="margin-top:10px;">
                <button class="btn" type="button" id="btnApprove">Approve</button>
              </div>

              <div class="hr"></div>

              <div>
                <label class="label" style="margin:0 0 6px;">Decline preset</label>
                <select id="declinePreset">
                  <option value="">Select…</option>
                  <option value="missing_docs">Missing documents</option>
                  <option value="iban_mismatch">IBAN mismatch</option>
                  <option value="wrong_amount">Wrong amount</option>
                  <option value="compliance">Compliance issue</option>
                </select>
              </div>

              <div style="margin-top:10px;">
                <label class="label" style="margin:0 0 6px;">Decline reason (required)</label>
                <input id="declineReason" placeholder="Write details…" />
              </div>

              <div class="danger-zone">
                <button class="btn danger" type="button" id="btnDecline">Decline</button>
                <button class="btn" type="button" id="btnDelete">Delete</button>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="../js/sidebar.js"></script>
  <script>
    /* ==============================
       Tabs routes
    ============================== */
    const PAGE_ROUTES = {
      topups: "topups.html",
      finance: "finance.html",
      fees: "fees.html",
      "internal-transactions": "internal-transactions.html",
      transactions: "transactions.html"
    };
    document.getElementById("pageTabs")?.addEventListener("click",(e)=>{
      const btn = e.target.closest(".page-tab");
      if(!btn) return;
      const key = btn.dataset.page;
      if(!PAGE_ROUTES[key]) return;
      window.location.href = PAGE_ROUTES[key];
    });

    /* ==============================
       Theme
    ============================== */
    (function initTheme(){
      const root = document.documentElement;
      const saved = localStorage.getItem("ui_theme") || "light";
      if(saved === "dark") root.setAttribute("data-theme","dark");

      const buttons = document.querySelectorAll("#themeToggle .theme-btn");
      function setTheme(t){
        if(t === "dark") root.setAttribute("data-theme","dark");
        else root.removeAttribute("data-theme");
        localStorage.setItem("ui_theme", t);
        buttons.forEach(b=> b.classList.toggle("active", b.dataset.theme === t));
      }
      buttons.forEach(b=> b.addEventListener("click", ()=> setTheme(b.dataset.theme)));
      setTheme(saved);
    })();

    /* ==============================
       Demo data and state
    ============================== */
    const LS_KEY = "admin_finance_demo_v7";

    const state = {
      ledger: [],
      platformFilter: "__all__",
      globalClient: "__all__",
      globalFrom: "",
      globalTo: "",
      ledgerTab: "all"
    };

    function money(n){
      const v = Number(n || 0);
      return v.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }
    function nowISO(){ return new Date().toLocaleString(); }
    function uid(){ return Math.random().toString(16).slice(2) + "_" + Date.now(); }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function getClientLabelById(id){
      const map = { "100":"100 - Alex", "101":"101 - Maria", "102":"102 - John" };
      return map[String(id)] || String(id);
    }

    function getClientNameById(id){
      const label = getClientLabelById(id);
      const parts = String(label).split(" - ");
      return parts[1] ? parts.slice(1).join(" - ").trim() : label;
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){ seedDemo(); return; }
      try{
        const parsed = JSON.parse(raw);
        
        if(!parsed.dataVersion || parsed.dataVersion < 2){
          seedDemo();
          return;
        }
        
        state.ledger = Array.isArray(parsed.ledger) ? parsed.ledger : [];
        state.platformFilter = parsed.platformFilter || "__all__";
        state.globalClient = parsed.globalClient || "__all__";
        state.globalFrom = parsed.globalFrom || "";
        state.globalTo = parsed.globalTo || "";
        state.ledgerTab = parsed.ledgerTab || "all";
      }catch(e){ seedDemo(); }
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify({
        dataVersion: 2,
        ledger: state.ledger,
        platformFilter: state.platformFilter,
        globalClient: state.globalClient,
        globalFrom: state.globalFrom,
        globalTo: state.globalTo,
        ledgerTab: state.ledgerTab
      }));
    }

    function seedDemo(){
      state.ledger = [
        {
          id: uid(),
          topupId: "100147",
          date: "19 februarie 2026",
          type:"topup",
          clientId:"100",
          from:"external",
          to:"mainWallet",
          platform:"",
          category:"topup_approval",
          status:"approved",
          account:"USD",
          proof:"—",
          description:"Demo • Top-up approved (net USD) to Main Wallet",
          grossAmount: 980.00,
          feeAmount: 0,
          netAmount: 980.00,
          note:"Demo • Top-up approved (net USD) to Main Wallet",
          amount: 980.00
        },
        {
          id: uid(),
          topupId: "100148",
          date: "19 februarie 2026",
          type:"fee",
          clientId:"100",
          from:"topup",
          to:"feesCollected",
          platform:"",
          category:"topup_fee",
          status:"approved",
          account:"USD",
          proof:"—",
          description:"Demo • Top-up fee",
          grossAmount: 20.00,
          feeAmount: 20.00,
          netAmount: 20.00,
          note:"Demo • Top-up fee",
          amount: 20.00
        },
        {
          id: uid(),
          topupId: "100149",
          date: "19 februarie 2026",
          type:"transfer",
          clientId:"100",
          from:"mainWallet",
          to:"platformVault",
          platform:"FACEBOOK",
          category:"transfer",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • Main → FB Vault",
          grossAmount: 400.00,
          feeAmount: 0,
          netAmount: 400.00,
          note:"Demo • Main → FB Vault",
          amount: 400.00
        },
        {
          id: uid(),
          date: "19 februarie 2026",
          type:"fee",
          clientId:"100",
          from:"mainWallet",
          to:"feesCollected",
          platform:"",
          category:"transfer_fee",
          status:"completed",
          account:"USD",
          proof:"—",
          description:"Demo • Transfer fee",
          grossAmount: 5.00,
          feeAmount: 5.00,
          netAmount: 5.00,
          note:"Demo • Transfer fee",
          amount: 5.00
        }
      ];
      save();
    }

    function passesGlobalFilters(tx){
      return true;
    }

    /* ==============================
       Internal Transactions Page Functions
    ============================== */
    function renderInternalTransactionsPage(){
      const body = document.getElementById("internalTxPageBody");
      if(!body) return;

      let rows = state.ledger
        .filter(passesGlobalFilters)
        .slice()
        .sort((a,b)=> new Date(b.date) - new Date(a.date));

      const searchTerm = (document.getElementById("internalTx_search")?.value || "").toLowerCase();
      if(searchTerm){
        rows = rows.filter(tx => {
          const searchableText = [
            tx.id || "",
            tx.date || "",
            tx.note || "",
            tx.description || "",
            tx.from || "",
            tx.to || "",
            generateLinkId(tx)
          ].join(" ").toLowerCase();
          return searchableText.includes(searchTerm);
        });
      }

      const categoryFilter = document.getElementById("internalTx_category")?.value || "__all__";
      if(categoryFilter !== "__all__"){
        rows = rows.filter(tx => {
          const cat = String(tx.category || tx.type || "").toLowerCase();
          
          if(categoryFilter === "topup_approval") return cat.includes("topup") && !cat.includes("fee");
          if(categoryFilter === "topup_fee") return cat.includes("topup") && cat.includes("fee");
          if(categoryFilter === "transfer") return cat.includes("transfer") && !cat.includes("fee");
          if(categoryFilter === "transfer_fee") return cat.includes("transfer") && cat.includes("fee");
          if(categoryFilter === "service_charge") return cat.includes("service");
          if(categoryFilter === "setup_charge") return cat.includes("setup");
          if(categoryFilter === "refund") return cat.includes("refund");
          if(categoryFilter === "other") return !cat.includes("topup") && !cat.includes("transfer") && !cat.includes("service") && !cat.includes("setup") && !cat.includes("refund");
          
          return cat.includes(categoryFilter);
        });
      }

      const countEl = document.getElementById("internalTxCount");
      if(countEl) countEl.textContent = rows.length;

      if(!rows.length){
        body.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 3rem; color: var(--muted);">No internal transactions found for current filters.</td></tr>`;
        return;
      }

      body.innerHTML = rows.map(tx=>{
        const categoryBadge = getCategoryBadgeStyled(tx);
        const linkId = generateLinkId(tx);
        
        let fromText = formatAccountName(tx.from || "—");
        let toText = formatAccountName(tx.to || "—");
        
        if(tx.platform && fromText === "Platform Vault"){
          fromText = `Platform Vault:${tx.platform.toUpperCase()}`;
        }
        if(tx.platform && toText === "Platform Vault"){
          toText = `Platform Vault:${tx.platform.toUpperCase()}`;
        }
        
        if(tx.platform && toText === "General Balance"){
          toText = `General Balance:${tx.platform.toUpperCase()}`;
        }
        if(tx.platform && toText === "Individual Balance"){
          toText = `Individual Balance:${tx.platform.toUpperCase()}`;
        }
        
        const amountFormatted = `USD ${Number(tx.amount || 0).toFixed(2)}`;
        
        return `
          <tr style="border-bottom: 1px solid var(--line2);">
            <td style="padding: 12px 16px; white-space: nowrap; color: var(--text);">${escapeHtml(tx.date)}</td>
            <td style="padding: 12px 16px;">${categoryBadge}</td>
            <td style="padding: 12px 16px; color: var(--text);">${amountFormatted}</td>
            <td style="padding: 12px 16px; color: var(--text);">${escapeHtml(fromText)}</td>
            <td style="padding: 12px 16px; color: var(--text);">${escapeHtml(toText)}</td>
            <td style="padding: 12px 16px; font-family: monospace; font-size: 0.85rem; color: var(--muted);">${escapeHtml(linkId)}</td>
            <td style="padding: 12px 16px; color: var(--text); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(tx.note || tx.description || "—")}</td>
            <td style="padding: 12px 16px; text-align: center;">
              <button 
                onclick="viewInternalTxDetails('${escapeHtml(tx.id)}')" 
                style="padding: 6px 14px; background: var(--bg0); border: 1px solid var(--line2); border-radius: 6px; color: var(--text); cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.15s ease;"
                onmouseover="this.style.background='var(--glass)'; this.style.transform='translateY(-1px)'"
                onmouseout="this.style.background='var(--bg0)'; this.style.transform='translateY(0)'"
              >Details</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function getCategoryBadgeStyled(tx){
      const cat = String(tx.category || tx.type || "").toLowerCase();
      let bgColor = "#e5e7eb";
      let textColor = "#374151";
      let displayText = (tx.category || tx.type || "—").toUpperCase().replace(/_/g, " ");
      
      if(cat.includes("topup") && !cat.includes("fee")){
        bgColor = "#dcfce7";
        textColor = "#166534";
        displayText = "TOPUP APPROVAL";
      } else if(cat.includes("topup") && cat.includes("fee")){
        bgColor = "#fef3c7";
        textColor = "#92400e";
        displayText = "TOPUP FEE";
      } else if(cat.includes("transfer") && cat.includes("fee")){
        bgColor = "#fef3c7";
        textColor = "#92400e";
        displayText = "TRANSFER FEE";
      } else if(cat.includes("transfer") || cat.includes("allocation")){
        bgColor = "#dbeafe";
        textColor = "#1e40af";
        displayText = "TRANSFER";
      } else if(cat.includes("service")){
        bgColor = "#e0e7ff";
        textColor = "#4338ca";
        displayText = "SERVICE CHARGE";
      } else if(cat.includes("setup")){
        bgColor = "#e0e7ff";
        textColor = "#4338ca";
        displayText = "SETUP CHARGE";
      } else if(cat.includes("refund")){
        bgColor = "#fee2e2";
        textColor = "#991b1b";
        displayText = "REFUND";
      } else {
        bgColor = "#f3f4f6";
        textColor = "#4b5563";
        displayText = "OTHER";
      }
      
      return `<span style="display: inline-block; padding: 4px 10px; border-radius: 6px; background: ${bgColor}; color: ${textColor}; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.3px;">${displayText}</span>`;
    }

    function formatAccountName(account){
      if(!account || account === "—") return "—";
      
      let formatted = String(account);
      
      if(formatted === "external") return "Wire (EUR)";
      if(formatted === "mainWallet") return "Main Wallet";
      if(formatted === "platformVault") return "Platform Vault";
      if(formatted === "generalBalance") return "General Balance";
      if(formatted === "individualBalance") return "Individual Balance";
      if(formatted === "feesCollected") return "Fees";
      if(formatted === "topups") return "Topups";
      if(formatted === "topup") return "Top-up";
      
      return formatted;
    }

    function generateLinkId(tx){
      const type = (tx.type || "").toUpperCase();
      const id = String(tx.id || "").substring(0, 6).toUpperCase();
      
      if(type === "TOPUP") return `TOPUP-TN-DEMO-${id}`;
      if(type === "TRANSFER") return `TRANSFER-TE-DEMO-${id}`;
      if(type === "ALLOCATION") return `TRANSFER-TN-DEMO-${id}`;
      if(type === "FEE") return `TRANSFER-TE-DEMO-${id}`;
      
      return `TX-${id}`;
    }

    function filterInternalTransactions(){
      renderInternalTransactionsPage();
    }

    function clearInternalTxFilters(){
      const searchEl = document.getElementById("internalTx_search");
      const categoryEl = document.getElementById("internalTx_category");
      
      if(searchEl) searchEl.value = "";
      if(categoryEl) categoryEl.value = "__all__";
      
      renderInternalTransactionsPage();
    }

    function viewInternalTxDetails(txId){
      const tx = state.ledger.find(t => String(t.id) === String(txId));
      if(!tx){
        alert("Transaction not found.");
        return;
      }
      
      document.getElementById("internalTxModalTitle").textContent = `Internal Tx • ${tx.id}`;
      document.getElementById("txDetail_created").textContent = tx.date || "—";
      document.getElementById("txDetail_category").textContent = (tx.category || tx.type || "—").toUpperCase().replace(/_/g, " ");
      document.getElementById("txDetail_amount").textContent = `USD ${Number(tx.amount || 0).toFixed(2)}`;
      
      let fromText = formatAccountName(tx.from || "—");
      let toText = formatAccountName(tx.to || "—");
      
      if(tx.platform && fromText === "Platform Vault"){
        fromText = `Platform Vault:${tx.platform.toUpperCase()}`;
      }
      if(tx.platform && toText === "Platform Vault"){
        toText = `Platform Vault:${tx.platform.toUpperCase()}`;
      }
      if(tx.platform && toText === "General Balance"){
        toText = `General Balance:${tx.platform.toUpperCase()}`;
      }
      if(tx.platform && toText === "Individual Balance"){
        toText = `Individual Balance:${tx.platform.toUpperCase()}`;
      }
      
      document.getElementById("txDetail_from").textContent = fromText;
      document.getElementById("txDetail_to").textContent = toText;
      document.getElementById("txDetail_link").textContent = generateLinkId(tx);
      document.getElementById("txDetail_client").textContent = `c${tx.clientId || "1"}`;
      document.getElementById("txDetail_feeCode").textContent = tx.feeCode || "—";
      document.getElementById("txDetail_description").textContent = tx.note || tx.description || "—";
      
      const modal = document.getElementById("internalTxDetailsModal");
      const panel = document.getElementById("internalTxDetailsPanel");
      modal.style.display = "block";
      
      setTimeout(() => {
        panel.style.right = "0";
      }, 10);
    }

    function closeInternalTxDetails(){
      const modal = document.getElementById("internalTxDetailsModal");
      const panel = document.getElementById("internalTxDetailsPanel");
      
      panel.style.right = "-500px";
      
      setTimeout(() => {
        modal.style.display = "none";
      }, 300);
    }

    function exportInternalTransactionsExcel(){
      const rows = state.ledger
        .filter(passesGlobalFilters)
        .sort((a,b)=> new Date(b.date) - new Date(a.date));
      
      let csv = "Date,Category,Amount,From,To,Link,Description\n";
      
      rows.forEach(tx => {
        const linkId = generateLinkId(tx);
        const cat = tx.category || tx.type || "—";
        const row = [
          tx.date,
          cat,
          tx.amount,
          formatAccountName(tx.from || "—"),
          formatAccountName(tx.to || "—"),
          linkId,
          (tx.note || tx.description || "—").replace(/,/g, ";")
        ].join(",");
        csv += row + "\n";
      });
      
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `internal-transactions-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    /* ==============================
       Boot
    ============================== */
    load();
    renderInternalTransactionsPage();
  </script>
</body>
</html>