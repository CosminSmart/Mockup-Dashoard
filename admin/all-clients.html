<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>All Clients • Platforms & Fees</title>

  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/users.css">
  <link rel="stylesheet" href="../css/sidebar.css">

  <style>
    /* Actions bar */
    .um-actionsbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; margin:14px 0 12px;
    }
    .um-actionsbar__left{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .um-actionsbar__right{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .um-bulk{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.10);
      border-radius:12px;
      background:#fff;
    }
    .um-bulk__count{ color:#64748b; font-size:13px; }

    .um-small{ font-size:13px; color:#64748b; }
    .um-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size:13px;
      color:#0f172a;
    }

    .um-table th:first-child, .um-table td:first-child{ width:46px; }
    .um-table td:last-child, .um-table th:last-child{ width:170px; }

    /* NEW: icon column sizing */
    .um-table th[data-col="icon"],
    .um-table td[data-col="icon"]{ width:56px; text-align:center; }

    .pf-icon{
      width:28px; height:28px;
      display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(15,23,42,.10);
      border-radius:10px;
      background: rgba(246,247,251,.75);
      overflow:hidden;
    }
    .pf-icon svg{ width:18px; height:18px; display:block; }
    .pf-icon img{ width:18px; height:18px; display:block; object-fit:contain; }

    /* Right Drawer */
    .pf-overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 9998;
    }
    .pf-overlay[hidden]{ display:none; }

    .pf-drawer{
      position:fixed; top:0; right:0; height:100vh;
      width: min(560px, 92vw);
      background:#fff;
      border-left:1px solid rgba(15,23,42,.10);
      box-shadow: -20px 0 60px rgba(15,23,42,.20);
      z-index: 9999;
      transform: translateX(110%);
      transition: transform .22s ease;
      display:flex; flex-direction:column;
    }
    .pf-drawer.is-open{ transform: translateX(0); }

    .pf-drawer__header{
      padding:16px;
      border-bottom:1px solid rgba(15,23,42,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .pf-drawer__title{ font-size:16px; font-weight:700; color:#0f172a; }
    .pf-drawer__sub{ margin-top:4px; color:#64748b; font-size:13px; }
    .pf-drawer__body{
      padding:14px 16px;
      overflow:auto;
      flex:1;
    }
    .pf-drawer__footer{
      padding:12px 16px;
      border-top:1px solid rgba(15,23,42,.10);
      background: rgba(246,247,251,.65);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }

    .pf-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    .pf-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .pf-row{ grid-template-columns:1fr; } }

    .pf-field{ display:flex; flex-direction:column; gap:6px; }
    .pf-field label{ font-size:12px; color:#64748b; }
    .pf-field input, .pf-field select, .pf-field textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      outline:none;
      font: inherit;
    }
    .pf-field textarea{ min-height: 120px; resize: vertical; }

    .pf-hint{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,.18);
      border-radius:12px;
      background: rgba(246,247,251,.55);
      color:#64748b;
      font-size:13px;
      line-height: 1.35;
    }

    /* Custom dropdown (platform + icon preset) */
    .pf-select{ position:relative; }
    .pf-select__btn{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      cursor:pointer;
      user-select:none;
    }
    .pf-select__btn:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(37,99,235,.12);
      border-color: rgba(37,99,235,.35);
    }
    .pf-select__left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .pf-select__label{
      font-size:14px;
      color:#0f172a;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pf-select__chev{ color:#64748b; font-size:14px; }
    .pf-select__menu{
      position:absolute;
      top: calc(100% + 8px);
      left:0;
      right:0;
      z-index: 50;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      border-radius:14px;
      box-shadow: 0 18px 45px rgba(15,23,42,.14);
      padding:6px;
      max-height: 240px;
      overflow:auto;
    }
    .pf-select__menu[hidden]{ display:none; }
    .pf-opt{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:0;
      background:transparent;
      cursor:pointer;
      text-align:left;
    }
    .pf-opt:hover{ background: rgba(246,247,251,.9); }
    .pf-opt[aria-selected="true"]{
      background: rgba(37,99,235,.08);
      outline: 1px solid rgba(37,99,235,.18);
    }

    /* Icon controls */
    .pf-iconbox{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px;
      padding:12px;
      background: rgba(246,247,251,.35);
      display:grid;
      gap:10px;
    }
    .pf-iconbox__top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pf-icon-preview{
      display:flex;
      align-items:center;
      gap:10px;
      color:#0f172a;
      font-size:13px;
    }
    .pf-icon-preview .pf-icon{
      width:34px; height:34px; border-radius:12px;
      background:#fff;
    }
    .pf-chiprow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pf-chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .pf-chip input{ display:none; }
    .pf-chip.is-active{
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.25);
    }
    .pf-actions-inline{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pf-file{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .pf-file input[type="file"]{
      padding:8px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      width:auto;
      max-width: 100%;
    }
    .pf-note{
      font-size:12px;
      color:#64748b;
      line-height:1.35;
    }
    .pf-error{
      font-size:12px;
      color:#b91c1c;
      display:none;
    }
    .pf-error.is-show{ display:block; }
  </style>
</head>

<body>
  <div class="layout">
    <header class="header">
      <h1>User Management</h1>
      <div class="user-info">
        <span>Admin User</span>
        <div class="user-avatar">AU</div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="content-section">

        <!-- SWITCHER -->
        <div class="um-switcher um-switcher--top" role="tablist" aria-label="Clients/Employees Switcher">
          <button class="um-tab is-active" type="button" data-top-tab="clients" role="tab" aria-selected="true">
            Clients
          </button>
          <button class="um-tab" type="button" data-top-tab="employees" role="tab" aria-selected="false">
            Employees
          </button>
        </div>

        <h2>Platforms & Fees</h2>

        <!-- Clients Dropdown Menu -->
        <div class="um-dropdown-compact" id="clientsDropdown">
          <button class="um-dropdown-toggle" id="clientsDropdownToggle">
            <span class="um-dropdown-current">Platforms & Fees</span>
            <span class="um-dropdown-arrow">▾</span>
          </button>
          <div class="um-dropdown-menu" id="clientsDropdownMenu" style="display: none;">
            <button class="um-dropdown-item" data-client-view="clients">
              <span>Clients List</span>
              <span class="um-dropdown-desc">Manage individual clients</span>
            </button>
            <button class="um-dropdown-item is-active" data-client-view="all-clients">
              <span>Platforms & Fees</span>
              <span class="um-dropdown-desc">View all clients with platforms & fees</span>
            </button>
            <button class="um-dropdown-item" data-client-view="notifications">
              <span>Clients Notifications</span>
              <span class="um-dropdown-desc">Send notifications to clients</span>
            </button>
          </div>
        </div>

        <style>
          .um-dropdown-compact {
            position: relative;
            margin-top: 12px;
            margin-bottom: 16px;
          }

          .um-dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 14px;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.10);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: #1a202c;
            width: 280px;
            transition: all 0.15s;
          }

          .um-dropdown-toggle:hover {
            border-color: rgba(0,0,0,0.20);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          }

          .um-dropdown-arrow {
            font-size: 12px;
            opacity: 0.6;
            transition: transform 0.2s;
          }

          .um-dropdown-toggle.is-open .um-dropdown-arrow {
            transform: rotate(180deg);
          }

          .um-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            z-index: 100;
            min-width: 320px;
          }

          .um-dropdown-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            padding: 12px 14px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            transition: background 0.15s;
          }

          .um-dropdown-item:hover {
            background: rgba(0,0,0,0.04);
          }

          .um-dropdown-item.is-active {
            background: rgba(0,0,0,0.06);
          }

          .um-dropdown-item span:first-child {
            font-weight: 700;
            font-size: 14px;
            color: #1a202c;
          }

          .um-dropdown-desc {
            font-size: 12px;
            color: #64748b;
            font-weight: 400;
          }
        </style>

        <script>
          // Toggle dropdown
          const dropdownToggle = document.getElementById('clientsDropdownToggle');
          const dropdownMenu = document.getElementById('clientsDropdownMenu');

          dropdownToggle?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdownMenu.style.display !== 'none';
            dropdownMenu.style.display = isOpen ? 'none' : 'block';
            dropdownToggle.classList.toggle('is-open', !isOpen);
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            if (dropdownMenu) {
              dropdownMenu.style.display = 'none';
              dropdownToggle?.classList.remove('is-open');
            }
          });

          // Prevent closing when clicking inside menu
          dropdownMenu?.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        </script>

        <p class="um-small">
          Global settings or client-specific overrides.
          If <b>Assigned Client</b> is empty, the row applies to <b>All Clients</b>.
        </p>

        <!-- ACTIONS BAR -->
        <div class="um-actionsbar">
          <div class="um-actionsbar__left">
            <div class="um-bulk">
              <span class="um-pill">Selected: <b id="selCount">0</b></span>
              <span class="um-bulk__count" id="selHint">Select rows to enable bulk actions</span>
              <button class="um-btn um-btn--ghost" type="button" id="bulkModify" disabled>Modify</button>
              <button class="um-btn um-btn--ghost" type="button" id="bulkDelete" disabled>Delete</button>
            </div>
          </div>

          <div class="um-actionsbar__right">
            <button class="um-btn" type="button" id="openAddPlatform">Add New Platform</button>
          </div>
        </div>

        <!-- TABLE -->
        <section class="um-view is-active">
          <div class="um-table-wrap">
            <table class="um-table" id="pfTable">
              <thead>
                <tr>
                  <th><input type="checkbox" id="selectAll" aria-label="Select all rows"></th>
                  <th data-col="icon" aria-label="Platform Icon"></th>
                  <th>Platform</th>
                  <th>Setup</th>
                  <th>Fee</th>
                  <th>Init Interval</th>
                  <th>Init Amount</th>
                  <th>Rec Interval</th>
                  <th>Rec Amount</th>
                  <th>Assigned Client</th>
                  <th style="text-align:right;">Actions</th>
                </tr>
              </thead>
              <tbody id="pfTbody"></tbody>
            </table>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- ===== Platform Drawer (Add/Edit) ===== -->
  <div class="pf-overlay" id="pfOverlay" hidden></div>
  <aside class="pf-drawer" id="pfDrawer" aria-hidden="true">
    <div class="pf-drawer__header">
      <div>
        <div class="pf-drawer__title" id="pfTitle">Add New Platform</div>
        <div class="pf-drawer__sub" id="pfSub">Create global row or assign to a specific client.</div>
      </div>
      <button class="um-btn um-btn--icon" type="button" id="pfCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="pf-drawer__body">
      <div class="pf-grid">

        <!-- Platform dropdown -->
        <div class="pf-field">
          <label>Platform</label>

          <input type="hidden" id="pfPlatformKey" value="google">

          <div class="pf-select" id="pfPlatformSelect">
            <button class="pf-select__btn" type="button" id="pfPlatformBtn" aria-haspopup="listbox" aria-expanded="false">
              <span class="pf-select__left">
                <span class="pf-icon" id="pfPlatformIcon"></span>
                <span class="pf-select__label" id="pfPlatformLabel">Google Ads</span>
              </span>
              <span class="pf-select__chev">▾</span>
            </button>
            <div class="pf-select__menu" id="pfPlatformMenu" role="listbox" tabindex="-1" hidden></div>
          </div>
        </div>

        <!-- NEW: Icon settings (separate from platform) -->
        <div class="pf-field">
          <label>Icon (independent)</label>

          <div class="pf-iconbox">
            <div class="pf-iconbox__top">
              <div class="pf-icon-preview">
                <span class="pf-icon" id="pfIconPreview"></span>
                <span id="pfIconPreviewLabel">Current icon</span>
              </div>

              <div class="pf-actions-inline">
                <button class="um-btn um-btn--ghost" type="button" id="pfIconUsePlatformDefault">Use platform default</button>
              </div>
            </div>

            <div class="pf-chiprow" role="radiogroup" aria-label="Icon source">
              <label class="pf-chip is-active" id="chipPreset">
                <input type="radio" name="pfIconMode" value="preset" checked>
                Preset dropdown
              </label>
              <label class="pf-chip" id="chipUpload">
                <input type="radio" name="pfIconMode" value="upload">
                Upload SVG
              </label>
              <label class="pf-chip" id="chipPaste" style="display: none;">
                <input type="radio" name="pfIconMode" value="paste">
                Paste SVG
              </label>
            </div>

            <!-- Preset dropdown -->
            <div id="pfIconPresetWrap">
              <input type="hidden" id="pfIconPresetKey" value="google">
              <div class="pf-select" id="pfIconSelect">
                <button class="pf-select__btn" type="button" id="pfIconBtn" aria-haspopup="listbox" aria-expanded="false">
                  <span class="pf-select__left">
                    <span class="pf-icon" id="pfIconPresetIcon"></span>
                    <span class="pf-select__label" id="pfIconPresetLabel">Google</span>
                  </span>
                  <span class="pf-select__chev">▾</span>
                </button>
                <div class="pf-select__menu" id="pfIconMenu" role="listbox" tabindex="-1" hidden></div>
              </div>
              <div class="pf-note">Alegi din setul de iconuri preset (poate fi diferit de platform).</div>
            </div>

            <!-- Upload -->
            <div id="pfIconUploadWrap" hidden>
              <div class="pf-file">
                <input id="pfIconFile" type="file" accept=".svg,image/svg+xml">
                <button class="um-btn um-btn--ghost" type="button" id="pfIconClearUpload">Clear</button>
              </div>
              <div class="pf-note">Upload doar SVG. Noi citim fișierul și îl salvăm ca text SVG în rând.</div>
            </div>

            <!-- Paste -->
            <div id="pfIconPasteWrap" hidden>
              <textarea id="pfIconSvg" placeholder='<svg viewBox="0 0 24 24">...</svg>'></textarea>
              <div class="pf-note">Paste SVG complet. Se salvează exact ce pui aici.</div>
            </div>

            <div class="pf-error" id="pfIconError">SVG invalid. Trebuie să conțină tag-ul &lt;svg ...&gt;.</div>
          </div>
        </div>

        <div class="pf-field">
          <label>Assigned Client (optional)</label>
          <select id="pfAssigned">
            <option value="">All Clients (default)</option>
            <option value="C-2001">Sarah Mitchell • TechVision</option>
            <option value="C-2002">Michael Chen • BrightLabs</option>
            <option value="C-2003">Emily Rodriguez • NorthPeak</option>
          </select>
        </div>

        <!-- Fee moved next to Setup -->
        <div class="pf-row">
          <div class="pf-field">
            <label>Setup ($)</label>
            <input id="pfPageSetup" type="number" min="0" step="0.01" placeholder="250">
          </div>
          <div class="pf-field">
            <label>Fee (%)</label>
            <input id="pfFee" type="number" min="0" step="0.01" placeholder="5">
          </div>
        </div>

        <div class="pf-row">
          <div class="pf-field">
            <label>Init Interval (days)</label>
            <input id="pfInitInterval" type="number" min="0" step="1" placeholder="21">
          </div>
          <div class="pf-field">
            <label>Init Amount ($)</label>
            <input id="pfInitAmount" type="number" min="0" step="0.01" placeholder="30">
          </div>
        </div>

        <div class="pf-row">
          <div class="pf-field">
            <label>Rec Interval (days)</label>
            <input id="pfRecInterval" type="number" min="0" step="1" placeholder="30">
          </div>
          <div class="pf-field">
            <label>Rec Amount ($)</label>
            <input id="pfRecAmount" type="number" min="0" step="0.01" placeholder="50">
          </div>
        </div>

        <div class="pf-hint">
          <b>Rule:</b> if assigned to a client → override. If not assigned → applies to <b>All Clients</b>.
        </div>
      </div>
    </div>

    <div class="pf-drawer__footer">
      <button class="um-btn um-btn--ghost" type="button" id="pfCancelBtn">Cancel</button>
      <button class="um-btn" type="button" id="pfSaveBtn">Save</button>
    </div>
  </aside>

  <!-- ===== Bulk Drawer (unchanged) ===== -->
  <div class="pf-overlay" id="bulkOverlay" hidden></div>
  <aside class="pf-drawer" id="bulkDrawer" aria-hidden="true">
    <div class="pf-drawer__header">
      <div>
        <div class="pf-drawer__title">Bulk Modify</div>
        <div class="pf-drawer__sub">Only fields you fill will be applied to all selected rows.</div>
      </div>
      <button class="um-btn um-btn--icon" type="button" id="bulkCloseBtn" aria-label="Close">✕</button>
    </div>

    <div class="pf-drawer__body">
      <div class="pf-grid">
        <div class="pf-field">
          <label>Platform (optional)</label>
          <input id="bName" type="text" placeholder="leave empty to keep">
        </div>

        <div class="pf-field">
          <label>Assigned Client (optional)</label>
          <select id="bAssigned">
            <option value="">(No change)</option>
            <option value="__ALL__">Set to All Clients</option>
            <option value="C-2001">Sarah Mitchell • TechVision</option>
            <option value="C-2002">Michael Chen • BrightLabs</option>
            <option value="C-2003">Emily Rodriguez • NorthPeak</option>
          </select>
        </div>

        <div class="pf-row">
          <div class="pf-field">
            <label>Setup ($) (optional)</label>
            <input id="bPageSetup" type="number" min="0" step="0.01" placeholder="leave empty to keep">
          </div>
          <div class="pf-field">
            <label>Fee (%) (optional)</label>
            <input id="bFee" type="number" min="0" step="0.01" placeholder="leave empty to keep">
          </div>
        </div>

        <div class="pf-row">
          <div class="pf-field">
            <label>Init Interval (days) (optional)</label>
            <input id="bInitInterval" type="number" min="0" step="1" placeholder="leave empty to keep">
          </div>
          <div class="pf-field">
            <label>Init Amount ($) (optional)</label>
            <input id="bInitAmount" type="number" min="0" step="0.01" placeholder="leave empty to keep">
          </div>
        </div>

        <div class="pf-row">
          <div class="pf-field">
            <label>Rec Interval (days) (optional)</label>
            <input id="bRecInterval" type="number" min="0" step="1" placeholder="leave empty to keep">
          </div>
          <div class="pf-field">
            <label>Rec Amount ($) (optional)</label>
            <input id="bRecAmount" type="number" min="0" step="0.01" placeholder="leave empty to keep">
          </div>
        </div>

        <div class="pf-hint">
          Completezi doar ce vrei să modifici în masă. Restul rămâne neschimbat.
        </div>
      </div>
    </div>

    <div class="pf-drawer__footer">
      <button class="um-btn um-btn--ghost" type="button" id="bulkCancelBtn">Cancel</button>
      <button class="um-btn" type="button" id="bulkApplyBtn">Apply Changes</button>
    </div>
  </aside>

  <script>
    // ========= Switcher redirect =========
    document.querySelectorAll(".um-switcher--top .um-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        const t = btn.dataset.topTab;
        if (t === "employees") window.location.href = "users.html";
      });
    });

    // Handle dropdown item clicks
    document.querySelectorAll('[data-client-view]').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.clientView;
        
        if (view === 'all-clients') {
          window.location.href = 'all-clients.html';
        } else if (view === 'clients') {
          window.location.href = 'clients.html';
        } else if (view === 'notifications') {
          window.location.href = 'users.html?view=notifications';
        }
      });
    });
  </script>

  <script>
    // ========= Helpers =========
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function numberOrNull(v){
      const s = (v ?? "").toString().trim();
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }
    function money(n){
      const num = Number(n);
      if (!Number.isFinite(num)) return "—";
      return `$${num.toFixed(2).replace(/\.00$/, "")}`;
    }
    function pct(n){
      const num = Number(n);
      if (!Number.isFinite(num)) return "—";
      return `${num}%`;
    }
    function isSvgText(s){
      const t = (s ?? "").toString().trim();
      return t.toLowerCase().includes("<svg") && t.toLowerCase().includes("</svg>");
    }
    function safeSvgOrNull(s){
      // minimal sanity; in production you'd sanitize stronger server-side
      const t = (s ?? "").toString().trim();
      if (!isSvgText(t)) return null;
      return t;
    }

    // ========= Platform list (for "Platform" dropdown only) =========
    const PLATFORM_MAP = {
      google: {
        label: "Google Ads",
        svg: `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M21.8 10.2H12v3.9h5.6c-.3 1.7-2 4-5.6 4-3.4 0-6.1-2.8-6.1-6.1S8.6 5.9 12 5.9c1.9 0 3.1.8 3.9 1.5l2.7-2.6C16.9 3.2 14.7 2 12 2 6.9 2 2.7 6.1 2.7 12S6.9 22 12 22c5.7 0 9.5-4 9.5-9.7 0-.7-.1-1.2-.2-1.7z"></path>
          </svg>`
      },
      facebook: {
        label: "Facebook Ads",
        svg: `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M13.6 22v-8.4h2.8l.4-3.3h-3.2V8.2c0-1 .3-1.6 1.7-1.6h1.7V3.7c-.3 0-1.4-.1-2.8-.1-2.8 0-4.7 1.7-4.7 4.9v1.8H6.7v3.3h2.8V22h4.1z"></path>
          </svg>`
      },
      tiktok: {
        label: "TikTok Ads",
        svg: `
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M16.6 3c.4 2.4 1.8 3.9 4.1 4.1v3.2c-1.5.1-2.8-.4-4-1.2v6.2c0 4.2-4.5 6.9-8.4 5.1-2.6-1.2-3.9-4.3-2.9-7.1.9-2.6 3.9-4.4 6.8-3.6v3.4c-1.1-.3-2.3.2-2.9 1.2-.8 1.2-.2 2.9 1.1 3.4 1.7.7 3.4-.5 3.4-2.2V3h2.8z"></path>
          </svg>`
      }
    };

    // ========= Preset icons list (for "Icon" dropdown) =========
    // You can add many here (Meta, Taboola etc.)
    const ICON_PRESETS = {
      google: { label: "Google", svg: PLATFORM_MAP.google.svg },
      facebook: { label: "Facebook", svg: PLATFORM_MAP.facebook.svg },
      tiktok: { label: "TikTok", svg: PLATFORM_MAP.tiktok.svg },
      bolt: { label: "Bolt", svg: `<svg viewBox="0 0 24 24"><path d="M13 2 3 14h7l-1 8 10-12h-7l1-8z"/></svg>` },
      star: { label: "Star", svg: `<svg viewBox="0 0 24 24"><path d="M12 2l3.1 6.3 6.9 1-5 4.9 1.2 6.8L12 17.9 5.8 21l1.2-6.8-5-4.9 6.9-1z"/></svg>` }
    };

    // ========= Mock Data =========
    const clientMap = {
      "": "All Clients",
      "C-2001": "Sarah Mitchell • TechVision",
      "C-2002": "Michael Chen • BrightLabs",
      "C-2003": "Emily Rodriguez • NorthPeak",
    };

    /**
     * row fields:
     * - platformKey: for Platform label dropdown
     * - iconType: "platform" | "preset" | "custom"
     * - iconKey: when iconType="preset" (key in ICON_PRESETS)
     * - iconSvg: when iconType="custom" (raw svg text)
     */
    let rows = [
      { id:"p1", platformKey:"google",   iconType:"platform", iconKey:"", iconSvg:"", pageSetup:250, fee:5, initInterval:21, initAmount:30, recInterval:30, recAmount:50, assigned:"" },
      { id:"p2", platformKey:"facebook", iconType:"preset",   iconKey:"star", iconSvg:"", pageSetup:250, fee:6, initInterval:21, initAmount:30, recInterval:30, recAmount:50, assigned:"" },
      { id:"p3", platformKey:"tiktok",   iconType:"custom",   iconKey:"", iconSvg:`<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 5v6l5 3-1 2-6-4V7h2z"/></svg>`, pageSetup:250, fee:3, initInterval:21, initAmount:30, recInterval:30, recAmount:50, assigned:"C-2002" },
    ];

    // ========= Icon resolver =========
    function resolveRowIcon(row){
      if (!row) return ICON_PRESETS.star.svg;

      if (row.iconType === "custom") {
        const ok = safeSvgOrNull(row.iconSvg);
        if (ok) return ok;
      }
      if (row.iconType === "preset") {
        const p = ICON_PRESETS[row.iconKey];
        if (p?.svg) return p.svg;
      }
      // default: platform
      const pl = PLATFORM_MAP[row.platformKey];
      return pl?.svg || ICON_PRESETS.star.svg;
    }

    // ========= Table refs =========
    const tbody = document.getElementById("pfTbody");
    const selectAll = document.getElementById("selectAll");

    const selCount = document.getElementById("selCount");
    const selHint  = document.getElementById("selHint");
    const bulkModify = document.getElementById("bulkModify");
    const bulkDelete = document.getElementById("bulkDelete");

    function getSelectedRowIds(){
      return Array.from(document.querySelectorAll(".rowCheck"))
        .filter(ch => ch.checked)
        .map(ch => ch.closest("tr")?.dataset.rowId)
        .filter(Boolean);
    }

    function syncBulkState(){
      const selected = getSelectedRowIds();
      const enabled = selected.length > 0;

      selCount.textContent = String(selected.length);
      selHint.textContent = enabled ? "Bulk actions enabled" : "Select rows to enable bulk actions";
      bulkModify.disabled = !enabled;
      bulkDelete.disabled = !enabled;

      const checks = Array.from(document.querySelectorAll(".rowCheck"));
      const allChecked = checks.length && checks.every(c => c.checked);
      const noneChecked = checks.every(c => !c.checked);

      selectAll.indeterminate = !allChecked && !noneChecked;
      selectAll.checked = allChecked;
    }

    function render(){
      tbody.innerHTML = rows.map(r => {
        const p = PLATFORM_MAP[r.platformKey] || PLATFORM_MAP.google;
        const iconSvg = resolveRowIcon(r);
        return `
          <tr data-row-id="${escapeHtml(r.id)}">
            <td><input type="checkbox" class="rowCheck" aria-label="Select row"></td>

            <td data-col="icon">
              <span class="pf-icon" title="Icon">${iconSvg}</span>
            </td>

            <td><b>${escapeHtml(p.label)}</b></td>
            <td>${money(r.pageSetup)}</td>
            <td>${pct(r.fee)}</td>
            <td>${escapeHtml(String(r.initInterval ?? ""))}</td>
            <td><b>${money(r.initAmount)}</b></td>
            <td>${escapeHtml(String(r.recInterval ?? ""))}</td>
            <td><b>${money(r.recAmount)}</b></td>
            <td>${escapeHtml(clientMap[r.assigned] ?? "All Clients")}</td>
            <td style="text-align:right;">
              <button class="um-btn um-btn--ghost" type="button" data-edit-one>Edit</button>
              <button class="um-btn um-btn--ghost" type="button" data-del-one>Delete</button>
            </td>
          </tr>
        `;
      }).join("");

      wireRowHandlers();
      syncBulkState();
    }

    function wireRowHandlers(){
      document.querySelectorAll(".rowCheck").forEach(ch => {
        ch.addEventListener("change", syncBulkState);
      });

      document.querySelectorAll("[data-del-one]").forEach(btn => {
        btn.addEventListener("click", () => {
          const tr = btn.closest("tr");
          const id = tr?.dataset.rowId;
          if (!id) return;

          if (!confirm("Delete this platform row?")) return;
          rows = rows.filter(x => x.id !== id);
          render();
        });
      });

      document.querySelectorAll("[data-edit-one]").forEach(btn => {
        btn.addEventListener("click", () => {
          const tr = btn.closest("tr");
          const id = tr?.dataset.rowId;
          const row = rows.find(x => x.id === id);
          if (!row) return;

          openPlatformDrawer("edit", row);
        });
      });
    }

    selectAll.addEventListener("change", () => {
      const checked = selectAll.checked;
      document.querySelectorAll(".rowCheck").forEach(ch => ch.checked = checked);
      syncBulkState();
    });

    // ========= Drawer helpers =========
    function openDrawer(overlayEl, drawerEl){
      overlayEl.hidden = false;
      drawerEl.classList.add("is-open");
      drawerEl.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }
    function closeDrawer(overlayEl, drawerEl){
      overlayEl.hidden = true;
      drawerEl.classList.remove("is-open");
      drawerEl.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    // ========= Platform Drawer (Add/Edit) =========
    const pfOverlay = document.getElementById("pfOverlay");
    const pfDrawer  = document.getElementById("pfDrawer");

    const pfTitle = document.getElementById("pfTitle");
    const pfSub   = document.getElementById("pfSub");

    const pfCloseBtn  = document.getElementById("pfCloseBtn");
    const pfCancelBtn = document.getElementById("pfCancelBtn");
    const pfSaveBtn   = document.getElementById("pfSaveBtn");
    const openAddPlatform = document.getElementById("openAddPlatform");

    // platform dropdown elements
    const pfPlatformKey = document.getElementById("pfPlatformKey");
    const pfPlatformSelect = document.getElementById("pfPlatformSelect");
    const pfPlatformBtn = document.getElementById("pfPlatformBtn");
    const pfPlatformMenu = document.getElementById("pfPlatformMenu");
    const pfPlatformIcon = document.getElementById("pfPlatformIcon");
    const pfPlatformLabel = document.getElementById("pfPlatformLabel");

    // icon controls
    const chipPreset = document.getElementById("chipPreset");
    const chipUpload = document.getElementById("chipUpload");
    const chipPaste  = document.getElementById("chipPaste");

    const pfIconUsePlatformDefault = document.getElementById("pfIconUsePlatformDefault");

    const pfIconPreview = document.getElementById("pfIconPreview");
    const pfIconPreviewLabel = document.getElementById("pfIconPreviewLabel");

    const pfIconPresetWrap = document.getElementById("pfIconPresetWrap");
    const pfIconUploadWrap = document.getElementById("pfIconUploadWrap");
    const pfIconPasteWrap  = document.getElementById("pfIconPasteWrap");

    const pfIconPresetKey = document.getElementById("pfIconPresetKey");
    const pfIconSelect = document.getElementById("pfIconSelect");
    const pfIconBtn = document.getElementById("pfIconBtn");
    const pfIconMenu = document.getElementById("pfIconMenu");
    const pfIconPresetIcon = document.getElementById("pfIconPresetIcon");
    const pfIconPresetLabel = document.getElementById("pfIconPresetLabel");

    const pfIconFile = document.getElementById("pfIconFile");
    const pfIconClearUpload = document.getElementById("pfIconClearUpload");
    const pfIconSvg = document.getElementById("pfIconSvg");
    const pfIconError = document.getElementById("pfIconError");

    // fields
    const pfAssigned = document.getElementById("pfAssigned");
    const pfPageSetup = document.getElementById("pfPageSetup");
    const pfFee = document.getElementById("pfFee");
    const pfInitInterval = document.getElementById("pfInitInterval");
    const pfInitAmount = document.getElementById("pfInitAmount");
    const pfRecInterval = document.getElementById("pfRecInterval");
    const pfRecAmount = document.getElementById("pfRecAmount");

    let pfMode = "add";
    let pfEditingId = null;

    // -------- platform dropdown
    function setPlatformSelection(key){
      const p = PLATFORM_MAP[key] || PLATFORM_MAP.google;
      pfPlatformKey.value = key;
      pfPlatformIcon.innerHTML = p.svg;
      pfPlatformLabel.textContent = p.label;

      // if icon mode is "platform", preview should update instantly
      updateIconPreview();
      // keep menu selection state
      pfPlatformMenu.querySelectorAll(".pf-opt").forEach(b => {
        b.setAttribute("aria-selected", b.dataset.value === key ? "true" : "false");
      });
    }

    function buildPlatformMenu(){
      pfPlatformMenu.innerHTML = Object.entries(PLATFORM_MAP).map(([key, p]) => `
        <button type="button"
          class="pf-opt"
          role="option"
          data-value="${escapeHtml(key)}"
          aria-selected="${key === pfPlatformKey.value ? "true" : "false"}">
          <span class="pf-icon">${p.svg}</span>
          <span>${escapeHtml(p.label)}</span>
        </button>
      `).join("");

      pfPlatformMenu.querySelectorAll(".pf-opt").forEach(btn => {
        btn.addEventListener("click", () => {
          setPlatformSelection(btn.dataset.value);
          closePlatformMenu();
        });
      });
    }

    function openPlatformMenu(){
      pfPlatformMenu.hidden = false;
      pfPlatformBtn.setAttribute("aria-expanded", "true");
      buildPlatformMenu();
    }
    function closePlatformMenu(){
      pfPlatformMenu.hidden = true;
      pfPlatformBtn.setAttribute("aria-expanded", "false");
    }
    function togglePlatformMenu(){
      if (pfPlatformMenu.hidden) openPlatformMenu();
      else closePlatformMenu();
    }
    pfPlatformBtn.addEventListener("click", togglePlatformMenu);

    // -------- icon preset dropdown
    function setIconPresetSelection(key){
      const p = ICON_PRESETS[key] || ICON_PRESETS.google;
      pfIconPresetKey.value = key;
      pfIconPresetIcon.innerHTML = p.svg;
      pfIconPresetLabel.textContent = p.label;

      updateIconPreview();

      pfIconMenu.querySelectorAll(".pf-opt").forEach(b => {
        b.setAttribute("aria-selected", b.dataset.value === key ? "true" : "false");
      });
    }

    function buildIconMenu(){
      pfIconMenu.innerHTML = Object.entries(ICON_PRESETS).map(([key, p]) => `
        <button type="button"
          class="pf-opt"
          role="option"
          data-value="${escapeHtml(key)}"
          aria-selected="${key === pfIconPresetKey.value ? "true" : "false"}">
          <span class="pf-icon">${p.svg}</span>
          <span>${escapeHtml(p.label)}</span>
        </button>
      `).join("");

      pfIconMenu.querySelectorAll(".pf-opt").forEach(btn => {
        btn.addEventListener("click", () => {
          setIconPresetSelection(btn.dataset.value);
          closeIconMenu();
        });
      });
    }

    function openIconMenu(){
      pfIconMenu.hidden = false;
      pfIconBtn.setAttribute("aria-expanded", "true");
      buildIconMenu();
    }
    function closeIconMenu(){
      pfIconMenu.hidden = true;
      pfIconBtn.setAttribute("aria-expanded", "false");
    }
    function toggleIconMenu(){
      if (pfIconMenu.hidden) openIconMenu();
      else closeIconMenu();
    }
    pfIconBtn.addEventListener("click", toggleIconMenu);

    // close dropdowns outside click
    document.addEventListener("click", (e) => {
      if (!pfPlatformSelect.contains(e.target)) closePlatformMenu();
      if (!pfIconSelect.contains(e.target)) closeIconMenu();
    });

    // -------- icon mode switching
    function setIconMode(mode){
      // chips UI
      [chipPreset, chipUpload, chipPaste].forEach(c => c.classList.remove("is-active"));
      if (mode === "preset") chipPreset.classList.add("is-active");
      if (mode === "upload") chipUpload.classList.add("is-active");
      if (mode === "paste")  chipPaste.classList.add("is-active");

      // panels
      pfIconPresetWrap.hidden = (mode !== "preset");
      pfIconUploadWrap.hidden = (mode !== "upload");
      pfIconPasteWrap.hidden  = (mode !== "paste");

      // clear error on switch
      pfIconError.classList.remove("is-show");

      updateIconPreview();
    }

    function getIconMode(){
      const checked = document.querySelector('input[name="pfIconMode"]:checked');
      return checked?.value || "preset";
    }

    // clicking chips toggles radio
    [chipPreset, chipUpload, chipPaste].forEach(chip => {
      chip.addEventListener("click", () => {
        chip.querySelector("input").checked = true;
        setIconMode(getIconMode());
      });
    });

    // use platform default button
    pfIconUsePlatformDefault.addEventListener("click", () => {
      // set to "platform" virtual mode (we store this in row as iconType="platform")
      // UI: select preset tab but show preview from platform + mark internally using a hidden flag
      _iconTypeOverride = "platform";
      pfIconError.classList.remove("is-show");
      updateIconPreview();
      pfIconPreviewLabel.textContent = "Platform default icon";
    });

    // we keep an internal override while editing
    let _iconTypeOverride = "preset"; // "platform" | "preset" | "custom(upload/paste)"

    function setInternalIconType(t){
      _iconTypeOverride = t;
      updateIconPreview();
    }

    // Any interaction with preset/upload/paste sets override away from platform
    pfIconBtn.addEventListener("click", () => setInternalIconType("preset"));
    pfIconSvg.addEventListener("input", () => setInternalIconType("custom"));
    pfIconFile.addEventListener("change", () => setInternalIconType("custom"));

    // upload svg file -> read text
    pfIconFile.addEventListener("change", async () => {
      const file = pfIconFile.files?.[0];
      if (!file) { updateIconPreview(); return; }
      const text = await file.text();
      pfIconSvg.value = text; // store it in textarea too (handy)
      setIconMode("upload");
      setInternalIconType("custom");
      updateIconPreview();
    });

    pfIconClearUpload.addEventListener("click", () => {
      pfIconFile.value = "";
      if (getIconMode() === "upload") {
        // don't destroy pasted content, but clear if it came from upload
        // we'll just keep textarea as is; user can decide
      }
      updateIconPreview();
    });

    // preview logic
    function updateIconPreview(){
      pfIconError.classList.remove("is-show");

      const platformKey = pfPlatformKey.value || "google";
      const platformSvg = PLATFORM_MAP[platformKey]?.svg || ICON_PRESETS.star.svg;

      // if user forced platform default
      if (_iconTypeOverride === "platform") {
        pfIconPreview.innerHTML = platformSvg;
        pfIconPreviewLabel.textContent = "Platform default icon";
        return;
      }

      const mode = getIconMode();

      if (mode === "preset") {
        const k = pfIconPresetKey.value || "google";
        const presetSvg = ICON_PRESETS[k]?.svg || ICON_PRESETS.star.svg;
        pfIconPreview.innerHTML = presetSvg;
        pfIconPreviewLabel.textContent = `Preset: ${ICON_PRESETS[k]?.label || k}`;
        return;
      }

      // upload/paste -> use textarea content
      const svgText = pfIconSvg.value;
      const ok = safeSvgOrNull(svgText);
      if (!ok) {
        pfIconPreview.innerHTML = platformSvg; // fallback visual
        pfIconPreviewLabel.textContent = "Invalid SVG (fallback shown)";
        if (svgText.trim().length) pfIconError.classList.add("is-show");
        return;
      }

      pfIconPreview.innerHTML = ok;
      pfIconPreviewLabel.textContent = (mode === "upload") ? "Custom: uploaded SVG" : "Custom: pasted SVG";
    }

    // ========= open drawer + fill =========
    function openPlatformDrawer(mode, row){
      pfMode = mode;
      pfEditingId = row?.id ?? null;

      if (mode === "edit") {
        pfTitle.textContent = "Edit Platform";
        pfSub.textContent = "Update values for this row.";
      } else {
        pfTitle.textContent = "Add New Platform";
        pfSub.textContent = "Create global row or assign to a specific client.";
      }

      // Platform
      setPlatformSelection(row?.platformKey ?? "google");

      // Assigned + numbers
      pfAssigned.value = row?.assigned ?? "";
      pfPageSetup.value = (row?.pageSetup ?? "");
      pfFee.value = (row?.fee ?? "");
      pfInitInterval.value = (row?.initInterval ?? "");
      pfInitAmount.value = (row?.initAmount ?? "");
      pfRecInterval.value = (row?.recInterval ?? "");
      pfRecAmount.value = (row?.recAmount ?? "");

      // Icon state
      // default internal override based on row.iconType
      if (!row || row.iconType === "platform") {
        _iconTypeOverride = "platform";
      } else if (row.iconType === "preset") {
        _iconTypeOverride = "preset";
      } else {
        _iconTypeOverride = "custom";
      }

      // reset UI panels
      pfIconFile.value = "";

      // preset key
      pfIconPresetKey.value = row?.iconKey || "google";
      setIconPresetSelection(pfIconPresetKey.value);

      // custom svg
      pfIconSvg.value = row?.iconSvg || "";

      // mode tab selection
      if (!row || row.iconType === "platform" || row.iconType === "preset") {
        // show preset by default (even if platform forced, preview will show platform)
        document.querySelector('input[name="pfIconMode"][value="preset"]').checked = true;
        setIconMode("preset");
      } else {
        // custom
        document.querySelector('input[name="pfIconMode"][value="paste"]').checked = true;
        setIconMode("paste");
      }

      // set preview correct
      updateIconPreview();

      closePlatformMenu();
      closeIconMenu();
      openDrawer(pfOverlay, pfDrawer);
    }

    function readPlatformForm(){
      // Decide iconType + data:
      // - if override is platform => iconType="platform"
      // - else if mode preset => iconType="preset", iconKey = chosen
      // - else => iconType="custom", iconSvg = textarea (validated)
      const platformKey = pfPlatformKey.value || "google";
      const mode = getIconMode();

      let iconType = "platform";
      let iconKey = "";
      let iconSvg = "";

      if (_iconTypeOverride === "platform") {
        iconType = "platform";
      } else if (mode === "preset") {
        iconType = "preset";
        iconKey = pfIconPresetKey.value || "google";
      } else {
        iconType = "custom";
        const ok = safeSvgOrNull(pfIconSvg.value);
        if (!ok) return { __error: "Invalid SVG. Please paste/upload a valid <svg>...</svg>." };
        iconSvg = ok;
      }

      return {
        platformKey,
        iconType,
        iconKey,
        iconSvg,
        assigned: pfAssigned.value || "",
        pageSetup: numberOrNull(pfPageSetup.value),
        fee: numberOrNull(pfFee.value),
        initInterval: numberOrNull(pfInitInterval.value),
        initAmount: numberOrNull(pfInitAmount.value),
        recInterval: numberOrNull(pfRecInterval.value),
        recAmount: numberOrNull(pfRecAmount.value),
      };
    }

    // ========= drawer buttons =========
    openAddPlatform.addEventListener("click", () => openPlatformDrawer("add", null));

    pfOverlay.addEventListener("click", () => closeDrawer(pfOverlay, pfDrawer));
    pfCloseBtn.addEventListener("click", () => closeDrawer(pfOverlay, pfDrawer));
    pfCancelBtn.addEventListener("click", () => closeDrawer(pfOverlay, pfDrawer));

    pfSaveBtn.addEventListener("click", () => {
      const data = readPlatformForm();
      if (data.__error) { alert(data.__error); return; }
      if (!data.platformKey) { alert("Platform is required."); return; }

      if (pfMode === "add") {
        rows.unshift({ id: "p_" + Math.random().toString(16).slice(2), ...data });
      } else {
        rows = rows.map(r => r.id === pfEditingId ? { ...r, ...data } : r);
      }

      closeDrawer(pfOverlay, pfDrawer);
      render();
    });

    // ========= Bulk Drawer (unchanged) =========
    const bulkOverlayEl = document.getElementById("bulkOverlay");
    const bulkDrawerEl  = document.getElementById("bulkDrawer");

    const bulkCloseBtn  = document.getElementById("bulkCloseBtn");
    const bulkCancelBtn = document.getElementById("bulkCancelBtn");
    const bulkApplyBtn  = document.getElementById("bulkApplyBtn");

    const bName = document.getElementById("bName");
    const bAssigned = document.getElementById("bAssigned");
    const bPageSetup = document.getElementById("bPageSetup");
    const bFee = document.getElementById("bFee");
    const bInitInterval = document.getElementById("bInitInterval");
    const bInitAmount = document.getElementById("bInitAmount");
    const bRecInterval = document.getElementById("bRecInterval");
    const bRecAmount = document.getElementById("bRecAmount");

    function resetBulk(){
      [bName,bPageSetup,bFee,bInitInterval,bInitAmount,bRecInterval,bRecAmount].forEach(i => i.value = "");
      bAssigned.value = "";
    }

    bulkModify.addEventListener("click", () => {
      const sel = getSelectedRowIds();
      if (!sel.length) return;
      resetBulk();
      openDrawer(bulkOverlayEl, bulkDrawerEl);
    });

    bulkDelete.addEventListener("click", () => {
      const sel = getSelectedRowIds();
      if (!sel.length) return;

      if (!confirm(`Delete ${sel.length} selected row(s)?`)) return;
      rows = rows.filter(r => !sel.includes(r.id));
      render();
    });

    bulkOverlayEl.addEventListener("click", () => closeDrawer(bulkOverlayEl, bulkDrawerEl));
    bulkCloseBtn.addEventListener("click", () => closeDrawer(bulkOverlayEl, bulkDrawerEl));
    bulkCancelBtn.addEventListener("click", () => closeDrawer(bulkOverlayEl, bulkDrawerEl));

    bulkApplyBtn.addEventListener("click", () => {
      const sel = getSelectedRowIds();
      if (!sel.length) return;

      const patch = {
        name: bName.value.trim(),
        assigned: bAssigned.value,
        pageSetup: numberOrNull(bPageSetup.value),
        fee: numberOrNull(bFee.value),
        initInterval: numberOrNull(bInitInterval.value),
        initAmount: numberOrNull(bInitAmount.value),
        recInterval: numberOrNull(bRecInterval.value),
        recAmount: numberOrNull(bRecAmount.value),
      };

      rows = rows.map(r => {
        if (!sel.includes(r.id)) return r;
        const next = { ...r };

        // map typed platform label -> platformKey if matches
        if (patch.name) {
          const target = patch.name.toLowerCase();
          const foundKey = Object.entries(PLATFORM_MAP).find(([k,v]) =>
            v.label.toLowerCase() === target || k === target
          )?.[0];
          if (foundKey) next.platformKey = foundKey;
        }

        if (patch.assigned) next.assigned = (patch.assigned === "__ALL__") ? "" : patch.assigned;

        if (patch.pageSetup !== null) next.pageSetup = patch.pageSetup;
        if (patch.fee !== null) next.fee = patch.fee;

        if (patch.initInterval !== null) next.initInterval = patch.initInterval;
        if (patch.initAmount !== null) next.initAmount = patch.initAmount;

        if (patch.recInterval !== null) next.recInterval = patch.recInterval;
        if (patch.recAmount !== null) next.recAmount = patch.recAmount;

        return next;
      });

      closeDrawer(bulkOverlayEl, bulkDrawerEl);
      render();
    });

    // ESC closes any open drawer + dropdowns
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      closePlatformMenu();
      closeIconMenu();
      closeDrawer(pfOverlay, pfDrawer);
      closeDrawer(bulkOverlayEl, bulkDrawerEl);
    });

    // ========= init dropdown defaults =========
    (function initDropdownDefaults(){
      // Platform default
      setPlatformSelection("google");

      // Icon preset default
      setIconPresetSelection("google");

      // Default icon type is platform for fresh add (but UI shows preset tab)
      _iconTypeOverride = "platform";
      updateIconPreview();

      render();
    })();
  </script>

  <script src="../js/sidebar.js"></script>
</body>
</html>
