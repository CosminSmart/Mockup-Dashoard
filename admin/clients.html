<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clients</title>

  <link rel="stylesheet" href="../css/layout.css">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/users.css">
  <link rel="stylesheet" href="../css/sidebar.css">
</head>

<body>
  <div class="layout">
    <header class="header">
      <h1>User Management</h1>
      <div class="user-info">
        <span>Admin User</span>
        <div class="user-avatar">AU</div>
      </div>
    </header>

    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <div class="content-section">

        <!-- SWITCHER -->
        <div class="um-switcher um-switcher--top" role="tablist" aria-label="Clients/Employees Switcher">
          <button class="um-tab is-active" type="button" data-tab="clients" role="tab" aria-selected="true">
            Clients
          </button>
          <button class="um-tab" type="button" data-tab="employees" role="tab" aria-selected="false">
            Employees
          </button>
        </div>

        <h2>Clients</h2>

        <!-- Clients Dropdown Menu -->
        <div class="um-dropdown-compact" id="clientsDropdown">
          <button class="um-dropdown-toggle" id="clientsDropdownToggle">
            <span class="um-dropdown-current">Clients List</span>
            <span class="um-dropdown-arrow">‚ñæ</span>
          </button>
          <div class="um-dropdown-menu" id="clientsDropdownMenu" style="display: none;">
            <button class="um-dropdown-item is-active" data-client-view="clients">
              <span>Clients List</span>
              <span class="um-dropdown-desc">Manage individual clients</span>
            </button>
            <button class="um-dropdown-item" data-client-view="all-clients">
              <span>Platforms & Fees</span>
              <span class="um-dropdown-desc">View all clients with platforms & fees</span>
            </button>
            <button class="um-dropdown-item" data-client-view="notifications">
              <span>Clients Notifications</span>
              <span class="um-dropdown-desc">Send notifications to clients</span>
            </button>
          </div>
        </div>

        <style>
          .um-dropdown-compact {
            position: relative;
            margin-top: 12px;
            margin-bottom: 16px;
          }

          .um-dropdown-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 14px;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.10);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            color: #1a202c;
            width: 280px;
            transition: all 0.15s;
          }

          .um-dropdown-toggle:hover {
            border-color: rgba(0,0,0,0.20);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          }

          .um-dropdown-arrow {
            font-size: 12px;
            opacity: 0.6;
            transition: transform 0.2s;
          }

          .um-dropdown-toggle.is-open .um-dropdown-arrow {
            transform: rotate(180deg);
          }

          .um-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: #fff;
            border: 1px solid rgba(0,0,0,0.10);
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            z-index: 100;
            min-width: 320px;
          }

          .um-dropdown-item {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            padding: 12px 14px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            text-align: left;
            transition: background 0.15s;
          }

          .um-dropdown-item:hover {
            background: rgba(0,0,0,0.04);
          }

          .um-dropdown-item.is-active {
            background: rgba(0,0,0,0.06);
          }

          .um-dropdown-item span:first-child {
            font-weight: 700;
            font-size: 14px;
            color: #1a202c;
          }

          .um-dropdown-desc {
            font-size: 12px;
            color: #64748b;
            font-weight: 400;
          }
        </style>

        <script>
          // Toggle dropdown
          const dropdownToggle = document.getElementById('clientsDropdownToggle');
          const dropdownMenu = document.getElementById('clientsDropdownMenu');

          dropdownToggle?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = dropdownMenu.style.display !== 'none';
            dropdownMenu.style.display = isOpen ? 'none' : 'block';
            dropdownToggle.classList.toggle('is-open', !isOpen);
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', () => {
            if (dropdownMenu) {
              dropdownMenu.style.display = 'none';
              dropdownToggle?.classList.remove('is-open');
            }
          });

          // Prevent closing when clicking inside menu
          dropdownMenu?.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        </script>

        <p>Manage your clients list and details.</p>

        <section class="um-view is-active">

          <!-- Filters + Search -->
          <div class="um-filters">
            <div class="um-filters__left">
              <input class="um-input" id="clientSearch" type="search"
                     placeholder="Search clients (name, email, company, telegram, id)..." />
            </div>

            <div class="um-filters__right">
              <select class="um-select" id="statusFilter">
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
              </select>

              <select class="um-select" id="createdSort">
                <option value="newest">Created: Newest</option>
                <option value="oldest">Created: Oldest</option>
              </select>

              <button class="um-btn um-btn--ghost" type="button" id="clearFilters">Clear</button>
            </div>
          </div>

          <div class="um-table-wrap">
            <table class="um-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Client Name</th>
                  <th>Company</th>
                  <th>Telegram</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th style="text-align:right;">Actions</th>
                </tr>
              </thead>

              <tbody>
                <tr
                  data-id="C-2001"
                  data-name="Sarah Mitchell"
                  data-company="TechVision Corp"
                  data-telegram="@sarah_mitchell"
                  data-email="sarah.mitchell@techvision.com"
                  data-phone="+1 (555) 234-5678"
                  data-country="United States"
                  data-status="Active"
                  data-spend="$284.5K"
                  data-value="$320K"
                  data-active-accounts="12"
                  data-engagement="98%"
                >
                  <td>#C-2001</td>
                  <td>Sarah Mitchell</td>
                  <td>TechVision Corp</td>
                  <td>@sarah_mitchell</td>
                  <td>sarah.mitchell@techvision.com</td>
                  <td>
                    <select class="um-select client-status-select" data-client-id="C-2001" data-client-email="sarah.mitchell@techvision.com" style="padding: 6px 10px; font-size: 13px; min-width: 130px;">
                      <option value="Active" selected>Active</option>
                      <option value="Pending">Pending</option>
                      <option value="Inactive">Inactive</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </td>
                  <td>2026-01-12</td>
                  <td style="text-align:right;">
                    <button class="um-btn um-btn--ghost" type="button" data-view>View</button>
                  </td>
                </tr>

                <tr
                  data-id="C-2002"
                  data-name="Michael Chen"
                  data-company="BrightLabs"
                  data-telegram="@michael_chen"
                  data-email="michael.chen@brightlabs.io"
                  data-phone="+44 20 7946 0000"
                  data-country="United Kingdom"
                  data-status="Pending"
                  data-spend="$12.0K"
                  data-value="$18K"
                  data-active-accounts="2"
                  data-engagement="61%"
                >
                  <td>#C-2002</td>
                  <td>Michael Chen</td>
                  <td>BrightLabs</td>
                  <td>@michael_chen</td>
                  <td>michael.chen@brightlabs.io</td>
                  <td>
                    <select class="um-select client-status-select" data-client-id="C-2002" data-client-email="michael.chen@brightlabs.io" style="padding: 6px 10px; font-size: 13px; min-width: 130px;">
                      <option value="Active">Active</option>
                      <option value="Pending" selected>Pending</option>
                      <option value="Inactive">Inactive</option>
                      <option value="Maintenance">Maintenance</option>
                    </select>
                  </td>
                  <td>2026-01-20</td>
                  <td style="text-align:right;">
                    <button class="um-btn um-btn--ghost" type="button" data-view>View</button>
                  </td>
                </tr>

              </tbody>
            </table>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Confirmation Modal for Maintenance Status -->
  <div class="um-overlay" id="maintenanceModalOverlay" hidden></div>
  <div class="um-modal" id="maintenanceModal" hidden>
    <div class="um-modal__content">
      <h3 class="um-modal__title">Set Client to Maintenance?</h3>
      <p class="um-modal__message">
        Client will not be able to access the platform.
      </p>
      <p class="um-modal__client-info" id="modalClientInfo"></p>
      <div class="um-modal__actions">
        <button class="um-btn um-btn--ghost" type="button" id="modalCancelBtn">Cancel</button>
        <button class="um-btn" type="button" id="modalConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <style>
    .um-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1001;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      max-width: 420px;
      width: 90%;
    }

    .um-modal__content {
      padding: 24px;
    }

    .um-modal__title {
      font-size: 18px;
      font-weight: 800;
      color: #1a202c;
      margin-bottom: 10px;
    }

    .um-modal__message {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 12px;
    }

    .um-modal__client-info {
      background: rgba(0, 0, 0, 0.04);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 20px;
      font-size: 13px;
      font-weight: 700;
      color: #1a202c;
    }

    .um-modal__actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    @media (max-width: 520px) {
      .um-modal__content {
        padding: 20px;
      }
    }
  </style>

  <script>
    // Switcher redirect: Employees -> users.html
    document.querySelectorAll(".um-switcher--top .um-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        if (btn.dataset.tab === "employees") window.location.href = "users.html";
      });
    });

    // Handle dropdown item clicks
    document.querySelectorAll('[data-client-view]').forEach(item => {
      item.addEventListener('click', () => {
        const view = item.dataset.clientView;
        
        if (view === 'all-clients') {
          window.location.href = 'all-clients.html';
        } else if (view === 'clients') {
          window.location.href = 'clients.html';
        } else if (view === 'notifications') {
          window.location.href = 'users.html?view=notifications';
        }
      });
    });

    // View -> redirect to separate page
    document.querySelectorAll("[data-view]").forEach(btn => {
      btn.addEventListener("click", () => {
        const tr = btn.closest("tr");
        if (!tr) return;

        const id = (tr.dataset.id || "").trim();
        if (!id) return;

        // Optional: store full details so details page can read them (no backend yet)
        const payload = {
          id,
          name: tr.dataset.name,
          company: tr.dataset.company,
          telegram: tr.dataset.telegram,
          email: tr.dataset.email,
          phone: tr.dataset.phone,
          country: tr.dataset.country,
          status: tr.dataset.status,
          spend: tr.dataset.spend,
          value: tr.dataset.value,
          activeAccounts: tr.dataset.activeAccounts,
          engagement: tr.dataset.engagement,
          created: tr.children[6]?.textContent?.trim() || ""
        };

        localStorage.setItem("client:" + id, JSON.stringify(payload));

        // Redirect with query param
        window.location.href = "client-details.html?id=" + encodeURIComponent(id);
      });
    });
  </script>

  <script>
    // ===== Clients: Search + Filters + Sort =====
    const searchEl = document.getElementById("clientSearch");
    const statusEl = document.getElementById("statusFilter");
    const sortEl = document.getElementById("createdSort");
    const clearBtn = document.getElementById("clearFilters");
    const tbody = document.querySelector(".um-table tbody");

    function normalize(s){ return (s || "").toString().trim().toLowerCase(); }

    function getRowCreatedDate(tr){
      const createdText = tr.children[6]?.textContent?.trim() || "";
      const d = new Date(createdText);
      return isNaN(d.getTime()) ? new Date(0) : d;
    }

    function getRowStatus(tr){
      const badge = tr.children[5]?.querySelector(".um-badge");
      return normalize(badge ? badge.textContent : tr.children[5]?.textContent);
    }

    function rowMatchesSearch(tr, q){
      if (!q) return true;
      const id = tr.children[0]?.textContent || "";
      const name = tr.children[1]?.textContent || "";
      const company = tr.children[2]?.textContent || "";
      const telegram = tr.children[3]?.textContent || "";
      const email = tr.children[4]?.textContent || "";
      const hay = normalize([id, name, company, telegram, email].join(" "));
      return hay.includes(q);
    }

    function applyFilters(){
      const q = normalize(searchEl?.value);
      const status = normalize(statusEl?.value);
      const rows = Array.from(tbody.querySelectorAll("tr"));

      rows.forEach(tr => {
        const okSearch = rowMatchesSearch(tr, q);
        const rowStatus = getRowStatus(tr);
        const okStatus = (status === "all") ? true : (rowStatus === status);
        tr.style.display = (okSearch && okStatus) ? "" : "none";
      });

      applySort();
    }

    function applySort(){
      const mode = sortEl?.value || "newest";
      const rows = Array.from(tbody.querySelectorAll("tr"));
      rows.sort((a,b) => {
        const da = getRowCreatedDate(a).getTime();
        const db = getRowCreatedDate(b).getTime();
        return mode === "oldest" ? (da - db) : (db - da);
      });
      rows.forEach(r => tbody.appendChild(r));
    }

    searchEl?.addEventListener("input", applyFilters);
    statusEl?.addEventListener("change", applyFilters);
    sortEl?.addEventListener("change", applySort);

    clearBtn?.addEventListener("click", () => {
      if (searchEl) searchEl.value = "";
      if (statusEl) statusEl.value = "all";
      if (sortEl) sortEl.value = "newest";
      applyFilters();
    });

    applyFilters();
  </script>

  <script>
    // ===== Maintenance Modal =====
    const maintenanceModal = document.getElementById('maintenanceModal');
    const maintenanceModalOverlay = document.getElementById('maintenanceModalOverlay');
    const modalClientInfo = document.getElementById('modalClientInfo');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    
    let pendingStatusChange = null;

    function showMaintenanceModal(clientId, clientName, onConfirm, onCancel) {
      modalClientInfo.textContent = `Client: ${clientName} (${clientId})`;
      maintenanceModalOverlay.hidden = false;
      maintenanceModal.hidden = false;
      
      // Store callbacks
      pendingStatusChange = { onConfirm, onCancel };
    }

    function hideMaintenanceModal() {
      maintenanceModalOverlay.hidden = true;
      maintenanceModal.hidden = true;
      pendingStatusChange = null;
    }

    modalCancelBtn.addEventListener('click', () => {
      if (pendingStatusChange && pendingStatusChange.onCancel) {
        pendingStatusChange.onCancel();
      }
      hideMaintenanceModal();
    });

    modalConfirmBtn.addEventListener('click', () => {
      if (pendingStatusChange && pendingStatusChange.onConfirm) {
        pendingStatusChange.onConfirm();
      }
      hideMaintenanceModal();
    });

    maintenanceModalOverlay.addEventListener('click', () => {
      if (pendingStatusChange && pendingStatusChange.onCancel) {
        pendingStatusChange.onCancel();
      }
      hideMaintenanceModal();
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !maintenanceModal.hidden) {
        if (pendingStatusChange && pendingStatusChange.onCancel) {
          pendingStatusChange.onCancel();
        }
        hideMaintenanceModal();
      }
    });

    // ===== Client Status Change Handler =====
    document.querySelectorAll('.client-status-select').forEach(select => {
      select.addEventListener('change', function() {
        const clientId = this.dataset.clientId;
        const clientEmail = this.dataset.clientEmail;
        const newStatus = this.value;
        const oldStatus = this.dataset.oldStatus || this.value;
        
        // Store old status for potential rollback
        this.dataset.oldStatus = oldStatus;
        
        // Get client name from the row
        const row = this.closest('tr');
        const clientName = row ? row.children[1]?.textContent : clientId;
        
        // Only confirm if changing to Maintenance
        if (newStatus === 'Maintenance') {
          showMaintenanceModal(
            clientId,
            clientName,
            // onConfirm
            () => {
              applyStatusChange(this, clientId, clientEmail, newStatus, row);
            },
            // onCancel
            () => {
              this.value = oldStatus;
            }
          );
        } else {
          // Apply change immediately for other statuses
          applyStatusChange(this, clientId, clientEmail, newStatus, row);
        }
      });
      
      // Set initial styling
      select.style.background = getStatusColor(select.value);
      select.style.color = '#000';
      select.style.fontWeight = '700';
      select.dataset.oldStatus = select.value;
    });
    
    function applyStatusChange(selectElement, clientId, clientEmail, newStatus, row) {
      // Save status to localStorage
      if (clientEmail) {
        localStorage.setItem('clientStatus_' + clientEmail, newStatus);
      }
      
      // Update the data-status attribute on the row
      if (row) {
        row.dataset.status = newStatus;
      }
      
      // Update stored client data
      const storedClient = localStorage.getItem('client:' + clientId);
      if (storedClient) {
        try {
          const clientData = JSON.parse(storedClient);
          clientData.status = newStatus;
          localStorage.setItem('client:' + clientId, JSON.stringify(clientData));
        } catch (e) {
          console.error('Error updating client data:', e);
        }
      }
      
      // Update old status for next change
      selectElement.dataset.oldStatus = newStatus;
      
      // Show success message
      const statusMessages = {
        'Active': '‚úÖ Client activated successfully',
        'Pending': '‚è≥ Client set to pending approval',
        'Inactive': '‚ùå Client deactivated',
        'Maintenance': 'üîß Client account set to maintenance mode'
      };
      
      alert(statusMessages[newStatus] || 'Status updated');
      
      // Style the select based on status
      selectElement.style.background = getStatusColor(newStatus);
      selectElement.style.color = '#000';
      selectElement.style.fontWeight = '700';
    }
    
    function getStatusColor(status) {
      switch(status) {
        case 'Active': return 'rgba(0,160,120,0.15)';
        case 'Pending': return 'rgba(0,0,0,0.06)';
        case 'Inactive': return 'rgba(0,0,0,0.10)';
        case 'Maintenance': return 'rgba(255,152,0,0.15)';
        default: return '#fff';
      }
    }
  </script>

  <script src="../js/sidebar.js"></script>
</body>
</html>
